<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>อัปโหลดสลิปการชำระเงิน</title>
  <link rel="stylesheet" href="assets/bootstrap.min.css" />
  <script src="assets/sweetalert2.all.min.js"></script>
    <link rel="icon" href="favicon.ico" />
  <style>
    body { padding: 2rem; }
    .preview { max-height: 300px; margin-top: 1rem; }
    iframe.pdf-preview { width: 100%; height: 400px; border: 1px solid #ccc; margin-top: 1rem; }
  </style>
</head>
<body>
  <div class="container">
    <h3 class="mb-4">อัปโหลดสลิปการชำระเงิน</h3>

    <div id="feeBox" class="alert alert-info d-none">
      <strong>ยอดชำระ:</strong> <span id="feeAmount"></span> บาท
    </div>

    <form id="slipForm" enctype="multipart/form-data">
      <input type="hidden" name="registration_id" id="registration_id" />

      <div class="mb-3">
        <label for="ref_no" class="form-label">เลขที่อ้างอิง (Ref No.)</label>
        <input type="text" class="form-control" name="ref_no" id="ref_no" required>
      </div>

      <div class="mb-3">
        <label for="slip_file" class="form-label">แนบสลิป (.jpg, .png, .pdf)</label>
        <input type="file" class="form-control" name="slip_file" id="slip_file" accept="image/*,.pdf" required>
        <img id="imgPreview" class="preview d-none" />
        <iframe id="pdfPreview" class="pdf-preview d-none"></iframe>
      </div>

      <button type="submit" class="btn btn-success">อัปโหลดสลิป</button>
      <a href="student_registration_status.html" class="btn btn-secondary">กลับ</a>
    </form>
  </div>

  <script>
    const token = localStorage.getItem('studentToken');
    if (!token) window.location.href = 'student_login.html';

    const params = new URLSearchParams(window.location.search);
    const registrationId = params.get("registration_id");

    if (!registrationId) {
      Swal.fire("ไม่พบ ID การลงทะเบียน", "โปรดกลับไปเลือกจากหน้าสถานะ", "error")
        .then(() => window.location.href = 'student_registration_status.html');
    } else {
      document.getElementById("registration_id").value = registrationId;
      fetchFeeAmount(registrationId);
    }

    async function fetchFeeAmount(registrationId) {
      try {
        const res = await fetch(`api/get_registration_detail.php?id=${registrationId}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const data = await res.json();
        if (data.status === 'success' && data.registration) {
          const amount = parseFloat(data.registration.fee_amount).toFixed(2);
          document.getElementById("feeAmount").innerText = amount;
          document.getElementById("feeBox").classList.remove("d-none");
        }
      } catch (err) {
        console.warn("โหลดยอดชำระไม่สำเร็จ", err);
      }
    }

    document.getElementById("slip_file").addEventListener("change", function () {
      const file = this.files[0];
      const img = document.getElementById("imgPreview");
      const pdf = document.getElementById("pdfPreview");

      img.classList.add("d-none");
      pdf.classList.add("d-none");

      if (!file) return;

      const url = URL.createObjectURL(file);
      if (file.type.startsWith("image/")) {
        img.src = url;
        img.classList.remove("d-none");
      } else if (file.type === "application/pdf") {
        pdf.src = url;
        pdf.classList.remove("d-none");
      }
    });

    document.getElementById("slipForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const formData = new FormData(this);

      try {
        const res = await fetch("api/pay_registration.php", {
          method: "POST",
          headers: { Authorization: `Bearer ${token}` },
          body: formData
        });
        const result = await res.json();

        if (result.status === "success") {
          await Swal.fire("สำเร็จ", result.message, "success");
          window.location.href = "student_registration_status.html";
        } else {
          Swal.fire("ผิดพลาด", result.message || "อัปโหลดไม่สำเร็จ", "error");
        }
      } catch (err) {
        console.error("upload error", err);
        Swal.fire("เชื่อมต่อผิดพลาด", "ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์", "error");
      }
    });
  </script>
</body>
</html>
