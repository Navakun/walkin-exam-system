<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <title>เริ่มการสอบ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="favicon.ico" />

  <!-- Libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Page CSS (แยกไฟล์) -->
  <link rel="stylesheet" href="assets/css/exam.css">
</head>

<body>
  <div class="exam-wrap">
    <!-- Header -->
    <div class="exam-head">
      <h1 class="exam-title mb-0"><i class="fa-solid fa-pen-to-square me-2"></i>เริ่มการสอบ</h1>
      <div id="timer" class="timer-pill" aria-live="polite" title="เวลาที่เหลือ">
        <i class="fa-regular fa-clock"></i>
        <span id="timerText">--:--</span>
      </div>
    </div>

    <!-- Progress -->
    <div class="progress-card">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="small text-muted">
          ความคืบหน้า: <span id="progressLabel">0%</span> • <span id="qIndexLabel">ข้อที่ 0 / 0</span>
        </div>
      </div>
      <div class="progress" role="progressbar" aria-label="ความคืบหน้าการทำข้อสอบ" aria-valuemin="0"
        aria-valuemax="100">
        <div id="progressBar" class="progress-bar">0%</div>
      </div>
    </div>

    <!-- Question -->
    <div class="card question-card">
      <div class="card-header d-flex align-items-center justify-content-between">
        <div id="qHeaderLeft">ข้อที่ —</div>
        <div class="text-muted" id="qHeaderRight"></div>
      </div>
      <div class="card-body">
        <div id="questionContainer" class="question-text mb-2">—</div>
        <div id="choicesContainer" class="choices"></div>
      </div>
    </div>
  </div>

  <!-- Sticky submit -->
  <div class="submit-bar">
    <div class="submit-inner">
      <div class="flex-grow-1 d-none d-md-block kbd-hint">
        เลือกช้อยส์ด้วยปุ่มตัวเลข <kbd>1</kbd>…<kbd>9</kbd> ได้
      </div>
      <button id="submitAnswerBtn" class="btn btn-primary btn-lg" disabled>
        <i class="fa-solid fa-paper-plane me-1"></i> ยืนยันคำตอบ
      </button>
    </div>
  </div>

  <script>
    // ====== config ======
    const API_BASE = '/walkin-exam-system/api/';
    const API_SUBMIT = 'submit_answer.php';

    // --- state ---
    let TOTAL_QUESTIONS = null;
    let timeRemaining = 0;
    let currentQuestion = null;
    let questionsAnswered = 0;
    let timerInterval = null;
    let syncInterval = null;
    let sending = false;

    // ====== token + session ======
    const token = localStorage.getItem('studentToken');
    let sessionId = localStorage.getItem('exam_session_id') || localStorage.getItem('session_id');
    if (!sessionId && token) {
      const tmp = localStorage.getItem('exam_session_id');
      if (tmp) { sessionId = tmp; localStorage.setItem('session_id', tmp); }
    }
    if (!sessionId || !token) {
      Swal.fire({ icon: 'error', title: 'ไม่พบ session หรือ token', text: 'กรุณาเข้าสู่ระบบใหม่' })
        .then(() => location.href = 'student_dashboard.html');
      throw new Error('Missing session/token');
    }

    // ====== utils ======
    const $ = (s, r = document) => r.querySelector(s);
    const $$ = (s, r = document) => [...r.querySelectorAll(s)];
    const buildApiUrl = (p) => API_BASE + String(p || '').replace(/^\/+|^api\/+/g, '');

    function setSubmitEnabled(enabled) {
      const btn = $('#submitAnswerBtn');
      btn.disabled = !enabled;
    }

    // ====== API helper ======
    async function apiPost(path, payload) {
      const res = await fetch(buildApiUrl(path), {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify(payload || {})
      });
      const text = await res.text();
      let data;
      try { data = text ? JSON.parse(text) : null; }
      catch { throw new Error(text || `HTTP ${res.status}`); }
      if (!res.ok) throw new Error(data?.message || `HTTP ${res.status}`);
      return data;
    }

    // ====== timer ======
    function startTimer() {
      updateTimerDisplay();
      timerInterval = setInterval(() => {
        timeRemaining--;
        updateTimerDisplay();
        if (timeRemaining <= 0) {
          clearInterval(timerInterval);
          clearInterval(syncInterval);
          finishExam();
        }
      }, 1000);
    }
    function updateTimerDisplay() {
      const m = Math.floor(timeRemaining / 60);
      const s = timeRemaining % 60;
      const t = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
      $('#timerText').textContent = t;
      document.title = `(${t}) เริ่มการสอบ`; // สะดวกตอนสลับแท็บ
    }

    async function syncTiming() {
      try {
        const j = await apiPost('get_exam_timing.php', { session_id: Number(sessionId) });
        const left = Number(j.time_left_secs ?? j.time_remaining ?? 0);
        if (!isNaN(left) && left >= 0) timeRemaining = Math.min(timeRemaining, left);
      } catch { }
    }

    // ====== progress ======
    function updateProgressBar() {
      const total = TOTAL_QUESTIONS ?? 15;
      const percent = Math.min(100, Math.floor((questionsAnswered / Math.max(1, total)) * 100));
      const bar = $('#progressBar');
      bar.style.width = percent + '%';
      bar.textContent = percent + '%';
      $('#progressLabel').textContent = percent + '%';
      $('#qIndexLabel').textContent = `ข้อที่ ${Math.min(questionsAnswered + 1, total)} / ${total}`;
      $('#qHeaderLeft').textContent = `ข้อที่ ${Math.min(questionsAnswered + 1, total)}`;
      $('#qHeaderRight').textContent = total ? `ทั้งหมด ${total} ข้อ` : '';
    }

    // ====== flow ======
    (async function init() {
      window.addEventListener('beforeunload', (e) => {
        // เตือนถ้ายังทำข้อสอบอยู่
        if (timeRemaining > 0) { e.preventDefault(); e.returnValue = ''; }
      });

      // กดเลข 1-9 เพื่อเลือกช้อยส์
      window.addEventListener('keydown', (e) => {
        if (!currentQuestion) return;
        if (e.key >= '1' && e.key <= '9') {
          const idx = Number(e.key) - 1;
          const radios = $$('input[name="choice"]');
          if (radios[idx]) {
            radios[idx].checked = true;
            updateChoiceSelectedUI();
            setSubmitEnabled(true);
          }
        }
      });

      try {
        const j = await apiPost('get_exam_timing.php', { session_id: Number(sessionId) });
        const left = Number(j.time_left_secs ?? j.time_remaining ?? 0);
        if (left <= 0) {
          Swal.fire('หมดเวลา', 'หมดเวลาทำข้อสอบแล้ว', 'info').then(() => location.href = 'student_dashboard.html');
          return;
        }
        timeRemaining = left;
        if (j.total_questions != null) TOTAL_QUESTIONS = Number(j.total_questions) || TOTAL_QUESTIONS;
        startTimer();
        await loadNextQuestion();
        syncInterval = setInterval(syncTiming, 60000);
      } catch (e) {
        Swal.fire('ดึงเวลาไม่ได้', String(e.message || e), 'error');
      }
    })();

    async function loadNextQuestion() {
      try {
        const data = await apiPost(API_SUBMIT, {
          session_id: Number(sessionId),
          question_id: currentQuestion?.question_id || 0,
          selected_choice_id: null
        });

        if (data.total_questions != null) TOTAL_QUESTIONS = Number(data.total_questions) || TOTAL_QUESTIONS;
        if (data.answered_count != null) questionsAnswered = Number(data.answered_count) || questionsAnswered;

        updateProgressBar();

        if (data.status === 'finished') {
          finishExam(data.score);
        } else if (data.status === 'continue') {
          currentQuestion = data.question;
          displayQuestion();
        } else {
          throw new Error(data.message || 'เกิดข้อผิดพลาด');
        }
      } catch (err) {
        Swal.fire('เกิดข้อผิดพลาด', String(err.message || err), 'error');
      }
    }

    function displayQuestion() {
      setSubmitEnabled(false);

      $('#questionContainer').textContent = currentQuestion?.question_text || '—';

      const cc = $('#choicesContainer');
      cc.innerHTML = '';
      (currentQuestion?.choices || []).forEach((c, i) => {
        const id = `choice_${c.choice_id}_${i}`;
        const wrap = document.createElement('label');
        wrap.className = 'choice';
        wrap.setAttribute('for', id);
        wrap.innerHTML = `
          <input class="form-check-input mt-1" type="radio" name="choice" value="${c.choice_id}" id="${id}">
          <div class="flex-grow-1">${escapeHTML(c.choice_text || '')}</div>
        `;
        wrap.addEventListener('click', () => {
          setSubmitEnabled(true);
          updateChoiceSelectedUI();
        });
        cc.appendChild(wrap);
      });

      updateChoiceSelectedUI();
    }

    function updateChoiceSelectedUI() {
      const wraps = $$('.choice');
      const checked = $('input[name="choice"]:checked');
      wraps.forEach(w => w.classList.remove('selected'));
      if (checked) {
        const parent = checked.closest('.choice');
        if (parent) parent.classList.add('selected');
      }
    }

    function escapeHTML(s) {
      return String(s ?? '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
    }

    // ส่งคำตอบ
    $('#submitAnswerBtn').addEventListener('click', async () => {
      if (sending) return;
      const selected = document.querySelector('input[name="choice"]:checked');
      if (!selected) {
        Swal.fire('กรุณาเลือกคำตอบก่อนส่ง', '', 'warning');
        return;
      }
      try {
        sending = true;
        setSubmitEnabled(false);

        const data = await apiPost(API_SUBMIT, {
          session_id: Number(sessionId),
          question_id: currentQuestion.question_id,
          selected_choice_id: Number(selected.value)
        });

        if (data.total_questions != null) TOTAL_QUESTIONS = Number(data.total_questions) || TOTAL_QUESTIONS;
        if (data.answered_count != null) questionsAnswered = Number(data.answered_count);
        else questionsAnswered++;

        updateProgressBar();

        if (data.status === 'finished') {
          finishExam(data.score);
        } else if (data.status === 'continue') {
          currentQuestion = data.question;
          displayQuestion();
        } else {
          throw new Error(data.message || 'เกิดข้อผิดพลาด');
        }
      } catch (err) {
        Swal.fire('เกิดข้อผิดพลาด', String(err.message || err), 'error');
      } finally {
        sending = false;
        // ถ้ายังไม่มีการเลือกในข้อใหม่ ปล่อย disabled เอาไว้
      }
    });

    function finishExam(score = null) {
      clearInterval(timerInterval);
      clearInterval(syncInterval);
      Swal.fire({
        icon: 'success',
        title: 'การสอบเสร็จสิ้น',
        text: score !== null ? `คุณได้คะแนน ${score} คะแนน` : 'การสอบสิ้นสุดแล้ว',
        confirmButtonText: 'ดูผลสอบ'
      }).then(() => {
        location.href = `student_result.html?session_id=${encodeURIComponent(sessionId)}`;
      });
    }
  </script>

</body>

</html>