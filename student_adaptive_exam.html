<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <title>เริ่มการสอบ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="favicon.ico" />

  <!-- ใช้ CDN อย่างเดียว และไม่ใส่ defer เพื่อให้พร้อมก่อนสคริปต์ด้านล่าง -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body {
      padding: 20px;
    }

    .question-box {
      margin-bottom: 20px;
    }
  </style>
</head>

<body>
  <h3>เริ่มการสอบ</h3>

  <div id="timer" class="text-end text-danger fw-bold"></div>

  <div class="progress my-2">
    <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%">0%</div>
  </div>

  <div id="questionContainer" class="question-box border rounded p-3"></div>
  <div id="choicesContainer"></div>
  <button id="submitAnswerBtn" class="btn btn-primary mt-3">ส่งคำตอบ</button>

  <script>
    // ====== config ======
    const API_BASE = '/walkin-exam-system/api/'; // ปรับครั้งเดียวจบ

    // ====== token + session ======
    const token = localStorage.getItem('studentToken');
    let sessionId =
      localStorage.getItem('exam_session_id') ||
      localStorage.getItem('session_id'); // รองรับชื่อเก่า

    if (!sessionId && token) {
      const tmp = localStorage.getItem('exam_session_id');
      if (tmp) { sessionId = tmp; localStorage.setItem('session_id', tmp); }
    }

    if (!sessionId || !token) {
      Swal.fire({ icon: 'error', title: 'ไม่พบ session หรือ token', text: 'กรุณาเข้าสู่ระบบใหม่' })
        .then(() => location.href = 'student_dashboard.html');
      throw new Error('Missing session/token');
    }

    // ====== state ======
    let timeRemaining = 0;      // วินาที
    let currentQuestion = null;
    let questionsAnswered = 0;
    let timerInterval = null;
    let syncInterval = null;

    // ====== helper: POST JSON แบบปลอดภัย ======
    async function apiPost(path, payload) {
      const res = await fetch(API_BASE + path, {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify(payload)
      });
      const text = await res.text();
      let data;
      try { data = text ? JSON.parse(text) : null; }
      catch { throw new Error(text || `HTTP ${res.status}`); }

      if (!res.ok) throw new Error(data?.message || `HTTP ${res.status}`);
      return data;
    }

    // ====== init: ขอเวลาอนุญาตจากเซิร์ฟเวอร์ ======
    (async function init() {
      try {
        const j = await apiPost('get_exam_timing.php', { session_id: Number(sessionId) });

        // รองรับทั้งโครงสร้างเก่า/ใหม่
        const status = j.status;
        const left = Number(j.time_left_secs ?? j.time_remaining ?? 0);

        if (status === 'closed') {
          Swal.fire('สิ้นสุดการสอบ', 'รอบนี้ปิดไปแล้ว', 'info')
            .then(() => location.href = 'student_dashboard.html');
          return;
        }
        if (status === 'due') {
          Swal.fire('หมดเวลา', 'หมดเวลาทำข้อสอบแล้ว', 'info')
            .then(() => location.href = 'student_dashboard.html');
          return;
        }
        // 'open' หรือ 'success' ถือว่าเริ่มนับได้
        if (left <= 0) {
          Swal.fire('หมดเวลา', 'หมดเวลาทำข้อสอบแล้ว', 'info')
            .then(() => location.href = 'student_dashboard.html');
          return;
        }

        timeRemaining = left;
        startTimer();
        loadNextQuestion();

        // re-sync ทุก 60 วินาที กันนาฬิกาเพี้ยน
        syncInterval = setInterval(syncTiming, 60000);
      } catch (e) {
        Swal.fire('ดึงเวลาไม่ได้', String(e.message || e), 'error');
      }
    })();

    async function syncTiming() {
      try {
        const j = await apiPost('api/get_exam_timing.php', { session_id: Number(sessionId) });
        const left = Number(j.time_left_secs ?? j.time_remaining ?? 0);
        if (!isNaN(left) && left >= 0) {
          timeRemaining = Math.min(timeRemaining, left);
        }
      } catch { /* เงียบไว้ได้ */ }
    }

    // ====== timer ======
    function startTimer() {
      updateTimerDisplay();
      timerInterval = setInterval(() => {
        timeRemaining--;
        updateTimerDisplay();
        if (timeRemaining <= 0) {
          clearInterval(timerInterval);
          clearInterval(syncInterval);
          finishExam();
        }
      }, 1000);
    }
    function updateTimerDisplay() {
      const m = Math.floor(timeRemaining / 60);
      const s = timeRemaining % 60;
      document.getElementById('timer').textContent =
        `เวลาที่เหลือ: ${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }

    // ====== question flow ======
    const API_SUBMIT = 'api/submit_answer.php';

    async function loadNextQuestion() {
      try {
        const data = await apiPost(API_SUBMIT, {
          session_id: Number(sessionId),
          question_id: currentQuestion?.question_id || 0,
          selected_choice_id: null
        });

        if (data.status === 'finished') {
          finishExam(data.score);
        } else if (data.status === 'continue') {
          currentQuestion = data.question;
          displayQuestion();
        } else {
          throw new Error(data.message || 'เกิดข้อผิดพลาด');
        }
      } catch (err) {
        Swal.fire('เกิดข้อผิดพลาด', String(err.message || err), 'error');
      }
    }

    function displayQuestion() {
      const qc = document.getElementById('questionContainer');
      const cc = document.getElementById('choicesContainer');

      qc.innerHTML = `<strong>ข้อที่ ${questionsAnswered + 1}:</strong> ${currentQuestion.question_text}`;

      const html = (currentQuestion.choices || []).map((c, i) => `
        <div class="form-check">
          <input class="form-check-input" type="radio" name="choice" value="${c.choice_id}" id="c${i}">
          <label class="form-check-label" for="c${i}">${c.choice_text}</label>
        </div>
      `).join('');
      cc.innerHTML = html;
    }

    document.getElementById('submitAnswerBtn').addEventListener('click', async () => {
      const selected = document.querySelector('input[name="choice"]:checked');
      if (!selected) {
        Swal.fire('กรุณาเลือกคำตอบก่อนส่ง', '', 'warning');
        return;
      }
      try {
        const data = await apiPost('submit_answer_adaptive.php', {
          session_id: Number(sessionId),
          question_id: currentQuestion.question_id,
          selected_choice_id: selected.value
        });

        if (data.status === 'finished') {
          finishExam(data.score);
        } else if (data.status === 'continue') {
          questionsAnswered++;
          updateProgressBar();
          currentQuestion = data.question;
          displayQuestion();
        } else {
          throw new Error(data.message || 'เกิดข้อผิดพลาด');
        }
      } catch (err) {
        Swal.fire('เกิดข้อผิดพลาด', String(err.message || err), 'error');
      }
    });

    function updateProgressBar() {
      const percent = Math.min(100, Math.floor((questionsAnswered / 15) * 100)); // สมมติ 15 ข้อสูงสุด
      const bar = document.getElementById('progressBar');
      bar.style.width = `${percent}%`;
      bar.textContent = `${percent}%`;
    }

    function finishExam(score = null) {
      clearInterval(timerInterval);
      clearInterval(syncInterval);
      Swal.fire({
        icon: 'success',
        title: 'การสอบเสร็จสิ้น',
        text: score !== null ? `คุณได้คะแนน ${score} คะแนน` : 'การสอบสิ้นสุดแล้ว',
        confirmButtonText: 'ดูผลสอบ'
      }).then(() => {
        localStorage.removeItem('session_id');
        // เปลี่ยนปลายทางตามหน้าแสดงผลจริงของโปรเจ็กต์คุณ
        location.href = 'student_results.html';
      });
    }
  </script>
</body>

</html>