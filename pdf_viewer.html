<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PDF Viewer + อ่านออกเสียง</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" />
  <style>
    body { font-family: sans-serif; }
    .toolbar { padding: 10px; text-align: center; background: #eee; position: sticky; top: 0; z-index: 10; }
    .toolbar button, .toolbar select, .toolbar input[type="range"] { margin: 0 6px; }
    #canvasContainer { width: 100%; height: 75vh; overflow: auto; background: #ccc; }
    canvas { display: block; margin: 10px auto; border: 1px solid #000; }
    .highlight { background: yellow; }
  </style>
</head>
<body>
  <div class="toolbar">
    <button onclick="window.location.href='teacher_open_materials.html'">← กลับ</button>
    <button id="playBtn">▶ อ่าน</button>
    <button id="pauseBtn">⏸ หยุดชั่วคราว</button>
    <button id="stopBtn">⏹ หยุด</button>
    <label>ความเร็ว: <input id="rateSlider" type="range" min="0.5" max="2" step="0.1" value="1"> <span id="rateVal">1.0</span>x</label>
  </div>
  <div id="canvasContainer"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.worker.min.js';
    const query = new URLSearchParams(window.location.search);
    const filename = query.get('file');
    const pdfUrl = `uploads/materials/${filename}`;
    const container = document.getElementById('canvasContainer');
    let fullText = '';
    let utterance;
    let isSpeaking = false;

    const voices = speechSynthesis.getVoices();
    let thaiVoice = voices.find(v => v.lang === 'th-TH') || null;
    if (!thaiVoice) {
      speechSynthesis.onvoiceschanged = () => {
        thaiVoice = speechSynthesis.getVoices().find(v => v.lang === 'th-TH');
        if (!thaiVoice) {
          Swal.fire({
            icon: 'warning',
            title: 'ไม่พบเสียงภาษาไทย',
            text: 'กรุณาติดตั้งเสียงพูดภาษาไทยในระบบก่อนใช้งานฟีเจอร์นี้'
          });
        }
      }
    }

    async function loadPDF() {
      const pdf = await pdfjsLib.getDocument(pdfUrl).promise;
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const viewport = page.getViewport({ scale: 1.5 });
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        container.appendChild(canvas);
        await page.render({ canvasContext: ctx, viewport }).promise;

        const content = await page.getTextContent();
        const pageText = content.items.map(item => item.str).join(' ');
        fullText += pageText + '\n\n';
      }
    }

    async function speakPDF() {
      if (!fullText.trim()) {
        Swal.fire({ icon: 'info', title: 'ยังไม่มีข้อความ', text: 'กรุณารอสักครู่ ข้อมูล PDF กำลังโหลด' });
        return;
      }
      if (!thaiVoice) {
        Swal.fire({ icon: 'warning', title: 'ไม่พบเสียงภาษาไทย', text: 'กรุณาติดตั้งเสียงพูดภาษาไทยในระบบ' });
        return;
      }
      utterance = new SpeechSynthesisUtterance(fullText);
      utterance.voice = thaiVoice;
      utterance.lang = 'th-TH';
      utterance.rate = parseFloat(document.getElementById('rateSlider').value);
      utterance.onend = () => { isSpeaking = false; };
      speechSynthesis.speak(utterance);
      isSpeaking = true;
    }

    document.getElementById('playBtn').onclick = () => {
      if (!isSpeaking) speakPDF();
      else speechSynthesis.resume();
    };
    document.getElementById('pauseBtn').onclick = () => speechSynthesis.pause();
    document.getElementById('stopBtn').onclick = () => {
      speechSynthesis.cancel();
      isSpeaking = false;
    };
    document.getElementById('rateSlider').oninput = (e) => {
      document.getElementById('rateVal').textContent = e.target.value;
    }

    loadPDF();
  </script>
</body>
</html>
