<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF Viewer + ‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <style>
    #canvasContainer {
      position: relative;
      width: 100%;
      height: 80vh;
      overflow: auto;
      background: #ccc;
    }

    canvas {
      display: block;
      margin: 10px auto;
      border: 1px solid #000;
    }

    .toolbar {
      padding: 10px;
      text-align: center;
    }
  </style>
</head>

<body>
  <div class="toolbar">
    <button onclick="window.location.href='teacher_open_materials.html'">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
    <button id="speakBtn">üîä ‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</button>
  </div>
  <div id="canvasContainer"></div>

  <!-- PDF.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.min.js"></script>

  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.worker.min.js';

    const query = new URLSearchParams(window.location.search);
    const filename = query.get('file');
    if (!filename) {
      alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î');
      window.location.href = 'teacher_open_materials.html';
    }

    const pdfUrl = `uploads/materials/${filename}`;
    const container = document.getElementById('canvasContainer');
    let fullText = '';
    let thaiVoice = null;

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î PDF + ‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤
    (async () => {
      const loadingTask = pdfjsLib.getDocument(pdfUrl);
      const pdf = await loadingTask.promise;
      const totalPages = pdf.numPages;

      for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
        const page = await pdf.getPage(pageNum);
        const viewport = page.getViewport({ scale: 1.5 });
        const canvas = document.createElement('canvas');
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        container.appendChild(canvas);
        await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;

        const content = await page.getTextContent();
        const pageText = content.items.map(item => item.str).join(' ');
        fullText += pageText + '\n\n';
      }
    })();

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÑ‡∏´‡∏°
    function findThaiVoice() {
      const voices = speechSynthesis.getVoices();
      return voices.find(v => v.lang === 'th-TH' || v.lang.startsWith('th'));
    }

    // ‡∏£‡∏≠‡∏ü‡∏±‡∏á event ‡πÄ‡∏°‡∏∑‡πà‡∏≠ voices ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏ö
    speechSynthesis.onvoiceschanged = () => {
      thaiVoice = findThaiVoice();
    };

    // ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á
    document.getElementById('speakBtn').addEventListener('click', () => {
      if (!fullText) {
        return Swal.fire({
          icon: 'info',
          title: '‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
          text: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ PDF...',
        });
      }

      thaiVoice = findThaiVoice(); // check again
      if (!thaiVoice) {
        return Swal.fire({
          icon: 'warning',
          title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢',
          text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ',
        });
      }

      const utterance = new SpeechSynthesisUtterance(fullText);
      utterance.voice = thaiVoice;
      utterance.lang = 'th-TH';
      utterance.rate = 1;
      speechSynthesis.speak(utterance);
    });
  </script>
</body>

</html>