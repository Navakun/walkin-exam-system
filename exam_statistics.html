<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="utf-8" />
    <title>สถิติการสอบ (อาจารย์)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="favicon.ico" />

    <!-- CSS libs -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- Page style -->
    <link rel="stylesheet" href="assets/css/exam-stats.css">
    <style>
        /* เพิ่มเติมเล็กน้อยให้ตารางและการ์ดอ่านง่าย */
        .card-kpi .num {
            font-weight: 700;
            font-size: 22px
        }

        .chart-card {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 16px
        }

        .chart-box {
            width: 100%;
            height: 320px
        }

        .table-wrap {
            max-height: 520px;
            overflow: auto
        }

        .table-sticky thead th {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            z-index: 2
        }

        .table-zebra tbody tr:nth-child(odd) {
            background: rgba(0, 0, 0, .015)
        }

        .low-pct {
            background: rgba(239, 68, 68, .06) !important
        }

        .mid-pct {
            background: rgba(245, 158, 11, .06) !important
        }

        .high-pct {
            background: rgba(34, 197, 94, .06) !important
        }

        .msg-error {
            display: none
        }

        .hscroll {
            overflow-x: auto;
            padding-bottom: 6px;
        }

        .hscroll canvas {
            display: block
        }

        /* กล่องสกรอลล์แนวนอนเท่านั้น */
        .hscroll {
            overflow-x: auto;
            overflow-y: hidden;
            /* สำคัญ: กันยืดลง */
            padding-bottom: 6px;
        }

        /* กล่องชั้นใน: ล็อกความสูงกราฟ */
        .hscroll-inner {
            height: 360px;
            /* ปรับได้ตามต้องการ */
            position: relative;
            /* ให้ Chart.js วัดขนาดได้ถูก */
        }

        /* กัน style เดิมที่อาจบังคับความสูง canvas */
        #perQuestionChart {
            height: 100% !important;
            /* สูงเท่ากับ .hscroll-inner */
            width: auto;
            /* ความกว้างคุมด้วย JS */
            display: block;
        }
    </style>
</head>

<body>
    <div class="shell">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="side-brand">
                <img src="nulogo.png" alt="NU">
                <div>
                    <p class="side-title">ระบบจัดสอบ Walk-in</p>
                    <div class="side-sub">(สำหรับอาจารย์)</div>
                </div>
            </div>

            <button class="me-chip" id="editProfileBtn" title="แก้ไขโปรไฟล์">
                <i class="fa-solid fa-user-circle"></i>
                <span id="teacherName">อาจารย์ผู้สอน</span>
            </button>

            <button class="logout" data-logout>
                <i class="fa-solid fa-right-from-bracket"></i> ออกจากระบบ
            </button>

            <nav class="nav">
                <div class="group">เมนูหลัก</div>
                <a href="teacher_dashboard.html"><i class="fa-solid fa-house"></i> หน้าหลัก</a>

                <div class="group">การจัดการข้อสอบ</div>
                <a href="teacher_question_bank.html"><i class="fa-solid fa-file-invoice"></i> คลังข้อสอบ</a>

                <div class="group">การจัดการสอบ</div>
                <a href="teacher_exam_out.html"><i class="fa-solid fa-calendar-alt"></i> ช่วงเวลาการสอบ</a>
                <a href="exam_users.html"><i class="fa-solid fa-users"></i> รายชื่อผู้เข้าสอบ</a>
                <a href="exam_registration_status.html"><i class="fa-solid fa-clipboard-check"></i>
                    ตรวจสอบสถานะนิสิต</a>
                <a href="exam_statistics.html" class="active"><i class="fa-solid fa-chart-bar"></i> สถิติการสอบ</a>

                <div class="group">เนื้อหารายวิชา</div>
                <a href="teaching_materials.html"><i class="fa-solid fa-file-arrow-up"></i> อัปโหลดสื่อการสอน</a>
                <a href="teacher_open_materials.html"><i class="fa-solid fa-book-open-reader"></i> ดูสื่อการสอน</a>
            </nav>
        </aside>

        <div class="page-wrap">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <h2 class="h5 mb-0">สถิติการสอบ</h2>
                <div class="d-flex gap-2">
                    <button id="backBtn" class="btn btn-outline-secondary btn-sm d-inline-flex align-items-center gap-1"
                        title="กลับไปแดชบอร์ดอาจารย์" aria-label="กลับไปแดชบอร์ดอาจารย์">
                        <i class="fa-solid fa-arrow-left-long" aria-hidden="true"></i>
                        <span>กลับหน้าหลัก</span>
                    </button>
                    <!-- ใช้ data-logout เพื่อหลีกเลี่ยง id ชนกัน -->
                    <button class="btn btn-danger btn-sm" data-logout>ออกจากระบบ</button>
                </div>
            </div>

            <div id="errorBox" class="alert alert-danger msg-error" role="alert"></div>

            <!-- Filters + KPIs -->
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="examsetSelect" class="form-label">ชุดข้อสอบ (Examset)</label>
                    <select id="examsetSelect" class="form-select" aria-label="เลือกชุดข้อสอบ" title="เลือกชุดข้อสอบ">
                        <option value="">— ทั้งหมด —</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label for="fromDate" class="form-label">ตั้งแต่ (From)</label>
                    <input id="fromDate" type="date" class="form-control" placeholder="ตั้งแต่"
                        aria-label="ตั้งแต่วันที่" title="ตั้งแต่วันที่">
                </div>

                <div class="col-md-3">
                    <label for="toDate" class="form-label">ถึง (To)</label>
                    <input id="toDate" type="date" class="form-control" placeholder="ถึง" aria-label="ถึงวันที่"
                        title="ถึงวันที่">
                </div>

                <div class="col-md-2 d-grid">
                    <button id="showBtn" class="btn btn-primary" aria-label="แสดงสถิติ">แสดงสถิติ</button>
                </div>
            </div>

            <div class="row g-2 my-3">
                <div class="col-md-3">
                    <div class="card card-kpi p-3">
                        <div class="text-muted">จำนวน Sessions</div>
                        <div id="kpiSessions" class="num">—</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-kpi p-3">
                        <div class="text-muted">จำนวนข้อในชุด</div>
                        <div id="kpiQuestions" class="num">—</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-kpi p-3">
                        <div class="text-muted">ค่าเฉลี่ยข้อที่ถูก</div>
                        <div id="kpiAvgCorrect" class="num">—</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-kpi p-3">
                        <div class="text-muted">คะแนนเฉลี่ย (%)</div>
                        <div id="kpiAvgScore" class="num">—</div>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="row g-3">
                <div class="chart-card">
                    <h5 class="h6 mb-3">จำนวน “ถูก” ต่อข้อ</h5>
                    <div class="hscroll">
                        <div class="hscroll-inner">
                            <canvas id="perQuestionChart" role="img" aria-label="กราฟจำนวนตอบถูกต่อข้อ"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="chart-card">
                        <h5 class="h6 mb-3">จำนวนคนตามจำนวนข้อที่ทำถูก</h5>
                        <div class="hscroll"> </div>
                        <div class="hscroll-inner">
                            <canvas id="histChart" class="chart-box" role="img"
                                aria-label="ฮิสโตแกรมจำนวนนักศึกษาตามจำนวนข้อที่ทำถูก"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Question statistics panel -->
        <section class="panel mt-3">
            <div class="panel-head d-flex justify-content-between align-items-center">
                <h3 class="panel-title mb-0">สถิติรายข้อ</h3>
                <div class="panel-head-actions">
                    <button id="qExport" class="btn btn-sm btn-outline-secondary btn-icon"
                        aria-label="ส่งออกสถิติรายข้อเป็นไฟล์ CSV">
                        <i class="fa-solid fa-file-export" aria-hidden="true"></i><span> Export CSV</span>
                    </button>
                </div>
            </div>

            <div class="panel-controls d-flex gap-3 flex-wrap mt-2">
                <div class="control-item">
                    <label for="qSearch" class="form-label">ค้นหาเลขข้อ / คำถาม</label>
                    <input id="qSearch" class="form-control form-control-sm" placeholder="เช่น 12 หรือคำสำคัญของคำถาม"
                        aria-label="ค้นหาเลขข้อหรือข้อความคำถาม" title="ค้นหาข้อหรือคำถาม">
                </div>

                <div class="control-item">
                    <label for="qSort" class="form-label">การเรียงข้อมูล</label>
                    <select id="qSort" class="form-select form-select-sm q-sort" aria-label="วิธีการเรียงตารางรายข้อ"
                        title="วิธีการเรียงตารางรายข้อ">
                        <option value="id_asc">เรียงตามเลขข้อ (น้อย→มาก)</option>
                        <option value="id_desc">เรียงตามเลขข้อ (มาก→น้อย)</option>
                        <option value="pct_desc">% ถูก (มาก→น้อย)</option>
                        <option value="pct_asc">% ถูก (น้อย→มาก)</option>
                        <option value="wrong_desc">จำนวนผิด (มาก→น้อย)</option>
                        <option value="wrong_asc">จำนวนผิด (น้อย→มาก)</option>
                    </select>
                </div>
            </div>

            <div class="panel-body">
                <div class="table-responsive table-wrap">
                    <table class="table table-sm table-hover align-middle table-sticky table-zebra" id="qTable">
                        <thead class="table-light">
                            <tr>
                                <th class="q-col-id">ข้อ</th>
                                <th>คำถาม (ย่อ)</th>
                                <th class="text-end">ทำทั้งหมด (คน)</th>
                                <th class="text-end text-success">ถูก (คน)</th>
                                <th class="text-end text-danger">ผิด (คน)</th>
                                <th class="text-end">% ถูก</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="panel-foot d-flex justify-content-between align-items-center">
                <small id="qInfo" class="text-muted"></small>
                <div class="btn-group btn-group-sm">
                    <button id="qPrev" class="btn btn-outline-secondary" type="button">
                        <i class="fa-solid fa-chevron-left"></i> ก่อนหน้า
                    </button>
                    <button id="qNext" class="btn btn-outline-secondary" type="button">
                        ถัดไป <i class="fa-solid fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </section>
    </div>
    </div>

    <script>
        // ---------- Helpers ----------
        const $ = (sel, root = document) => root.querySelector(sel);
        const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
        const fmtPct = n => (isFinite(n) ? (Math.round(n * 1000) / 10).toFixed(1) : '0.0');
        const escapeHTML = s => String(s ?? '').replace(/[&<>"']/g, m =>
            ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m])
        );

        const ROOT = location.pathname.includes('/walkin-exam-system/') ? '/walkin-exam-system' : '';
        const API = `${ROOT}/api`;

        const TOK = (() =>
            localStorage.getItem('teacherToken') ||
            localStorage.getItem('instructorToken') ||
            sessionStorage.getItem('teacherToken') ||
            sessionStorage.getItem('instructorToken') ||
            ''
        )();

        if (!TOK) { alert('กรุณาเข้าสู่ระบบ'); location.href = 'teacher_login.html'; }

        // ชื่อบนชิป
        (function () {
            const name = localStorage.getItem('instructor_name') || '';
            if (name) $('#teacherName').textContent = name;
        })();

        // ออกจากระบบได้ทุกปุ่มที่มี data-logout
        document.querySelectorAll('[data-logout]').forEach(btn => {
            btn.addEventListener('click', () => {
                try { localStorage.clear(); sessionStorage.clear(); } catch { }
                location.href = 'teacher_login.html';
            });
        });

        // smartBack → กลับได้ก็กลับ, ไม่ได้ให้ไป dashboard
        function smartBack() {
            const fallback = 'teacher_dashboard.html';
            const ref = document.referrer || '';
            try {
                const same = ref && new URL(ref, location.href).origin === location.origin;
                if (history.length > 1 && same) {
                    history.back();
                    setTimeout(() => { if (!document.hidden) location.href = fallback; }, 350);
                    return;
                }
            } catch { }
            location.href = fallback;
        }
        $('#backBtn').addEventListener('click', smartBack);
        window.addEventListener('keydown', (e) => {
            if ((e.key === 'b' || e.key === 'B') && e.altKey && !e.ctrlKey && !e.metaKey) {
                e.preventDefault(); smartBack();
            }
        });

        // ---------- Charts ----------
        let perQuestionChart, histChart;
        const kill = inst => { try { inst?.destroy(); } catch { } };

        function drawPerQuestionChart(rows) {
            const labels = (rows || []).map(r => 'ข้อ ' + (r.question_id ?? r.id));
            const corrects = (rows || []).map(r => Number(r.corrects ?? 0));
            const attempts = (rows || []).map(r => Number(r.attempts ?? 0));

            // คำนวณความกว้างตามจำนวนข้อ แล้วคุมเฉพาะ "width"
            const canvas = document.getElementById('perQuestionChart');
            const pxPerBar = 28;                 // ปรับความถี่แท่ง
            const w = Math.max(800, labels.length * pxPerBar);
            canvas.style.width = w + 'px';       // ให้เลื่อนได้ทาง .hscroll
            // ห้ามเซ็ต canvas.height / style.height ตรงนี้

            perQuestionChart?.destroy();
            perQuestionChart = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: 'ถูก (คน)', data: corrects, order: 1, maxBarThickness: 22 },
                        { label: 'ทำทั้งหมด (คน)', data: attempts, order: 2, maxBarThickness: 22 }
                    ]
                },
                options: {
                    responsive: true,            // ให้ Chart.js ปรับตาม container
                    maintainAspectRatio: false,  // ความสูงยึด .hscroll-inner 360px
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                title: (items) => items?.[0]?.label || '',
                                afterTitle: (items) => {
                                    const i = items[0].dataIndex;
                                    const a = attempts[i] || 0, c = corrects[i] || 0;
                                    const pct = a ? (c / a * 100).toFixed(1) : '0.0';
                                    return `ถูก ${c}/${a} (${pct}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                autoSkip: false,
                                maxRotation: 0,
                                callback: (v) => String(labels[v]).replace('ข้อ ', '')
                            },
                            grid: { display: false }
                        },
                        y: { beginAtZero: true, ticks: { precision: 0 } }
                    }
                }
            });
        }

        function drawHistogram(rows) {
            const labels = (rows || []).map(r => Number(r.corrects ?? r.score ?? 0));
            const students = (rows || []).map(r => Number(r.students ?? r.count ?? 0));

            kill(histChart);
            histChart = new Chart($('#histChart'), {
                type: 'bar',
                data: { labels, datasets: [{ label: 'จำนวนนักศึกษาที่ทำถูก n ข้อ', data: students }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { title: { display: true, text: 'จำนวนข้อที่ทำถูก' } },
                        y: { beginAtZero: true, title: { display: true, text: 'จำนวนคน' }, ticks: { precision: 0 } }
                    }
                }
            });
        }

        // ---------- Data fetch ----------
        let _ctrl = null;

        async function fetchStats() {
            const ex = $('#examsetSelect').value;
            const f = $('#fromDate').value;
            const t = $('#toDate').value;

            const params = new URLSearchParams();
            if (ex) params.set('examset_id', ex);
            if (f) params.set('from', f);
            if (t) params.set('to', t);

            const url = `${API}/get_exam_statistics.php` + (params.toString() ? ('?' + params.toString()) : '');

            // cancel request เก่าถ้ายังไม่จบ
            try { _ctrl?.abort(); } catch { }
            _ctrl = new AbortController();

            const res = await fetch(url, {
                headers: { 'Authorization': 'Bearer ' + TOK, 'Accept': 'application/json' },
                cache: 'no-store',
                signal: _ctrl.signal
            });

            const raw = await res.text();
            let data; try { data = JSON.parse(raw); } catch {
                throw new Error(raw.replace(/<[^>]*>/g, '').trim() || `HTTP ${res.status}`);
            }
            if (!res.ok || data.status !== 'success') {
                throw new Error(data?.message || `HTTP ${res.status}`);
            }
            return data.data;
        }

        function fillExamsetOptions(arr) {
            const sel = $('#examsetSelect');
            const keep = sel.value;
            sel.innerHTML = '<option value="">— ทั้งหมด —</option>';
            (arr || []).forEach(item => {
                const id = item?.id ?? item;
                const name = item?.name ?? ('ชุด ' + id);
                const opt = document.createElement('option');
                opt.value = String(id);
                opt.textContent = String(name);
                sel.appendChild(opt);
            });
            if (keep) sel.value = keep;
        }

        function renderKPI(t) {
            $('#kpiSessions').textContent = t.sessions ?? '0';
            $('#kpiQuestions').textContent = t.total_questions ?? '0';
            $('#kpiAvgCorrect').textContent = (t.avg_correct ?? 0).toString();
            const avgPct = (t.avg_score_percent != null)
                ? Number(t.avg_score_percent).toFixed(2)
                : '0.00';
            $('#kpiAvgScore').textContent = `${avgPct}%`;
        }

        // ---------- ตารางรายข้อ ----------
        let Q_ALL = [], Q_FILTERED = [], Q_PAGE = 1;
        const Q_PER_PAGE = 20;

        function renderQuestionTable(perQuestionRaw) {
            Q_ALL = (perQuestionRaw || []).map(row => {
                const id = Number(row.question_id ?? row.id ?? 0);
                const attempts = Number(row.attempts ?? 0);
                const corrects = Number(row.corrects ?? 0);
                const wrongs = Math.max(0, attempts - corrects);
                const pct = attempts > 0 ? (corrects / attempts) : 0;
                const text = String(row.question_text || row.title || '').trim();
                return { id, attempts, corrects, wrongs, pct, text };
            });

            $('#qSort').value = 'id_asc';
            Q_PAGE = 1;
            applyQFilters();
        }

        function applyQFilters() {
            const kw = $('#qSearch').value.trim().toLowerCase();

            Q_FILTERED = Q_ALL.filter(q => {
                if (!kw) return true;
                return String(q.id).includes(kw) || (q.text && q.text.toLowerCase().includes(kw));
            });

            const sort = $('#qSort').value;
            const cmp = {
                'id_asc': (a, b) => a.id - b.id,
                'id_desc': (a, b) => b.id - a.id,
                'pct_desc': (a, b) => b.pct - a.pct || a.id - b.id,
                'pct_asc': (a, b) => a.pct - b.pct || a.id - b.id,
                'wrong_desc': (a, b) => b.wrongs - a.wrongs || a.id - b.id,
                'wrong_asc': (a, b) => a.wrongs - b.wrongs || a.id - b.id,
            }[sort] || ((a, b) => a.id - b.id);

            Q_FILTERED.sort(cmp);

            Q_PAGE = clamp(Q_PAGE, 1, Math.max(1, Math.ceil(Q_FILTERED.length / Q_PER_PAGE)));
            paintQTable();
        }

        function paintQTable() {
            const tbody = $('#qTable tbody');
            tbody.innerHTML = '';

            const total = Q_FILTERED.length;
            const pages = Math.max(1, Math.ceil(total / Q_PER_PAGE));
            const start = (Q_PAGE - 1) * Q_PER_PAGE;
            const slice = Q_FILTERED.slice(start, start + Q_PER_PAGE);

            slice.forEach(q => {
                const tr = document.createElement('tr');
                const pct100 = q.pct * 100;
                if (pct100 < 30) tr.classList.add('low-pct');
                else if (pct100 < 60) tr.classList.add('mid-pct');
                else tr.classList.add('high-pct');

                tr.innerHTML = `
          <td class="fw-semibold">ข้อ ${q.id}</td>
          <td>${escapeHTML(q.text || '—')}</td>
          <td class="text-end">${q.attempts}</td>
          <td class="text-end text-success">${q.corrects}</td>
          <td class="text-end text-danger">${q.wrongs}</td>
          <td class="text-end">${fmtPct(q.pct)}%</td>
        `;
                tbody.appendChild(tr);
            });

            $('#qInfo').textContent = `แสดง ${start + 1}-${start + slice.length} จากทั้งหมด ${total} ข้อ • หน้า ${Q_PAGE}/${pages}`;
            $('#qPrev').disabled = (Q_PAGE <= 1);
            $('#qNext').disabled = (Q_PAGE >= pages);
        }

        function exportQCSV() {
            const rows = [
                ['question_id', 'question_text', 'attempts', 'corrects', 'wrongs', 'correct_percent'],
                ...Q_FILTERED.map(q => [q.id, q.text || '', q.attempts, q.corrects, q.wrongs, (q.pct * 100).toFixed(2)])
            ];
            const csv = rows.map(r => r.map(cell => {
                const s = String(cell ?? '');
                return /[",\n]/.test(s) ? `"${s.replace(/"/g, '""')}"` : s;
            }).join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `question_stats_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(a); a.click(); a.remove();
            URL.revokeObjectURL(url);
        }

        // ---------- Events ----------
        $('#qSearch').addEventListener('input', () => { Q_PAGE = 1; applyQFilters(); });
        $('#qSort').addEventListener('change', () => { Q_PAGE = 1; applyQFilters(); });
        $('#qPrev').addEventListener('click', () => { Q_PAGE = Math.max(1, Q_PAGE - 1); paintQTable(); });
        $('#qNext').addEventListener('click', () => { Q_PAGE += 1; paintQTable(); });
        $('#qExport').addEventListener('click', exportQCSV);
        $('#showBtn').addEventListener('click', run);

        // ---------- Boot ----------
        async function run() {
            const err = $('#errorBox');
            err.style.display = 'none'; err.textContent = '';

            try {
                const stats = await fetchStats();
                if (!stats) return;

                fillExamsetOptions(stats.examsets || []);
                renderKPI(stats.totals || {});
                drawPerQuestionChart(stats.per_question || []);
                drawHistogram(stats.histogram || []);
                renderQuestionTable(stats.per_question || []);
            } catch (e) {
                err.textContent = e?.message || 'โหลดสถิติไม่สำเร็จ';
                err.style.display = 'block';
            }
        }

        // set default วันที่เป็น 30 วันล่าสุด
        (function initDefaultDates() {
            const to = new Date();
            const from = new Date(); from.setDate(to.getDate() - 29);
            const pad = n => String(n).padStart(2, '0');
            $('#toDate').value = `${to.getFullYear()}-${pad(to.getMonth() + 1)}-${pad(to.getDate())}`;
            $('#fromDate').value = `${from.getFullYear()}-${pad(from.getMonth() + 1)}-${pad(from.getDate())}`;
        })();

        run();
    </script>
</body>

</html>