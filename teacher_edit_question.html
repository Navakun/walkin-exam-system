<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>แก้ไขคำถาม</title>
  <link rel="icon" href="data:,">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- สไตล์เดิมของโปรเจกต์ -->
  <link rel="stylesheet" href="assets/css/main.css">
  <link rel="stylesheet" href="assets/css/teacher.css">
  <link rel="stylesheet" href="assets/css/teacher-edit-question.css">

  <!-- SweetAlert2 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

  <!-- ปรับโทน SweetAlert2 ให้เข้า UI -->
  <style>
    .swal2-popup {
      border-radius: 16px !important;
      padding: 1.25rem 1.2rem !important;
      font-family: "Inter", "Noto Sans Thai", system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", "Noto Sans", sans-serif;
      box-shadow: 0 18px 44px rgba(17, 24, 39, .18);
    }

    .swal2-title {
      font-weight: 700 !important;
    }

    .swal2-styled.swal2-confirm {
      background: #2563eb !important;
      border-radius: 12px !important;
      padding: .6rem 1rem !important;
      font-weight: 700 !important;
      box-shadow: 0 8px 18px rgba(37, 99, 235, .25);
    }

    .swal2-styled.swal2-cancel {
      background: #e5e7eb !important;
      color: #111827 !important;
      border-radius: 12px !important;
      padding: .6rem 1rem !important;
      font-weight: 600 !important;
    }

    /* Toast มุมขวาล่าง */
    .swal2-container.swal2-bottom-end>.swal2-popup {
      border-radius: 12px;
      backdrop-filter: saturate(1.2) blur(2px);
      background: #0b1220ee;
      color: #fff;
      box-shadow: 0 10px 26px rgba(0, 0, 0, .35);
    }
  </style>
</head>

<body>
  <header>
    <div class="logo-text">
      <img src="nulogo.png" alt="Logo" height="60">
      <div class="course-title">
        <h2>แก้ไขคำถาม</h2>
      </div>
    </div>
    <div class="top-right">
      <button id="backBtn" class="home-btn">คลังข้อสอบ</button>
      <button id="logoutBtn" class="logout-btn">ออกจากระบบ</button>
    </div>
  </header>

  <div class="container">
    <h2>แก้ไขคำถาม</h2>
    <form id="editQuestionForm">
      <label for="question_text">คำถาม:</label>
      <textarea id="question_text" required></textarea>

      <label for="choiceA">ตัวเลือก A:</label>
      <input type="text" id="choiceA" required>

      <label for="choiceB">ตัวเลือก B:</label>
      <input type="text" id="choiceB" required>

      <label for="choiceC">ตัวเลือก C:</label>
      <input type="text" id="choiceC" required>

      <label for="choiceD">ตัวเลือก D:</label>
      <input type="text" id="choiceD" required>

      <label for="correct_choice">คำตอบที่ถูกต้อง:</label>
      <select id="correct_choice" required>
        <option value="A">A</option>
        <option value="B">B</option>
        <option value="C">C</option>
        <option value="D">D</option>
      </select>

      <label for="difficulty">ระดับความยาก:</label>
      <select id="difficulty" required>
        <option value="easy">ง่าย</option>
        <option value="medium">ปานกลาง</option>
        <option value="hard">ยาก</option>
      </select>

      <!-- ปุ่ม sticky -->
      <button type="submit" class="submit-btn sticky-save">บันทึกการแก้ไข</button>
    </form>
  </div>

  <!-- โหลด SweetAlert2 ก่อน -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- โค้ดของหน้า -->
  <script>
    (function init() {
      if (!window.Swal) { console.error('SweetAlert2 ไม่ได้โหลด'); return; }

      // ---------- SweetAlert helpers ----------
      const Toast = Swal.mixin({
        toast: true,
        position: 'bottom-end',
        showConfirmButton: false,
        timer: 2200,
        timerProgressBar: true,
      });

      const showError = (msg) =>
        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: msg, confirmButtonText: 'ตกลง' });

      const showWarn = (title, text, goto) =>
        Swal.fire({ icon: 'warning', title, text, confirmButtonText: 'ไปต่อ' })
          .then(() => { if (goto) location.href = goto; });

      const showLoading = (title = 'กำลังโหลด...') => {
        Swal.fire({
          title, allowOutsideClick: false, allowEscapeKey: false, didOpen: () => Swal.showLoading()
        });
      };
      const closeLoading = () => Swal.close();

      // ---------- Page logic ----------
      const editId = new URLSearchParams(location.search).get('edit');
      if (!editId) { showError('ไม่พบ ID ของคำถาม').then(() => location.href = 'teacher_question_bank.html'); }

      const token = localStorage.getItem('teacherToken');
      if (!token) { showWarn('ยังไม่ได้เข้าสู่ระบบ', 'กรุณาเข้าสู่ระบบสำหรับอาจารย์ก่อน', 'teacher_login.html'); }
      const authHeader = { 'Authorization': 'Bearer ' + token };

      // Load question
      (async () => {
        try {
          showLoading('กำลังโหลดคำถาม...');
          const res = await fetch(`api/get_single_question.php?question_id=${encodeURIComponent(editId)}`, { headers: authHeader });
          if (res.status === 401) return showWarn('เซสชันหมดอายุ', 'กรุณาเข้าสู่ระบบใหม่', 'teacher_login.html');
          const data = await res.json();
          closeLoading();

          if (data.status === 'success' && data.data) {
            const q = data.data;
            document.getElementById('question_text').value = q.question_text || '';
            document.getElementById('choiceA').value = q.choices?.A ?? '';
            document.getElementById('choiceB').value = q.choices?.B ?? '';
            document.getElementById('choiceC').value = q.choices?.C ?? '';
            document.getElementById('choiceD').value = q.choices?.D ?? '';
            document.getElementById('correct_choice').value = q.correct_choice || 'A';

            let diff = parseFloat(q.difficulty);
            if (Number.isFinite(diff)) {
              if (Math.abs(diff - 0.15) < 0.01) document.getElementById('difficulty').value = 'easy';
              else if (Math.abs(diff - 0.85) < 0.01) document.getElementById('difficulty').value = 'hard';
              else document.getElementById('difficulty').value = 'medium';
            } else {
              document.getElementById('difficulty').value = 'medium';
            }
          } else {
            showError('โหลดคำถามไม่สำเร็จ');
          }
        } catch (err) {
          closeLoading();
          console.error(err);
          showError('เกิดข้อผิดพลาดในการโหลดคำถาม');
        }
      })();

      // Submit update
      const saveBtn = document.querySelector('.submit-btn');
      document.getElementById('editQuestionForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        // ยืนยันก่อนบันทึก (กันคลิกพลาด)
        const ok = await Swal.fire({
          icon: 'question',
          title: 'ยืนยันการบันทึก?',
          text: 'ระบบจะอัปเดตคำถามและตัวเลือกตามที่แก้ไข',
          showCancelButton: true,
          confirmButtonText: 'บันทึกเลย',
          cancelButtonText: 'ยกเลิก'
        });
        if (!ok.isConfirmed) return;

        // loading state + modal โหลด
        const originalText = saveBtn.textContent;
        saveBtn.disabled = true; saveBtn.classList.add('is-loading');
        saveBtn.textContent = 'กำลังบันทึก...';
        showLoading('กำลังบันทึก...');

        // map label -> float
        const mapLabelToFloat = (label) => label === 'easy' ? 0.15 : (label === 'hard' ? 0.85 : 0.5);
        const diffVal = mapLabelToFloat(document.getElementById('difficulty').value);

        const payload = {
          question_id: editId,
          question_text: document.getElementById('question_text').value.trim(),
          choices: {
            A: document.getElementById('choiceA').value.trim(),
            B: document.getElementById('choiceB').value.trim(),
            C: document.getElementById('choiceC').value.trim(),
            D: document.getElementById('choiceD').value.trim(),
          },
          correct_choice: document.getElementById('correct_choice').value,
          difficulty: diffVal
        };

        try {
          const res = await fetch('api/update_question.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...authHeader },
            body: JSON.stringify(payload),
            credentials: 'same-origin'
          });

          closeLoading();

          if (res.status === 401) {
            return showWarn('เซสชันหมดอายุ', 'กรุณาเข้าสู่ระบบใหม่', 'teacher_login.html');
          }

          const result = await res.json();
          if (result.status === 'success') {
            Toast.fire({ icon: 'success', title: 'บันทึกการแก้ไขเรียบร้อย' });
            setTimeout(() => location.href = 'teacher_question_bank.html', 1200);
          } else {
            showError(result.message || 'อัปเดตไม่สำเร็จ');
          }
        } catch (err) {
          closeLoading();
          console.error(err);
          showError('เชื่อมต่อเซิร์ฟเวอร์ไม่สำเร็จ');
        } finally {
          saveBtn.classList.remove('is-loading');
          saveBtn.disabled = false;
          saveBtn.textContent = originalText;
        }
      });

      // Nav buttons
      document.getElementById('backBtn').onclick = () => (location.href = 'teacher_question_bank.html');
      document.getElementById('logoutBtn').onclick = () => {
        Swal.fire({
          icon: 'warning',
          title: 'ออกจากระบบ?',
          text: 'ต้องการออกจากระบบตอนนี้หรือไม่',
          showCancelButton: true,
          confirmButtonText: 'ออกจากระบบ',
          cancelButtonText: 'ยกเลิก'
        }).then(r => {
          if (r.isConfirmed) {
            localStorage.removeItem('teacherToken');
            location.href = 'teacher_login.html';
          }
        });
      };
    })();
  </script>

  <!-- โค้ดของหน้า -->
  <script>
    (function init() {
      if (!window.Swal) { console.error('SweetAlert2 ไม่ได้โหลด'); return; }

      // ใช้งาน SweetAlert2 ได้แล้ว
      const Toast = Swal.mixin({
        toast: true,
        position: 'bottom-end',
        showConfirmButton: false,
        timer: 2200,
        timerProgressBar: true,
      });

      const showError = (msg) =>
        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: msg, confirmButtonText: 'ตกลง' });

      const showWarn = (title, text, goto) =>
        Swal.fire({ icon: 'warning', title, text, confirmButtonText: 'ไปต่อ' })
          .then(() => { if (goto) location.href = goto; });

      const showLoading = (title = 'กำลังโหลด...') => {
        Swal.fire({
          title, allowOutsideClick: false, allowEscapeKey: false, didOpen: () => Swal.showLoading()
        });
      };
      const closeLoading = () => Swal.close();

      // ---------- Page logic ----------
      const editId = new URLSearchParams(location.search).get('edit');
      if (!editId) { showError('ไม่พบ ID ของคำถาม').then(() => location.href = 'teacher_question_bank.html'); }

      const token = localStorage.getItem('teacherToken');
      if (!token) { showWarn('ยังไม่ได้เข้าสู่ระบบ', 'กรุณาเข้าสู่ระบบสำหรับอาจารย์ก่อน', 'teacher_login.html'); }
      const authHeader = { 'Authorization': 'Bearer ' + token };

      // Load question
      (async () => {
        try {
          showLoading('กำลังโหลดคำถาม...');
          const res = await fetch(`api/get_single_question.php?question_id=${encodeURIComponent(editId)}`, { headers: authHeader });
          if (res.status === 401) return showWarn('เซสชันหมดอายุ', 'กรุณาเข้าสู่ระบบใหม่', 'teacher_login.html');
          const data = await res.json();
          closeLoading();

          if (data.status === 'success' && data.data) {
            const q = data.data;
            document.getElementById('question_text').value = q.question_text || '';
            document.getElementById('choiceA').value = q.choices?.A ?? '';
            document.getElementById('choiceB').value = q.choices?.B ?? '';
            document.getElementById('choiceC').value = q.choices?.C ?? '';
            document.getElementById('choiceD').value = q.choices?.D ?? '';
            document.getElementById('correct_choice').value = q.correct_choice || 'A';

            let diff = parseFloat(q.difficulty);
            if (Number.isFinite(diff)) {
              if (Math.abs(diff - 0.15) < 0.01) document.getElementById('difficulty').value = 'easy';
              else if (Math.abs(diff - 0.85) < 0.01) document.getElementById('difficulty').value = 'hard';
              else document.getElementById('difficulty').value = 'medium';
            } else {
              document.getElementById('difficulty').value = 'medium';
            }
          } else {
            showError('โหลดคำถามไม่สำเร็จ');
          }
        } catch (err) {
          closeLoading();
          console.error(err);
          showError('เกิดข้อผิดพลาดในการโหลดคำถาม');
        }
      })();

      // Submit update
      const saveBtn = document.querySelector('.submit-btn');
      document.getElementById('editQuestionForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        // ยืนยันก่อนบันทึก (กันคลิกพลาด)
        const ok = await Swal.fire({
          icon: 'question',
          title: 'ยืนยันการบันทึก?',
          text: 'ระบบจะอัปเดตคำถามและตัวเลือกตามที่แก้ไข',
          showCancelButton: true,
          confirmButtonText: 'บันทึกเลย',
          cancelButtonText: 'ยกเลิก'
        });
        if (!ok.isConfirmed) return;

        // loading state + modal โหลด
        const originalText = saveBtn.textContent;
        saveBtn.disabled = true; saveBtn.classList.add('is-loading');
        saveBtn.textContent = 'กำลังบันทึก...';
        showLoading('กำลังบันทึก...');

        // map label -> float
        const mapLabelToFloat = (label) => label === 'easy' ? 0.15 : (label === 'hard' ? 0.85 : 0.5);
        const diffVal = mapLabelToFloat(document.getElementById('difficulty').value);

        const payload = {
          question_id: editId,
          question_text: document.getElementById('question_text').value.trim(),
          choices: {
            A: document.getElementById('choiceA').value.trim(),
            B: document.getElementById('choiceB').value.trim(),
            C: document.getElementById('choiceC').value.trim(),
            D: document.getElementById('choiceD').value.trim(),
          },
          correct_choice: document.getElementById('correct_choice').value,
          difficulty: diffVal
        };

        try {
          const res = await fetch('api/update_question.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...authHeader },
            body: JSON.stringify(payload),
            credentials: 'same-origin'
          });

          closeLoading();

          if (res.status === 401) {
            return showWarn('เซสชันหมดอายุ', 'กรุณาเข้าสู่ระบบใหม่', 'teacher_login.html');
          }

          const result = await res.json();
          if (result.status === 'success') {
            Toast.fire({ icon: 'success', title: 'บันทึกการแก้ไขเรียบร้อย' });
            setTimeout(() => location.href = 'teacher_question_bank.html', 1200);
          } else {
            showError(result.message || 'อัปเดตไม่สำเร็จ');
          }
        } catch (err) {
          closeLoading();
          console.error(err);
          showError('เชื่อมต่อเซิร์ฟเวอร์ไม่สำเร็จ');
        } finally {
          saveBtn.classList.remove('is-loading');
          saveBtn.disabled = false;
          saveBtn.textContent = originalText;
        }
      });

      // Nav buttons
      document.getElementById('backBtn').onclick = () => (location.href = 'teacher_question_bank.html');
      document.getElementById('logoutBtn').onclick = () => {
        Swal.fire({
          icon: 'warning',
          title: 'ออกจากระบบ?',
          text: 'ต้องการออกจากระบบตอนนี้หรือไม่',
          showCancelButton: true,
          confirmButtonText: 'ออกจากระบบ',
          cancelButtonText: 'ยกเลิก'
        }).then(r => {
          if (r.isConfirmed) {
            localStorage.removeItem('teacherToken');
            location.href = 'teacher_login.html';
          }
        });
      };
    })();
  </script>
</body>

</html>