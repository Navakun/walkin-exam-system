<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏ô‡∏¥‡∏™‡∏¥‡∏ï</title>

  <!-- Google Fonts: Prompt (preconnect ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ß‡πÅ‡∏•‡∏∞‡∏Å‡∏±‡∏ô CORS) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Font Awesome (‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏û‡∏≠) -->
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css" rel="stylesheet">

  <!-- CSS ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤ (‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏•‡∏±‡∏á‡∏™‡∏∏‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠ override Bootstrap/‡∏Ñ‡πà‡∏≤‡∏î‡∏µ‡∏ü‡∏≠‡∏•‡∏ï‡πå) -->
  <link rel="stylesheet" href="assets/css/student-dashboard.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- SweetAlert2 via CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
  <!-- Chart.js via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- ‡πÅ‡∏≠‡∏õ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤ -->
  <link rel="stylesheet" href="assets/css/student-dashboard.css">
  <link rel="icon" href="favicon.ico">


</head>

<body>
  <header>
    <div class="logo-text">
      <img src="nulogo.png" alt="Logo" height="60">
      <div class="course-title">
        <h2>‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ 273252 ‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®<br>‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏ô‡πÄ‡∏£‡∏®‡∏ß‡∏£</h2>
      </div>
    </div>
    <div class="top-right">
      <span id="studentName"></span>
      <button id="logoutBtn" class="logout-btn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
  </header>

  <main class="dashboard" id="main" role="main">
    <section class="welcome-banner" aria-labelledby="homeHeading">
      <h2 id="homeHeading"><i class="fas fa-graduation-cap" aria-hidden="true"></i> ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</h2>
      <p class="welcome-text">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</p>
    </section>

    <nav class="card-list" aria-label="‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å">
      <!-- ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≠‡∏ö -->
      <a href="student_register_exam.html" class="card card--home center-right">
        <div class="card-icon"><i class="fas fa-calendar-alt" aria-hidden="true"></i></div>
        <div class="card-content">
          <h3>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏™‡∏≠‡∏ö</h3>
          <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</p>
        </div>
        <div class="card-arrow"><i class="fas fa-chevron-right" aria-hidden="true"></i></div>
      </a>

      <!-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô & ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô -->
      <a href="student_registration_status.html" class="card card--home center-right">
        <div class="card-icon"><i class="fas fa-list-check" aria-hidden="true"></i></div>
        <div class="card-content">
          <h3>‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô & ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
          <p>‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</p>
        </div>
        <div class="card-arrow"><i class="fas fa-chevron-right" aria-hidden="true"></i></div>
      </a>

      <!-- ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö -->
      <button id="startExamBtn" type="button" class="card card--home center-right" onclick="handleStartExam(event)"
        disabled aria-disabled="true" aria-label="‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö">
        <div class="card-icon"><i class="fas fa-edit" aria-hidden="true"></i></div>
        <div class="card-content">
          <h3>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö</h3>
          <p>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≠‡∏ö</p>
        </div>
        <div class="card-arrow"><i class="fas fa-chevron-right" aria-hidden="true"></i></div>
      </button>

      <!-- ‡∏ú‡∏•‡∏™‡∏≠‡∏ö -->
      <a href="student_results.html" class="card card--home center-right" id="viewResultBtn" aria-disabled="true"
        tabindex="-1">
        <div class="card-icon"><i class="fas fa-poll" aria-hidden="true"></i></div>
        <div class="card-content">
          <h3>‡∏î‡∏π‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3>
          <p>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
        </div>
        <div class="card-arrow"><i class="fas fa-chevron-right" aria-hidden="true"></i></div>
      </a>
    </nav>
  </main>


  <footer class="dashboard-footer">
    <small>&copy; 2025 ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå ‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏ô‡πÄ‡∏£‡∏®‡∏ß‡∏£</small>
  </footer>

  <!-- Modal ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö -->
  <div class="logout-confirm-modal" id="logoutModal">
    <div class="logout-modal-content">
      <h3><i class="fas fa-sign-out-alt"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</h3>
      <p>‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
      <div class="logout-modal-buttons">
        <button class="modal-btn cancel" id="cancelLogout">
          <i class="fas fa-times"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
        </button>
        <button class="modal-btn confirm" id="confirmLogout">
          <i class="fas fa-check"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
        </button>
      </div>
    </div>
  </div>

  <script>
    // ==================
    // JWT Decode
    // ==================
    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
          '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
        ).join(''));
        return JSON.parse(jsonPayload);
      } catch {
        return null;
      }
    }

    // ==================
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö token ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠
    // ==================
    const token = localStorage.getItem('studentToken');
    if (!token) {
      window.location.href = 'student_login.html';
    } else {
      const payload = parseJwt(token);
      if (payload?.name) {
        const displayName = payload.student_id
          ? `${payload.student_id} ${payload.name}`
          : payload.name;
        document.getElementById('studentName').innerText = displayName;
      }
    }

    function handleTokenExpired() {
      Swal.fire({
        icon: 'warning',
        title: '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô',
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
        confirmButtonColor: '#3085d6'
      }).then(() => {
        localStorage.clear();
        window.location.href = 'student_login.html';
      });
    }

    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ã‡πâ‡∏≥
    let isStarting = false;

    // ==================
    // ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö (‡∏≠‡πà‡∏≤‡∏ô slot_id ‡∏à‡∏≤‡∏Å localStorage)
    // ==================

    async function handleStartExam(e) {
      if (e) e.preventDefault();
      if (isStarting) return;
      isStarting = true;

      const token = localStorage.getItem('studentToken');
      const slotId = Number(localStorage.getItem('slot_id'));
      const booking = localStorage.getItem('booking_id') || '';

      if (!token) { isStarting = false; return handleTokenExpired(); }
      if (!slotId) {
        isStarting = false;
        return Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≠‡∏ö‡∏™‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (slot_id ‡∏ß‡πà‡∏≤‡∏á)', 'error');
      }

      const btn = e?.currentTarget;
      const oldHTML = btn?.innerHTML;
      if (btn) btn.disabled = true;

      Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö...', allowOutsideClick: false, showConfirmButton: false, didOpen: () => Swal.showLoading() });

      try {
        const res = await fetch('/walkin-exam-system/api/start_exam.php', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          credentials: 'include',                   // üëà ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å headers
          body: JSON.stringify({ slot_id: slotId }) // üëà ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å headers
        });

        if (res.status === 401) {
          Swal.close(); isStarting = false; if (btn) btn.disabled = false;
          return handleTokenExpired();
        }

        const raw = await res.text();
        let data = null; try { data = raw ? JSON.parse(raw) : null; } catch { }

        if (!res.ok) {
          // ‡∏ñ‡πâ‡∏≤ API ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏≠‡∏ö
          if (data?.status === 'not_started') {
            Swal.fire('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏≠‡∏ö', `‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏ß‡∏•‡∏≤ ${data.exam_start_at}`, 'warning');
            return;
          }
          const msg = data?.message || raw || `HTTP ${res.status}`;
          throw new Error(msg);
        }

        if (!data || data.status !== 'success') {
          throw new Error(data?.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ');
        }

        // success
        localStorage.setItem('exam_session_id', String(data.session_id));
        localStorage.setItem('slot_id', String(slotId));
        if (booking) localStorage.setItem('latestRegistrationId', booking);

        Swal.close();
        window.location.href = 'student_exam.html';
      } catch (err) {
        Swal.fire('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', String(err.message || err), 'error');
      } finally {
        isStarting = false;
        if (btn) btn.disabled = false;
        if (btn && oldHTML != null) btn.innerHTML = oldHTML;
      }
    }



    // ==================
    // ‡πÇ‡∏´‡∏•‡∏î booking ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏∏‡∏°‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö"
    // ==================
    (() => {
      const startBtn = document.getElementById('startExamBtn');
      const sr = document.getElementById('srStatus'); // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ live region

      const setEnabled = (on) => {
        if (!startBtn) return;
        startBtn.disabled = !on;
        startBtn.setAttribute('aria-disabled', on ? 'false' : 'true');
        if (sr) sr.textContent = on ? '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≠‡∏ö‡∏™‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î';
      };

      let fetching = false; // ‡∏Å‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ä‡∏ô‡∏Å‡∏±‡∏ô

      document.addEventListener('DOMContentLoaded', loadLatestBooking);
      window.addEventListener('focus', loadLatestBooking);

      async function loadLatestBooking() {
        if (fetching) return;
        fetching = true;

        const token = localStorage.getItem('studentToken');
        if (!token) {
          window.location.href = 'student_login.html';
          fetching = false;
          return;
        }

        const ctrl = new AbortController();
        const timer = setTimeout(() => ctrl.abort(), 8000);

        try {
          const res = await fetch('/walkin-exam-system/api/get_latest_booking.php', {
            headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/json' },
            cache: 'no-store',
            signal: ctrl.signal
          });

          // token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏/‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
          if (res.status === 401 || res.status === 403) {
            localStorage.removeItem('studentToken');
            window.location.href = 'student_login.html';
            return;
          }

          // parse JSON ‡πÅ‡∏ö‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
          let data;
          const ct = res.headers.get('content-type') || '';
          if (ct.includes('application/json')) {
            data = await res.json();
          } else {
            const text = await res.text();
            try { data = JSON.parse(text); } catch { data = { status: 'error', message: text }; }
          }

          if (res.ok && data.status === 'success' && data.booking_id && data.slot_id) {
            localStorage.setItem('booking_id', String(data.booking_id));
            localStorage.setItem('slot_id', String(data.slot_id));
            setEnabled(true);
          } else {
            localStorage.removeItem('booking_id');
            localStorage.removeItem('slot_id');
            setEnabled(false);
            console.warn('No latest booking:', data?.message ?? `HTTP ${res.status}`);
          }
        } catch (err) {
          console.error('Error loading latest booking:', err);
          setEnabled(false);
        } finally {
          clearTimeout(timer);
          fetching = false;
        }
      }
    })();

    // ==================
    // ‡∏î‡∏π‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
    // ==================
    document.getElementById('viewResultBtn').addEventListener('click', e => {
      e.preventDefault();
      const session_id = localStorage.getItem('session_id');
      if (session_id) {
        window.location.href = 'student_view_result.html';
      } else {
        Swal.fire({
          icon: 'warning',
          title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö',
          text: '‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏î‡πâ',
          confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
          confirmButtonColor: '#3085d6'
        });
      }
    });

    // ==================
    // Logout
    // ==================
    document.getElementById('logoutBtn').addEventListener('click', () => {
      document.getElementById('logoutModal').style.display = 'flex';
    });
    document.getElementById('cancelLogout').addEventListener('click', () => {
      document.getElementById('logoutModal').style.display = 'none';
    });
    document.getElementById('confirmLogout').addEventListener('click', () => {
      localStorage.clear();
      window.location.href = 'student_login.html';
    });
  </script>

</body>

</html>