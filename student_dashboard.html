<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>หน้าหลัก</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/main.css">
  <link rel="stylesheet" href="assets/css/student.css">
  <link rel="stylesheet" href="assets/css/student-dashboard.css">
  <link rel="icon" href="favicon.ico">
  <!-- SweetAlert2 -->
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</head>

<body>
  <header>
    <div class="logo-text">
      <img src="nulogo.png" alt="Logo" height="60">
      <div class="course-title">
        <h2>รายวิชา 273252 กฎหมายเทคโนโลยีสารสนเทศ<br>มหาวิทยาลัยนเรศวร</h2>
      </div>
    </div>
    <div class="top-right">
      <span id="studentName"></span>
      <button id="logoutBtn" class="logout-btn">ออกจากระบบ</button>
    </div>
  </header>

  <main class="dashboard">
    <div class="welcome-banner">
      <h2><i class="fas fa-graduation-cap"></i>หน้าหลัก</h2>
      <p class="welcome-text">ยินดีต้อนรับสู่ระบบจัดการการสอบออนไลน์</p>
    </div>

    <div class="card-list">
      <a href="student_register_exam.html" class="card">
        <div class="card-icon">
          <i class="fas fa-calendar-alt"></i>
        </div>
        <div class="card-content">
          <h3>ลงทะเบียนวันสอบ</h3>
          <p>เลือกช่วงเวลาสอบที่ต้องการ</p>
        </div>
        <div class="card-arrow">
          <i class="fas fa-chevron-right"></i>
        </div>
      </a>

      <a href="student_registration_status.html" class="card">
        <div class="card-icon">
          <i class="fas fa-list-check"></i>
        </div>
        <div class="card-content">
          <h3>สถานะการลงทะเบียน</h3>
          <p>ดูข้อมูลการลงทะเบียนสอบของคุณ</p>
        </div>
        <div class="card-arrow">
          <i class="fas fa-chevron-right"></i>
        </div>
      </a>

      <a href="student_exam.html" class="card" onclick="handleStartExam(event)">
        <div class="card-icon">
          <i class="fas fa-edit"></i>
        </div>
        <div class="card-content">
          <h3>เข้าสอบ</h3>
          <p>เข้าสู่ระบบการสอบเมื่อถึงเวลา</p>
        </div>
        <div class="card-arrow">
          <i class="fas fa-chevron-right"></i>
        </div>
      </a>

      <a href="#" class="card" id="viewResultBtn">
        <div class="card-icon">
          <i class="fas fa-poll"></i>
        </div>
        <div class="card-content">
          <h3>ดูผลคะแนน</h3>
          <p>ตรวจสอบผลคะแนนสอบของคุณ</p>
        </div>
        <div class="card-arrow">
          <i class="fas fa-chevron-right"></i>
        </div>
      </a>

      <script>
        document.addEventListener('DOMContentLoaded', function () {
          document.getElementById('viewResultBtn').addEventListener('click', function (e) {
            e.preventDefault();
            const session_id = localStorage.getItem('session_id');
            if (session_id) {
              window.location.href = 'student_view_result.html';
            } else {
              Swal.fire({
                icon: 'warning',
                title: 'ไม่พบข้อมูลการสอบ',
                text: 'คุณยังไม่มีข้อมูลการสอบที่สามารถดูผลคะแนนได้',
                confirmButtonText: 'ตกลง',
                confirmButtonColor: '#3085d6',
                customClass: {
                  popup: 'rounded-4 shadow-lg'
                }
              });
            }
          });
        });
      </script>
    </div>
  </main>

  <footer class="dashboard-footer">
    <p>© 2025 ระบบจัดการการสอบออนไลน์ มหาวิทยาลัยนเรศวร</p>
  </footer>

  <!-- Logout Confirmation Modal -->
  <div class="logout-confirm-modal" id="logoutModal">
    <div class="logout-modal-content">
      <h3><i class="fas fa-sign-out-alt"></i>ยืนยันการออกจากระบบ</h3>
      <p>คุณต้องการออกจากระบบหรือไม่?</p>
      <div class="logout-modal-buttons">
        <button class="modal-btn cancel" id="cancelLogout">
          <i class="fas fa-times"></i>ยกเลิก
        </button>
        <button class="modal-btn confirm" id="confirmLogout">
          <i class="fas fa-check"></i>ยืนยัน
        </button>
      </div>
    </div>
  </div>

  <script>
    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));

        return JSON.parse(jsonPayload);
      } catch (e) {
        return null;
      }
    }

    const token = localStorage.getItem('studentToken');
    if (!token) {
      window.location.href = 'student_login.html';
    } else {
      const payload = parseJwt(token);
      if (payload && payload.name) {
        let displayName = payload.name;
        if (payload.student_id) {
          displayName = `${payload.student_id} ${payload.name}`;
        }
        document.getElementById('studentName').innerText = displayName;
      }
    }

    async function handleStartExam(e) {
      if (e) e.preventDefault();

      const token = localStorage.getItem('studentToken');
      const examset_id = localStorage.getItem('examset_id');
      const booking_id = localStorage.getItem('booking_id');

      // ตรวจสอบข้อมูลที่จำเป็น
      if (!token || !examset_id) {
        Swal.fire({
          icon: 'warning',
          title: 'ยังไม่ได้ลงทะเบียนสอบ',
          text: 'กรุณาลงทะเบียนก่อนเข้าสอบ',
          confirmButtonText: 'ตกลง',
          confirmButtonColor: '#3085d6'
        });
        return;
      }

      try {
        // แสดง loading
        Swal.fire({
          title: 'กำลังเตรียมข้อสอบ...',
          allowOutsideClick: false,
          showConfirmButton: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });

        // ดึง student_id จาก token
        const payload = parseJwt(token);
        if (!payload?.student_id) {
          throw new Error('ข้อมูลผู้ใช้ไม่ถูกต้อง กรุณาเข้าสู่ระบบใหม่');
        }

        // เรียก API start_exam.php
        const response = await fetch('api/start_exam.php', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            student_id: payload.student_id,
            examset_id: parseInt(examset_id)
          })
        });

        const result = await response.json();
        console.log('Start exam response:', result);

        if (response.ok && result.status === 'success') {
          // บันทึกข้อมูล session
          localStorage.setItem('session_id', result.session_id);
          
          // ไปที่หน้าสอบ
          window.location.href = 'student_exam.html';
        } else {
          throw new Error(result.message || 'ไม่สามารถเริ่มการสอบได้');
        }

      } catch (error) {
        console.error('Error starting exam:', error);
        Swal.fire({
          icon: 'error',
          title: 'เกิดข้อผิดพลาด',
          text: error.message,
          confirmButtonText: 'ตกลง',
          confirmButtonColor: '#3085d6'
        });
      }
    }
    document.getElementById('logoutBtn').addEventListener('click', () => {
      document.getElementById('logoutModal').style.display = 'flex';
    });

    document.getElementById('cancelLogout').addEventListener('click', () => {
      document.getElementById('logoutModal').style.display = 'none';
    });

    document.getElementById('confirmLogout').addEventListener('click', () => {
      localStorage.clear();
      window.location.href = 'student_login.html';
    });
  </script>
</body>

</html>