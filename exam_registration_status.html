<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สถานะการลงทะเบียนสอบ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/student.css">
    <link rel="stylesheet" href="assets/css/student-status.css">
    <link rel="icon" href="favicon.ico">
    <style>   
    </style>
</head>
<body>
    <header>
        <div class="logo-text">
            <img src="nulogo.png" alt="Logo" height="60">
            <div class="course-title">
                <h2>รายวิชา 273252 กฎหมายเทคโนโลยีสารสนเทศ<br>มหาวิทยาลัยนเรศวร</h2>
            </div>
        </div>
        <div class="top-right">
            <button id="backBtn" class="home-btn">กลับหน้าหลัก</button>
            <button id="logoutBtn" class="logout-btn">ออกจากระบบ</button>
        </div>
    </header>

    <div class="container">
        <div class="d-flex align-items-center mb-3">
            <i class="fas fa-2x text-primary me-2"></i>
            <h2 class="mb-1">สถานะการลงทะเบียนสอบ</h2>
        </div>
        <div id="errorAlert" class="alert alert-danger hidden" role="alert" style="display: none;"></div>

        <!-- ส่วนค้นหา -->
        <div class="search-section">
            <div class="search-filters">
                <input type="text" id="searchInput" placeholder="ค้นหาด้วยรหัสนิสิต หรือ ชื่อ-นามสกุล" class="form-control">
                <label for="searchDate" class="form-label visually-hidden">ค้นหาด้วยวันที่สอบ</label>
                <input type="date" id="searchDate" class="form-control" placeholder="เลือกวันที่สอบ" title="ค้นหาด้วยวันที่สอบ">
                <button onclick="searchRegistrations()" class="btn btn-primary">
                    <i class="fas fa-search"></i> ค้นหา
                </button>
                <button onclick="resetSearch()" class="btn btn-secondary">
                    <i class="fas fa-redo"></i> ล้างการค้นหา
                </button>
            </div>
        </div>

        <!-- ตารางแสดงสถานะ -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>รหัสนิสิต</th>
                        <th>ชื่อ-นามสกุล</th>
                        <th>วันที่สอบ</th>
                        <th>เวลา</th>
                        <th>หัวข้อสอบ</th>
                        <th>สถานะ</th>
                        <!-- <th>การดำเนินการ</th> -->
                    </tr>
                </thead>
                <tbody id="registrationTable">
                    <!-- ข้อมูลจะถูกเพิ่มด้วย JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // เช็คการล็อกอิน
        document.addEventListener('DOMContentLoaded', async function() {
            const token = localStorage.getItem('teacherToken');
            if (!token) {
                window.location.href = 'teacher_login.html';
                return;
            }

            // ตรวจสอบ token ว่ายังใช้งานได้
            try {
                const response = await fetch('/api/verify_token.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Token ไม่ถูกต้องหรือหมดอายุ');
                }

                // เพิ่มปุ่มกลับหน้าหลัก
                addBackButton();
                await loadRegistrations();

            } catch (error) {
                console.error('Token verification failed:', error);
                showError('Session หมดอายุ กรุณาเข้าสู่ระบบใหม่');
                setTimeout(() => {
                    localStorage.removeItem('teacherToken');
                    window.location.href = 'teacher_login.html';
                }, 2000);
            }
        });

        // เพิ่มปุ่มกลับหน้าหลัก
        function addBackButton() {
            const header = document.querySelector('.top-right');
            
            // สร้างปุ่มกลับหน้าหลัก
            const backBtn = document.createElement('a');
            backBtn.href = 'teacher_dashboard.html';
            backBtn.className = 'home-btn me-2';
            backBtn.innerHTML = '<i class="fas fa-home"></i> หน้าแผงควบคุม';
        }

        document.getElementById('backBtn').addEventListener('click', () => {
        window.location.href = 'teacher_dashboard.html';
        });

        // แสดงข้อผิดพลาด
        function showError(message) {
            const errorAlert = document.getElementById('errorAlert');
            errorAlert.textContent = message;
            errorAlert.style.display = 'block';
            // ซ่อนข้อความผิดพลาดหลังจาก 5 วินาที
            setTimeout(() => {
                errorAlert.style.display = 'none';
            }, 5000);
        }

        // โหลดข้อมูลการลงทะเบียน
        async function loadRegistrations() {
            try {
                const token = localStorage.getItem('teacherToken');
                if (!token) {
                    showError('ไม่พบ Token กรุณาเข้าสู่ระบบใหม่');
                    window.location.href = 'teacher_login.html';
                    return;
                }

                console.log('Loading registrations with token:', token); // Debug log

                const response = await fetch('/api/get_registration_status.php', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    if (response.status === 401) {
                        showError('Session หมดอายุ กรุณาเข้าสู่ระบบใหม่');
                        localStorage.removeItem('teacherToken');
                        setTimeout(() => {
                            window.location.href = 'teacher_login.html';
                        }, 2000);
                        return;
                    }
                    throw new Error(errorData.message || 'ไม่สามารถโหลดข้อมูลได้');
                }

                const data = await response.json();
                console.log('API Response:', data); // Debug log

                if (data.status === 'error') {
                    throw new Error(data.message);
                }
                if (data.status === 'error') {
                    throw new Error(data.message);
                }

                displayRegistrations(data.registrations);
            } catch (error) {
                console.error('Error:', error);
                showError('ไม่สามารถโหลดข้อมูลได้: ' + error.message);
            }
        }

                // Helper to format date as dd/mm/yy
                function formatDate(dateStr) {
                        const d = new Date(dateStr);
                        if (isNaN(d)) return dateStr;
                        const day = String(d.getDate()).padStart(2, '0');
                        const month = String(d.getMonth() + 1).padStart(2, '0');
                        const year = String(d.getFullYear()).slice();
                        return `${day}/${month}/${year}`;
                }
                // Helper to format time as HH:MM (no seconds)
                function formatTime(timeStr) {
                        if (!timeStr) return '';
                        return timeStr.split(':').slice(0,2).join(':');
                }

                        // 1) สรุปสถานะจากเรกคอร์ด 1 แถว
                        function computeStatus(reg) {
                            return Number(reg.has_completed) === 1 ? 'completed' : 'registered';
                        }

                        // 2) แปลงเป็นข้อความที่ต้องการแสดง (โชว์ attempt)
                        function statusText(reg) {
                            if (Number(reg.has_completed) === 1) {
                                return reg.last_attempt ? `สอบแล้ว (ครั้งที่ ${reg.last_attempt})` : 'สอบแล้ว';
                            }
                            return reg.next_attempt ? `ลงทะเบียนแล้ว (จะเป็นครั้งที่ ${reg.next_attempt})` : 'ลงทะเบียนแล้ว';
                        }

                        // 3) เรนเดอร์ตาราง
                        function displayRegistrations(registrations) {
                            const tbody = document.getElementById('registrationTable');
                            tbody.innerHTML = '';

                            if (!registrations || registrations.length === 0) {
                                tbody.innerHTML = `<tr><td colspan="6" class="text-center">ไม่มีข้อมูลการลงทะเบียนสอบ</td></tr>`;
                                return;
                            }

                            // ---- เรียงคนที่ "ลงทะเบียนล่าสุด" ก่อน ----
                        const getRegTime = (r) =>
                            (r.registered_at || r.created_at || r.booking_time || r.booked_at || r.updated_at || '').replace(' ', 'T');

                        registrations.sort((a, b) => {
                            const tb = new Date(getRegTime(b)), ta = new Date(getRegTime(a));
                            if (!isNaN(tb) && !isNaN(ta)) return tb - ta; // ล่าสุดก่อน
                            // fallback: ถ้าไม่มีเวลาลงทะเบียน ให้เดาจาก id หรือวันสอบ
                            const idB = Number(b.booking_id || b.session_id || 0);
                            const idA = Number(a.booking_id || a.session_id || 0);
                            if (idB !== idA) return idB - idA;
                            const kB = new Date(`${b.exam_date} ${b.exam_time || '00:00'}`);
                            const kA = new Date(`${a.exam_date} ${a.exam_time || '00:00'}`);
                            return kB - kA;
                        });
                        // ---------------------------------------------

                            const rowsHtml = registrations.map(reg => {
                                const status = computeStatus(reg);
                                const text = statusText(reg);
                                const cls = `status-badge ${status}`;
                                return `
                                    <tr>
                                        <td>${reg.student_id}</td>
                                        <td>${reg.student_name}</td>
                                        <td>${formatDate(reg.exam_date)}</td>
                                        <td>${formatTime(reg.exam_time)}</td>
                                        <td>${reg.exam_title}</td>
                                        <td><span class="${cls}">${text}</span></td>
                                    </tr>`;
                            }).join('');

                            tbody.innerHTML = rowsHtml;
                        }

        // ค้นหาการลงทะเบียน
        function searchRegistrations() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const searchDate = document.getElementById('searchDate').value;
            const rows = document.getElementById('registrationTable').getElementsByTagName('tr');

            Array.from(rows).forEach(row => {
                const studentId = row.cells[0].textContent.toLowerCase();
                const studentName = row.cells[1].textContent.toLowerCase();
                const examDate = row.cells[2].textContent; // วันที่สอบในรูปแบบ dd/mm/yyyy
                
                // แปลงวันที่จาก dd/mm/yyyy เป็น yyyy-mm-dd เพื่อเปรียบเทียบ
                const [day, month, year] = examDate.split('/');
                const formattedExamDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;

                // เช็คเงื่อนไขการค้นหา
                const matchText = studentId.includes(searchText) || studentName.includes(searchText);
                const matchDate = !searchDate || formattedExamDate === searchDate;
                
                const visible = matchText && matchDate;
                row.style.display = visible ? '' : 'none';
            });
        }

        // รีเซ็ตการค้นหา
        function resetSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('searchDate').value = '';
            const rows = document.getElementById('registrationTable').getElementsByTagName('tr');
            Array.from(rows).forEach(row => {
                row.style.display = '';
            });
        }

        // ดูรายละเอียด (แสดง attempt_no ด้วย)
        async function viewDetails(bookingId) {
            try {
                const token = localStorage.getItem('teacherToken');
                const response = await fetch(`/api/get_booking_details.php?id=${bookingId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch details');
                }

                const data = await response.json();
                if (data.status === 'error') {
                    throw new Error(data.message);
                }

                // แสดงรายละเอียดในรูปแบบที่ต้องการ (โชว์ attempt_no ถ้ามี)
                const attemptNo = data.details?.attempt_no ?? '-';
                alert(`
                    รหัสนิสิต: ${data.details.student_id}
                    ชื่อ-นามสกุล: ${data.details.student_name}
                    วันที่สอบ: ${formatDate(data.details.exam_date)}
                    เวลา: ${formatTime(data.details.exam_time)}
                    หัวข้อสอบ: ${data.details.exam_title}
                    ครั้งที่สอบ: ${attemptNo}
                    สถานะ: ${getStatusText(data.details.status)}
                `);

            } catch (error) {
                console.error('Error:', error);
                alert('ไม่สามารถดึงข้อมูลรายละเอียดได้: ' + error.message);
            }
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', function() {
            localStorage.removeItem('teacherToken');
            window.location.href = 'teacher_login.html';
        });
    </script>
</body>
</html>
