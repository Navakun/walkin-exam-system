<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สถานะการลงทะเบียนสอบ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/student.css">
    <link rel="stylesheet" href="assets/css/student-status.css">
    <link rel="icon" href="favicon.ico">
    <style>
    </style>
</head>

<body>
    <header>
        <div class="logo-text">
            <img src="nulogo.png" alt="Logo" height="60">
            <div class="course-title">
                <h2>รายวิชา 273252 กฎหมายเทคโนโลยีสารสนเทศ<br>มหาวิทยาลัยนเรศวร</h2>
            </div>
        </div>
        <div class="top-right">
            <button id="backBtn" class="home-btn">กลับหน้าหลัก</button>
            <button id="logoutBtn" class="logout-btn">ออกจากระบบ</button>
        </div>
    </header>

    <div class="container">
        <div class="d-flex align-items-center mb-3">
            <i class="fas fa-2x text-primary me-2"></i>
            <h2 class="mb-1">สถานะการลงทะเบียนสอบ</h2>
        </div>
        <div id="errorAlert" class="alert alert-danger hidden" role="alert" style="display: none;"></div>

        <!-- ส่วนค้นหา -->
        <div class="search-section">
            <div class="search-filters">
                <input type="text" id="searchInput" placeholder="ค้นหาด้วยรหัสนิสิต หรือ ชื่อ-นามสกุล"
                    class="form-control">
                <label for="searchDate" class="form-label visually-hidden">ค้นหาด้วยวันที่สอบ</label>
                <input type="date" id="searchDate" class="form-control" placeholder="เลือกวันที่สอบ"
                    title="ค้นหาด้วยวันที่สอบ">
                <button onclick="searchRegistrations()" class="btn btn-primary">
                    <i class="fas fa-search"></i> ค้นหา
                </button>
                <button onclick="resetSearch()" class="btn btn-secondary">
                    <i class="fas fa-redo"></i> ล้างการค้นหา
                </button>
            </div>
        </div>

        <!-- ตารางแสดงสถานะ -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>รหัสนิสิต</th>
                        <th>ชื่อ-นามสกุล</th>
                        <th>วันที่สอบ</th>
                        <th>เวลา</th>
                        <th>หัวข้อสอบ</th>
                        <th>สถานะ</th>
                        <!-- <th>การดำเนินการ</th> -->
                    </tr>
                </thead>
                <tbody id="registrationTable">
                    <!-- ข้อมูลจะถูกเพิ่มด้วย JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // ---------- CONFIG ----------
        // ถ้าโปรเจกต์ถูกวางในโฟลเดอร์ย่อย เช่น /walkin-exam-system/ ให้ต่อ root นั้นให้เอง
        const ROOT = location.pathname.includes('/walkin-exam-system/')
            ? '/walkin-exam-system'
            : '';
        const API_BASE = `${ROOT}/api/`;   // ผลลัพธ์จะเป็น "/api/" หรือ "/walkin-exam-system/api/"

        const ENDPOINT_VERIFY = 'verify_token.php';
        const ENDPOINT_LIST = 'get_registration_status.php';
        const ENDPOINT_DETAIL = 'get_booking_details.php';

        // ---------- HELPERS ----------
        const $ = (id) => document.getElementById(id);
        const esc = (s) => String(s ?? '')
            .replace(/&/g, '&amp;').replace(/"/g, '&quot;')
            .replace(/</g, '&lt;').replace(/>/g, '&gt;');

        // helper เรียก API พร้อมจัดการ JSON/ข้อความผิดปกติ
        async function apiGet(path, opt = {}) {
            const res = await fetch(API_BASE + path, { cache: 'no-store', ...opt });
            const raw = await res.text();
            let data;
            try { data = JSON.parse(raw); }
            catch { throw new Error(`เซิร์ฟเวอร์ตอบกลับไม่ใช่ JSON: ${raw}`); }
            if (!res.ok) throw new Error(data?.message || `HTTP ${res.status}`);
            return data;
        }

        function getTeacherToken() {
            return localStorage.getItem('teacherToken') || sessionStorage.getItem('teacherToken');
        }

        function showError(message) {
            const el = $('errorAlert');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => (el.style.display = 'none'), 5000);
        }

        // dd/mm/yyyy
        function formatDate(dateStr) {
            if (!dateStr) return '';
            // รองรับทั้ง 'YYYY-MM-DD', 'YYYY-MM-DD HH:MM:SS', 'DD/MM/YYYY'
            if (/^\d{4}-\d{2}-\d{2}/.test(dateStr)) {
                const [y, m, rest] = dateStr.split('-');
                const d = rest.slice(0, 2);
                return `${d}/${m}/${y}`;
            }
            return dateStr;
        }
        // HH:MM
        function formatTime(timeStr) {
            if (!timeStr) return '';
            // รองรับ 'HH:MM:SS' / 'YYYY-MM-DD HH:MM:SS'
            if (/^\d{2}:\d{2}/.test(timeStr)) return timeStr.split(':').slice(0, 2).join(':');
            if (/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}/.test(timeStr)) {
                return timeStr.split(' ')[1].split(':').slice(0, 2).join(':');
            }
            return timeStr;
        }

        // แปลง/เดาสถานะ + ข้อความแสดง
        function computeStatus(reg) {
            const ended = reg.end_time || reg.has_completed === 1 || reg.status === 'completed';
            return ended ? 'completed' : 'registered';
        }
        function statusText(reg) {
            const ended = computeStatus(reg) === 'completed';
            if (ended) {
                return reg.last_attempt ? `สอบแล้ว (ครั้งที่ ${reg.last_attempt})` : 'สอบแล้ว';
            }
            return reg.next_attempt ? `ลงทะเบียนแล้ว (จะเป็นครั้งที่ ${reg.next_attempt})` : 'ลงทะเบียนแล้ว';
        }

        // ---------- BOOT ----------
        document.addEventListener('DOMContentLoaded', initBoot);

        async function initBoot() {
            // ปุ่มบนหัว
            $('backBtn')?.addEventListener('click', () => location.href = 'teacher_dashboard.html');
            $('logoutBtn')?.addEventListener('click', () => {
                localStorage.removeItem('teacherToken');
                sessionStorage.removeItem('teacherToken');
                location.href = 'teacher_login.html';
            });

            const token = getTeacherToken();
            if (!token) {
                location.href = 'teacher_login.html';
                return;
            }

            // ลอง verify token (ถ้า endpoint ไม่มี/404 → ถือว่า ok แล้วไปต่อ)
            try {
                await apiGet(ENDPOINT_VERIFY, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
            } catch (e) {
                if (e.message.includes('401') || e.message.includes('403')) {
                    showError('Session หมดอายุ กรุณาเข้าสู่ระบบใหม่');
                    setTimeout(() => {
                        localStorage.removeItem('teacherToken');
                        sessionStorage.removeItem('teacherToken');
                        location.href = 'teacher_login.html';
                    }, 1500);
                    return;
                }
                // เงียบไว้ และไปโหลดข้อมูล (กรณีเซิร์ฟเวอร์ไม่รองรับ verify)
                console.warn('verify_token failed/absent, continue:', e);
            }

            await loadRegistrations();
        }

        // ---------- LOAD + RENDER ----------
        async function loadRegistrations() {
            try {
                const token = getTeacherToken();
                const payload = await apiGet(ENDPOINT_LIST, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json', 'Authorization': `Bearer ${token}` },
                    cache: 'no-store'
                });

                const list = payload?.registrations ?? payload?.data ?? [];
                displayRegistrations(Array.isArray(list) ? list : []);
            } catch (err) {
                console.error(err);
                showError('ไม่สามารถโหลดข้อมูลได้: ' + (err.message || err));
            }
        }

        function displayRegistrations(registrations) {
            const tbody = $('registrationTable');
            tbody.innerHTML = '';

            if (!registrations.length) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center">ไม่มีข้อมูลการลงทะเบียนสอบ</td></tr>`;
                return;
            }

            // เรียงคนที่ลงทะเบียนล่าสุดก่อน
            const regTime = (r) =>
                (r.registered_at || r.created_at || r.booking_time || r.booked_at || r.updated_at || '').replace(' ', 'T');
            registrations.sort((a, b) => {
                const tb = new Date(regTime(b)), ta = new Date(regTime(a));
                if (!isNaN(tb) && !isNaN(ta)) return tb - ta;
                const idB = Number(b.booking_id || b.session_id || 0);
                const idA = Number(a.booking_id || a.session_id || 0);
                if (idB !== idA) return idB - idA;
                const kB = new Date(`${b.exam_date || ''} ${b.exam_time || ''}`);
                const kA = new Date(`${a.exam_date || ''} ${a.exam_time || ''}`);
                return kB - kA;
            });

            const rows = registrations.map((r) => {
                const sid = r.student_id ?? r.sid ?? '-';
                const name = r.student_name ?? r.name ?? '-';
                const date = r.exam_date ?? r.slot_date ?? r.date ?? '';
                const time = r.exam_time ?? r.slot_start_time ?? r.start_time ?? '';
                const title = r.exam_title ?? r.title ?? r.examset_name ?? '-';

                const stat = computeStatus(r);
                const text = statusText(r);
                const cls = `status-badge ${stat}`;

                return `
        <tr>
          <td>${esc(sid)}</td>
          <td>${esc(name)}</td>
          <td>${esc(formatDate(date))}</td>
          <td>${esc(formatTime(time))}</td>
          <td>${esc(title)}</td>
          <td><span class="${cls}">${esc(text)}</span></td>
        </tr>`;
            }).join('');

            tbody.innerHTML = rows;
        }

        // ---------- SEARCH ----------
        function searchRegistrations() {
            const q = $('searchInput').value.toLowerCase();
            const date = $('searchDate').value; // yyyy-mm-dd
            const rows = $('registrationTable').getElementsByTagName('tr');

            Array.from(rows).forEach((row) => {
                const sid = row.cells[0]?.textContent.toLowerCase() ?? '';
                const name = row.cells[1]?.textContent.toLowerCase() ?? '';
                const ddmmyyyy = row.cells[2]?.textContent ?? '';   // dd/mm/yyyy

                let matchDate = true;
                if (date && ddmmyyyy.includes('/')) {
                    const [d, m, y] = ddmmyyyy.split('/');
                    const ymd = `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
                    matchDate = (ymd === date);
                }

                const matchText = sid.includes(q) || name.includes(q);
                row.style.display = (matchText && matchDate) ? '' : 'none';
            });
        }
        function resetSearch() {
            $('searchInput').value = '';
            $('searchDate').value = '';
            Array.from($('registrationTable').getElementsByTagName('tr')).forEach(r => r.style.display = '');
        }
        window.searchRegistrations = searchRegistrations;
        window.resetSearch = resetSearch;

        // ---------- (Optional) รายละเอียดการจอง ----------
        async function viewDetails(bookingId) {
            try {
                const token = getTeacherToken();
                const payload = await apiGet(`${ENDPOINT_DETAIL}?id=${encodeURIComponent(bookingId)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (payload?.status === 'error') throw new Error(payload?.message || 'ดึงรายละเอียดไม่สำเร็จ');

                const d = payload.details || {};
                const attempt = d.attempt_no ?? d.attempt ?? '-';
                alert(
                    `รหัสนิสิต: ${d.student_id}\n` +
                    `ชื่อ-นามสกุล: ${d.student_name}\n` +
                    `วันที่สอบ: ${formatDate(d.exam_date)}\n` +
                    `เวลา: ${formatTime(d.exam_time)}\n` +
                    `หัวข้อสอบ: ${d.exam_title}\n` +
                    `ครั้งที่สอบ: ${attempt}\n` +
                    `สถานะ: ${computeStatus(d)}`
                );
            } catch (e) {
                console.error(e);
                alert('ไม่สามารถดึงข้อมูลรายละเอียดได้: ' + (e.message || e));
            }
        }
    </script>

</body>

</html>