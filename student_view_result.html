<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <title>ดูผลคะแนนสอบ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="favicon.ico" />
  <!-- Bootstrap + Font -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Your CSS -->
  <link rel="stylesheet" href="assets/css/main.css">
  <link rel="stylesheet" href="assets/css/student.css">
  <link rel="stylesheet" href="assets/css/student-result.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
  <style>
    body {
      font-family: "Prompt", sans-serif;
    }

    .result-main {
      max-width: 980px;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }

    .course-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 18px;
      border-bottom: 1px solid #eee;
      background: #fff;
    }

    /* เพิ่ม styles สำหรับแก้ inline styles */
    #errorBox {
      display: none;
    }

    #detailMeta {
      margin-bottom: 10px;
    }

    .kpi-value {
      font-size: 20px;
      font-weight: 700;
    }

    .wrong-list h4 {
      margin: 14px 0 6px;
    }

    .logo-text {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .center-title {
      text-align: center;
      margin-bottom: 12px;
    }

    .student-info-box {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, .05);
      padding: 18px 18px 8px;
      margin-bottom: 16px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 4px;
      border-bottom: 1px dashed #eee;
    }

    .info-row:last-child {
      border-bottom: 0;
    }

    .info-label {
      color: #6b7280;
    }

    .info-value {
      font-weight: 600;
      color: #111827;
    }

    .table-container {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, .05);
      padding: 18px;
    }

    .result-table {
      width: 100%;
    }

    .result-table th {
      background: #f7f7fb;
      font-weight: 600;
    }

    .stat-badge {
      display: inline-block;
      min-width: 64px;
      text-align: center;
      border-radius: 999px;
      padding: 8px 12px;
      font-weight: 600;
    }

    .stat-total {
      background: #eef2ff;
      color: #4338ca;
    }

    .stat-correct {
      background: #ecfdf5;
      color: #047857;
    }

    .stat-wrong {
      background: #fef2f2;
      color: #b91c1c;
    }

    .stat-time {
      background: #f3f4f6;
      color: #111827;
    }

    .summary-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin: -4px 0 10px;
    }
  </style>
</head>

<body>
  <header class="course-header">
    <div class="logo-text">
      <img src="nulogo.png" alt="Logo" height="56">
      <div class="course-title">
        <h2 class="m-0 fs-5">รายวิชา 273252 กฎหมายเทคโนโลยีสารสนเทศ<br class="d-none d-md-block">มหาวิทยาลัยนเรศวร</h2>
      </div>
    </div>
    <div class="ms-auto d-flex gap-2">
      <button id="backBtn" class="btn btn-outline-primary">กลับหน้าหลัก</button>
      <button id="logoutBtn" class="btn btn-outline-danger">ออกจากระบบ</button>
    </div>
  </header>

  <main class="result-main">
    <!-- แบนเนอร์แจ้งเตือน -->
    <div id="bannerArea" class="mb-3"></div>

    <!-- สรุปผลสอบ (แทนป้าย % และ ไม่ผ่าน เดิม) -->
    <div class="mini-metrics" id="examSummary">
      <span class="metric">
        <i class="fas fa-star"></i>
        คะแนนรวม: <span id="summaryScore">—</span>
      </span>

      <span class="metric">
        <i class="fas fa-flag-checkered"></i>
        สถานะ: <span id="summaryStatus" class="badge rounded-pill bg-secondary-subtle text-secondary">—</span>
      </span>

      <span class="metric">
        <i class="fas fa-hourglass-half"></i>
        เวลาเฉลี่ย/ข้อ: <span id="avgPerItem">—</span>
      </span>
    </div>

    <h3 class="center-title">ผลการทำข้อสอบ</h3>
    <div class="info-row">
      <span class="info-label">รหัสนิสิต</span>
      <span class="info-value" id="studentId"><i class="fas fa-user-graduate me-2"></i>—</span>
    </div>
    <div class="info-row">
      <span class="info-label">ชื่อ - นามสกุล</span>
      <span class="info-value" id="studentName"><i class="fas fa-user me-2"></i>—</span>
    </div>
    </div>

    <!-- ตารางสรุปผล -->
    <div class="table-container">
      <table class="result-table table table-borderless align-middle">
        <thead>
          <tr>
            <th><i class="fas fa-tasks me-2"></i>จำนวนข้อทั้งหมด</th>
            <th><i class="fas fa-check-circle me-2"></i>ถูก</th>
            <th><i class="fas fa-times-circle me-2"></i>ผิด</th>
            <th><i class="fas fa-hourglass-start me-2"></i>เวลาที่เริ่มทำ</th>
            <th><i class="fas fa-hourglass-end me-2"></i>เวลาที่ข้อสอบเสร็จ</th>
            <th><i class="fas fa-clock me-2"></i>เวลาที่ใช้</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><span class="stat-badge stat-total kpi-value" id="totalValue">—</span></td>
            <td><span class="stat-badge stat-correct kpi-value" id="correctValue">—</span></td>
            <td><span class="stat-badge stat-wrong kpi-value" id="wrongValue">—</span></td>
            <td><span class="stat-badge stat-time kpi-value" id="startTime">—</span></td>
            <td><span class="stat-badge stat-time kpi-value" id="endTime">—</span></td>
            <td><span class="stat-badge stat-time kpi-value" id="duration">—</span></td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- แจ้งเตือนกรณีไม่ผ่าน (แสดงใต้ตาราง) -->
    <div id="failureNoticeArea" class="mt-4"></div>

  </main>

  <script>
    (() => {
      /** ---------------- Utils ---------------- */
      const $ = (id) => document.getElementById(id);

      const showNotice = (msg = '', type = 'danger') => {
        const el = $('failureNoticeArea');
        if (!el) return;
        el.innerHTML = msg ? `<div class="alert alert-${type} mb-0" role="alert">${msg}</div>` : '';
      };

      const parseJwt = (token) => {
        try { return JSON.parse(atob(token.split('.')[1])); }
        catch { return null; }
      };

      const toDate = (t) => t ? new Date(t.replace(' ', 'T') + 'Z') : null;

      const fmtDMYHM = (t) => {
        const d = toDate(t);
        if (!d || isNaN(d)) return '—';
        const dd = String(d.getUTCDate()).padStart(2, '0');
        const mm = String(d.getUTCMonth() + 1).padStart(2, '0');
        const yy = d.getUTCFullYear();
        const hh = String(d.getUTCHours()).padStart(2, '0');
        const mi = String(d.getUTCMinutes()).padStart(2, '0');
        return `${dd}/${mm}/${yy} ${hh}:${mi}`;
      };

      const fmtDuration = (ms) => {
        if (ms == null || isNaN(ms) || ms < 0) return '—';
        const s = Math.floor(ms / 1000);
        const h = Math.floor(s / 3600);
        const m = Math.floor((s % 3600) / 60);
        const ss = s % 60;
        const pad = (n) => (n < 10 ? '0' + n : '' + n);
        return (h ? `${h}:` : '') + `${pad(m)}:${pad(ss)}`;
      };

      const getSessionId = () =>
        new URL(location.href).searchParams.get('session_id') || localStorage.getItem('session_id');

      /** ---------------- Main ---------------- */
      document.addEventListener('DOMContentLoaded', async () => {
        const token = localStorage.getItem('studentToken');
        const sessionId = getSessionId();

        if (!token) {
          location.href = 'student_login.html';
          return;
        }
        if (!sessionId) {
          showBanner('ไม่พบรหัสการทดสอบ (session_id)');
          return;
        }

        try {
          showBanner(''); // clear banner
          const res = await fetch(`api/get_result.php?session_id=${encodeURIComponent(sessionId)}`, {
            headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/json' },
            cache: 'no-store'
          });

          const raw = await res.text();
          let json; try { json = JSON.parse(raw); } catch { json = null; }

          if (!res.ok || !json || json.status !== 'success') {
            console.error('get_result.php raw:', raw);
            showBanner(json?.message || `ดึงข้อมูลไม่สำเร็จ (HTTP ${res.status})`);
            return;
          }

          const d = json.data || {};

          // --------- โลโก้ชื่อ/รหัสนิสิต ---------
          const payload = parseJwt(token) || {};
          if ($('studentId')) $('studentId').textContent = d.student_id || payload.student_id || '—';
          if ($('studentName')) $('studentName').textContent = payload.name || '—';

          // --------- รวมข้อ / ถูก / ผิด ---------
          const total = Number(
            d.total_questions ?? (Array.isArray(d.answers) ? d.answers.length : 0) ?? 0
          );

          const correct = Number(
            (d.correct_count != null)
              ? d.correct_count
              : (Array.isArray(d.answers)
                ? d.answers.filter(a => Number(a.is_correct) === 1).length
                : 0)
          );

          // ✅ แก้บั๊ก: ใช้ wrongCount แทนตัวแปร wrong
          const wrongCount = Math.max(0, total - (isFinite(correct) ? correct : 0));

          if ($('totalValue')) $('totalValue').textContent = String(total);
          if ($('correctValue')) $('correctValue').textContent = String(isFinite(correct) ? correct : 0);
          if ($('wrongValue')) $('wrongValue').textContent = String(wrongCount);

          // --------- เวลาเริ่ม/จบ/เวลาที่ใช้ ---------
          const startTime = d.start_time || null;
          const endTime = d.end_time || null;
          const durationMs = Number.isFinite(d.duration_ms)
            ? Number(d.duration_ms)
            : (startTime && endTime ? (toDate(endTime) - toDate(startTime)) : null);

          if ($('startTime')) $('startTime').textContent = fmtDMYHM(startTime);
          if ($('endTime')) $('endTime').textContent = fmtDMYHM(endTime);
          if ($('duration')) $('duration').textContent = fmtDuration(durationMs);

          // --------- สรุปบนหัว: คะแนน/เปอร์เซ็นต์/สถานะ/เฉลี่ยต่อข้อ ---------
          const PASS_THRESHOLD = 60; // เกณฑ์ผ่าน (%)
          const percent = total ? Math.round((correct / total) * 100) : 0;

          // 1) คะแนนรวม + เปอร์เซ็นต์
          if ($('summaryScore')) {
            $('summaryScore').textContent = `${correct}/${total} (${percent}%)`;
          }

          // 2) สถานะ (ผ่าน/ไม่ผ่าน) + สี badge
          if ($('summaryStatus')) {
            const isPass = percent >= PASS_THRESHOLD;
            $('summaryStatus').textContent = isPass ? 'ผ่าน' : 'ไม่ผ่าน';
            $('summaryStatus').className = `badge rounded-pill ${isPass ? 'bg-success-subtle text-success' : 'bg-danger-subtle text-danger'
              }`;
            $('summaryStatus').title = `เกณฑ์ผ่าน ${PASS_THRESHOLD}%`; // tooltip เล็กๆ

            // แสดงแจ้งเตือนสำหรับคนที่สอบไม่ผ่าน
            if (!isPass) {
              showNotice(
                `<strong><i class="fas fa-exclamation-triangle me-2"></i>คุณสอบไม่ผ่านเกณฑ์ ${PASS_THRESHOLD}%</strong><br>` +
                'กรุณาติดต่ออาจารย์ผู้สอนเพื่อขอสอบใหม่อีกครั้ง หรือศึกษาเนื้อหาเพิ่มเติมจากเอกสารประกอบการสอน',
                'danger'
              );
            } else {
              showNotice(''); // ล้างการแจ้งเตือนถ้าสอบผ่าน
            }
          }

          // 3) เวลาเฉลี่ย/ข้อ
          if ($('avgPerItem')) {
            const avg = (durationMs && total) ? Math.round(durationMs / total) : null;
            $('avgPerItem').textContent = avg != null ? fmtDuration(avg) : '—';
          }

          if ($('statusBadge')) {
            $('statusBadge').textContent = pass ? 'ผ่าน' : 'ไม่ผ่าน';
            // ล้าง class เดิม ๆ ที่อาจติด
            $('statusBadge').classList.remove('badge-danger', 'bg-danger', 'badge-success', 'bg-success');
            $('statusBadge').classList.add(pass ? 'bg-success' : 'bg-danger');
          }

          const avgPerQ = (total && durationMs != null) ? Math.round(durationMs / total) : null;
          if ($('avgPerQ')) $('avgPerQ').textContent = fmtDuration(avgPerQ);

          // ถ้ามี progress bar
          if ($('scoreBar')) $('scoreBar').style.width = `${percent}%`;

        } catch (err) {
          console.error(err);
          showBanner('เกิดข้อผิดพลาดในการดึงข้อมูล');
        }
      });

      function showBanner(msg = '', type = 'danger', timeout = 4500) {
        const area = document.getElementById('bannerArea');
        if (!area) return;
        if (!msg) {          // ส่ง '' มาเพื่อเคลียร์
          area.innerHTML = '';
          return;
        }
        area.innerHTML = `<div class="alert alert-${type} mb-2" role="alert">${msg}</div>`;
        if (timeout) setTimeout(() => { area.innerHTML = ''; }, timeout);
      }

      /** ---------------- Buttons ---------------- */
      if ($('backBtn')) $('backBtn').onclick = () => (location.href = 'student_dashboard.html');
      if ($('logoutBtn')) $('logoutBtn').onclick = () => { localStorage.clear(); location.href = 'student_login.html'; };

    })();
  </script>

</body>

</html>