<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>เพิ่มคำถามใหม่</title>

  <link rel="icon" href="data:," />
  <!-- Font Awesome v6 -->
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css" rel="stylesheet">

  <!-- สไตล์หลักของโปรเจกต์ -->
  <link rel="stylesheet" href="assets/css/main.css">
  <link rel="stylesheet" href="assets/css/teacher.css">
  <link rel="stylesheet" href="assets/css/teacher-edit-question.css">

  <!-- SweetAlert2 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

</head>

<body>
  <div class="shell">
    <!-- Sidebar (เหมือนหน้าแดชบอร์ด) -->
    <aside class="sidebar">
      <div class="side-brand">
        <img src="nulogo.png" alt="NU">
        <div>
          <p class="side-title">ระบบจัดสอบ Walk-in</p>
          <div class="side-sub">(สำหรับอาจารย์)</div>
        </div>
      </div>

      <button class="me-chip" id="editProfileBtn" title="แก้ไขโปรไฟล์">
        <i class="fa-solid fa-circle-user"></i>
        <span id="teacherName">อาจารย์ผู้สอน</span>
      </button>
      <button class="logout" id="logoutBtn"><i class="fa-solid fa-right-from-bracket"></i> ออกจากระบบ</button>

      <nav class="nav">
        <div class="group">เมนูหลัก</div>
        <a href="teacher_dashboard.html"><i class="fa-solid fa-house"></i> หน้าหลัก</a>

        <div class="group">การจัดการข้อสอบ</div>
        <a href="teacher_question_bank.html"><i class="fa-solid fa-file-invoice"></i> คลังข้อสอบ</a>
        <a href="#" class="active"><i class="fa-solid fa-square-plus"></i> เพิ่มคำถามใหม่</a>

        <div class="group">การจัดการสอบ</div>
        <a href="teacher_exam_out.html"><i class="fa-solid fa-calendar-days"></i> ช่วงเวลาการสอบ</a>
        <a href="exam_users.html"><i class="fa-solid fa-users"></i> รายชื่อผู้เข้าสอบ</a>
        <a href="exam_registration_status.html"><i class="fa-solid fa-clipboard-check"></i> ตรวจสอบสถานะนิสิต</a>
        <a href="exam_statistics.html"><i class="fa-solid fa-chart-bar"></i> สถิติการสอบ</a>

        <div class="group">เนื้อหารายวิชา</div>
        <a href="teaching_materials.html"><i class="fa-solid fa-file-arrow-up"></i> อัปโหลดสื่อการสอน</a>
        <a href="teacher_open_materials.html"><i class="fa-solid fa-book-open-reader"></i> ดูสื่อการสอน</a>
      </nav>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="page-head">
        <h2>เพิ่มคำถามใหม่</h2>
        <button id="backBtn" class="btn btn-back"><i class="fa-solid fa-arrow-left"></i> คลังข้อสอบ</button>
      </div>

      <div class="container">
        <form id="addQuestionForm">
          <label for="question_text">คำถาม:</label>
          <textarea id="question_text" required placeholder="พิมพ์คำถามของคุณที่นี่..."></textarea>

          <label for="choiceA">ตัวเลือก A:</label>
          <input type="text" id="choiceA" required placeholder="ตัวเลือก A">

          <label for="choiceB">ตัวเลือก B:</label>
          <input type="text" id="choiceB" required placeholder="ตัวเลือก B">

          <label for="choiceC">ตัวเลือก C:</label>
          <input type="text" id="choiceC" required placeholder="ตัวเลือก C">

          <label for="choiceD">ตัวเลือก D:</label>
          <input type="text" id="choiceD" required placeholder="ตัวเลือก D">

          <label for="correct_choice">คำตอบที่ถูกต้อง:</label>
          <select id="correct_choice" required>
            <option value="A">A</option>
            <option value="B">B</option>
            <option value="C">C</option>
            <option value="D">D</option>
          </select>

          <!-- เปลี่ยนจากระดับความยาก เป็นระดับผลลัพธ์การเรียนรู้ -->
          <label for="cognitive_level">ระดับผลลัพธ์การเรียนรู้:</label>
          <select id="cognitive_level" required>
            <option value="1">ด้านความเข้าใจ (Understand)</option>
            <option value="2">ด้านประยุกต์ (Apply)</option>
            <option value="3">ด้านวิเคราะห์ (Analyze)</option>
          </select>

          <button type="submit" class="submit-btn sticky-save">
            <i class="fa-solid fa-floppy-disk"></i> บันทึกคำถาม
          </button>
        </form>
      </div>
    </main>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    (function init() {
      if (!window.Swal) { console.error('SweetAlert2 ไม่ได้โหลด'); return; }

      // ---------- SweetAlert helpers ----------
      const Toast = Swal.mixin({ toast: true, position: 'bottom-end', showConfirmButton: false, timer: 2200, timerProgressBar: true });
      const showError = (msg) => Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: msg });
      const showWarn = (title, text, goto) =>
        Swal.fire({ icon: 'warning', title, text, confirmButtonText: 'ไปต่อ' })
          .then(() => { if (goto) location.href = goto; });
      const showLoading = (t = 'กำลังบันทึก...') => Swal.fire({ title: t, allowOutsideClick: false, allowEscapeKey: false, didOpen: () => Swal.showLoading() });
      const closeLoading = () => Swal.close();

      // ---------- Auth / UI header ----------
      const token = localStorage.getItem('teacherToken');
      if (!token) { showWarn('ยังไม่ได้เข้าสู่ระบบ', 'กรุณาเข้าสู่ระบบสำหรับอาจารย์ก่อน', 'teacher_login.html'); return; }
      document.getElementById('teacherName').textContent = localStorage.getItem('instructor_name') || 'อาจารย์ผู้สอน';

      // ---------- Nav buttons ----------
      document.getElementById('backBtn').onclick = () => (location.href = 'teacher_question_bank.html');
      document.getElementById('logoutBtn').onclick = () => {
        Swal.fire({
          icon: 'warning', title: 'ออกจากระบบ?', text: 'ต้องการออกจากระบบตอนนี้หรือไม่',
          showCancelButton: true, confirmButtonText: 'ออกจากระบบ', cancelButtonText: 'ยกเลิก'
        }).then(r => {
          if (r.isConfirmed) {
            localStorage.removeItem('teacherToken');
            localStorage.removeItem('instructor_name');
            location.href = 'teacher_login.html';
          }
        });
      };

      // ---------- Legacy bridge: แปลงระดับการคิดเป็นตัวเลข (ถ้า API เก่ายังอ่าน difficulty) ----------
      const diffFromCognitive = (cogId) => {
        // 1=UNDERSTAND, 2=APPLY, 3=ANALYZE
        if (cogId === 1) return 0.15;
        if (cogId === 3) return 0.85;
        return 0.50;
      };

      // ---------- Submit ----------
      const form = document.getElementById('addQuestionForm');
      const saveBtn = document.querySelector('.submit-btn');

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const ok = await Swal.fire({
          icon: 'question', title: 'ยืนยันการบันทึก?', text: 'ระบบจะเพิ่มคำถามใหม่ตามข้อมูลที่กรอก',
          showCancelButton: true, confirmButtonText: 'บันทึกเลย', cancelButtonText: 'ยกเลิก'
        });
        if (!ok.isConfirmed) return;

        const qtext = document.getElementById('question_text').value.trim();
        const A = document.getElementById('choiceA').value.trim();
        const B = document.getElementById('choiceB').value.trim();
        const C = document.getElementById('choiceC').value.trim();
        const D = document.getElementById('choiceD').value.trim();
        const correct = document.getElementById('correct_choice').value;
        const cogId = Number(document.getElementById('cognitive_level').value || 1);

        if (!qtext || !A || !B || !C || !D) return showError('กรุณากรอกข้อมูลให้ครบทุกช่อง');
        if (!/^[ABCD]$/.test(correct)) return showError('คำตอบที่ถูกต้องต้องเป็น A, B, C หรือ D');

        // payload ใหม่ (หลัก) + ใส่ฟิลด์ legacy ให้ด้วยเพื่อความเข้ากันได้
        const payload = {
          question_text: qtext,
          choices: { A, B, C, D },
          correct_choice: correct,
          cognitive_level_id: cogId,                 // <-- ใช้คอลัมน์ใหม่ใน DB
          difficulty: diffFromCognitive(cogId),      // <-- เผื่อ API เก่าที่อ่าน difficulty
          difficulty_level: diffFromCognitive(cogId) // <-- เผื่อมีอีกชื่อหนึ่งในโค้ดเก่า
        };

        const originalText = saveBtn.textContent;
        saveBtn.disabled = true; saveBtn.classList.add('is-loading'); saveBtn.textContent = 'กำลังบันทึก...';
        showLoading('กำลังบันทึก...');

        try {
          const res = await fetch('api/create_question.php', { // ใช้ endpoint เดิมของคุณ
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify(payload),
            credentials: 'same-origin'
          });
          closeLoading();

          if (res.status === 401) {
            return showWarn('เซสชันหมดอายุ', 'กรุณาเข้าสู่ระบบใหม่', 'teacher_login.html');
          }

          const result = await res.json().catch(() => ({}));
          if (res.ok && result.status === 'success') {
            Toast.fire({ icon: 'success', title: 'เพิ่มคำถามสำเร็จ' });
            setTimeout(() => location.href = 'teacher_question_bank.html', 1200);
          } else {
            showError(result.message || 'บันทึกไม่สำเร็จ');
          }
        } catch (err) {
          closeLoading();
          console.error(err);
          showError('เชื่อมต่อเซิร์ฟเวอร์ไม่สำเร็จ');
        } finally {
          saveBtn.classList.remove('is-loading');
          saveBtn.disabled = false;
          saveBtn.textContent = originalText;
        }
      });
    })();
  </script>

</body>

</html>