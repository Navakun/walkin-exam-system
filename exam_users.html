<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>รายชื่อผู้เข้าสอบ</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="icon" type="image/x-icon" href="favicon.ico">

</head>

<body>
    <header>
        <div class="logo-text">
            <img src="nulogo.png" alt="Logo" height="80">
            <div class="course-title">
                <h2>รายวิชา 273252 กฎหมายเทคโนโลยีสารสนเทศ มหาวิทยาลัยนเรศวร</h2>
            </div>
        </div>
        <div class="top-right">
            <button type="button" id="backBtn" class="home-btn">กลับหน้าหลัก</button>
            <button id="logoutBtn" class="logout-btn">ออกจากระบบ</button>
        </div>
    </header>

    <main class="teacher-dashboard">
        <h1>รายชื่อผู้เข้าสอบและผลคะแนน</h1>
        
        <div id="errorBox" class="message error" style="display: none;"></div>

        <div class="search-container">
            <input type="text" id="searchInput" placeholder="ค้นหาจากรหัสนักศึกษา หรือ ชื่อ-นามสกุล...">
        </div>

        <div id="results-container">
            <table>
                <thead>
                    <tr>
                        <th>รหัสนักศึกษา</th>
                        <th>ชื่อ - นามสกุล</th>
                        <th>ชุดข้อสอบ</th>
                        <th>คะแนน</th>
                        <th>เวลาเริ่มสอบ</th>
                        <th>เวลา-ส่งข้อสอบ</th>
                    </tr>
                </thead>
                <tbody id="results-table-body">
                    <tr>
                        <td colspan="6">กำลังโหลดข้อมูล...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', init);

        // ฟังก์ชันค้นหา
        function filterTable(searchText) {
            const tbody = document.getElementById('results-table-body');
            const rows = tbody.getElementsByTagName('tr');
            
            for (let row of rows) {
                const cells = row.getElementsByTagName('td');
                if (cells.length === 0) continue; // ข้าม header row
                
                let found = false;
                for (let cell of cells) {
                    if (cell.textContent.toLowerCase().includes(searchText.toLowerCase())) {
                        found = true;
                        break;
                    }
                }
                row.style.display = found ? '' : 'none';
            }
        }

        async function init() {
            const token = localStorage.getItem('teacherToken');
            const tbody = document.getElementById('results-table-body');
            const errorBox = document.getElementById('errorBox');

            if (!token) {
                errorBox.textContent = 'ไม่ได้ล็อกอินอาจารย์ กรุณาเข้าสู่ระบบใหม่';
                location.href = 'teacher_login.html';
                return;
            }

            try {
                const resp = await fetch('api/get_all_results_new.php', {
                    headers: { 'Authorization': `Bearer ${token}` },
                    cache: 'no-store'
                });

                const raw = await resp.text();           // อ่านเป็น text ก่อน
                console.log('RAW:', raw);                // ดูใน Console ได้เลย

                let data;
                try {
                    data = JSON.parse(raw);                // ค่อยแปลงเป็น JSON
                } catch {
                    errorBox.textContent = 'เซิร์ฟเวอร์ตอบกลับไม่ใช่ JSON';
                    tbody.innerHTML = `<tr><td colspan="6">${raw}</td></tr>`;
                    return;
                }

                if (!resp.ok || data.status !== 'success') {
                    errorBox.textContent = data.message || `HTTP ${resp.status}`;
                    return;
                }

                // วาดตาราง
                                tbody.innerHTML = '';
                                for (const r of data.data) {
                                        const tr = document.createElement('tr');
                                        tr.innerHTML = `
                <td>${r.student_id}</td>
                <td>${r.student_name}</td>
                <td>${r.exam_title}</td>
                <td>${r.score ?? '-'}</td>
                <td>${r.start_time ?? '-'}</td>
                <td>${r.end_time ?? '-'}</td>
            `;
                                        tbody.appendChild(tr);
                                }
            } catch (err) {
                console.error(err);
                errorBox.textContent = err.message || 'เชื่อมต่อเซิร์ฟเวอร์ไม่ได้';
            }
        }

        // กลับหน้าหลัก
        document.getElementById('backBtn').addEventListener('click', () => {
            location.href = 'teacher_dashboard.html';
        });

        // ออกจากระบบ
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('teacherToken');
            window.location.href = 'teacher_login.html';
        });

        // ผูก event สำหรับช่องค้นหา
        document.getElementById('searchInput').addEventListener('input', (e) => {
            filterTable(e.target.value);
        });
    </script>

</body>

</html>