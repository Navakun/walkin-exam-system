<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>รายชื่อผู้เข้าสอบ</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
  <link rel="icon" type="image/x-icon" href="favicon.ico" />
</head>
<body>
  <header>
    <div class="logo-text">
      <img src="nulogo.png" alt="Logo" height="80" />
      <div class="course-title">
        <h2>รายวิชา 273252 กฎหมายเทคโนโลยีสารสนเทศ มหาวิทยาลัยนเรศวร</h2>
      </div>
    </div>
    <div class="top-right">
      <button type="button" id="backBtn" class="home-btn">กลับหน้าหลัก</button>
      <button id="logoutBtn" class="logout-btn">ออกจากระบบ</button>
    </div>
  </header>

  <main class="teacher-dashboard">
    <h1>รายชื่อผู้เข้าสอบและผลคะแนน</h1>

    <div id="errorBox" class="message error" style="display:none;"></div>

    <div class="search-container">
      <input type="text" id="searchInput" placeholder="ค้นหาจากรหัสนักศึกษา หรือ ชื่อ-นามสกุล..." />
    </div>

    <div id="results-container">
      <table>
        <thead>
          <tr>
            <th>รหัสนักศึกษา</th>
            <th>ชื่อ - นามสกุล</th>
            <th>ชุดข้อสอบ</th>
            <th>คะแนน</th>
            <th>เวลาเริ่มสอบ</th>
            <th>เวลา-ส่งข้อสอบ</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="results-table-body">
          <tr>
            <td colspan="7">กำลังโหลดข้อมูล...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </main>

  <script>
    let SESSIONS = [];

    document.addEventListener('DOMContentLoaded', () => {
      init();

      // กลับหน้าหลัก
      document.getElementById('backBtn').addEventListener('click', () => {
        location.href = 'teacher_dashboard.html';
      });

      // ออกจากระบบ
      document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('teacherToken');
        location.href = 'teacher_login.html';
      });

      // ค้นหา
      document.getElementById('searchInput').addEventListener('input', (e) => {
        filterTable(e.target.value);
      });

      // ใช้ event delegation แทน inline onclick
      document.getElementById('results-container').addEventListener('click', (e) => {
        const btn = e.target.closest('.btn-details');
        if (!btn) return;
        const tr = btn.closest('tr');
        const sessionId = tr?.dataset.sessionId;
        const studentId = tr?.dataset.studentId;
        viewDetails(sessionId, studentId);
      });
    });

    // ฟังก์ชันค้นหาแบบง่าย
    function filterTable(searchText) {
      const tbody = document.getElementById('results-table-body');
      const rows = tbody.getElementsByTagName('tr');
      for (let row of rows) {
        const cells = row.getElementsByTagName('td');
        if (!cells.length) continue; // ข้าม header/แถวว่าง
        let found = false;
        for (let cell of cells) {
          if (cell.textContent.toLowerCase().includes(searchText.toLowerCase())) {
            found = true; break;
          }
        }
        row.style.display = found ? '' : 'none';
      }
    }

    async function init() {
      const token = localStorage.getItem('teacherToken');
      const tbody = document.getElementById('results-table-body');
      const errorBox = document.getElementById('errorBox');

      if (!token) {
        errorBox.textContent = 'ไม่ได้ล็อกอินอาจารย์ กรุณาเข้าสู่ระบบใหม่';
        errorBox.style.display = 'block';
        location.href = 'teacher_login.html';
        return;
      }

      try {
        const resp = await fetch('api/get_all_results_new.php', {
          headers: { Authorization: `Bearer ${token}` },
          cache: 'no-store',
        });

        const raw = await resp.text();
        console.log('RAW:', raw);

        let data;
        try { data = JSON.parse(raw); }
        catch {
          errorBox.textContent = 'เซิร์ฟเวอร์ตอบกลับไม่ใช่ JSON';
          errorBox.style.display = 'block';
          tbody.innerHTML = `<tr><td colspan="7">${raw}</td></tr>`;
          return;
        }

        if (!resp.ok || data.status !== 'success' || !Array.isArray(data.data)) {
          errorBox.textContent = data?.message || `HTTP ${resp.status}`;
          errorBox.style.display = 'block';
          return;
        }

        SESSIONS = data.data;
        renderTable(SESSIONS);
      } catch (err) {
        console.error(err);
        const errorBox = document.getElementById('errorBox');
        errorBox.textContent = err.message || 'เชื่อมต่อเซิร์ฟเวอร์ไม่ได้';
        errorBox.style.display = 'block';
      }
    }

    function renderTable(rows) {
      const tbody = document.getElementById('results-table-body');
      if (!rows.length) {
        tbody.innerHTML = '<tr><td colspan="7">ไม่พบข้อมูล</td></tr>';
        return;
      }

      tbody.innerHTML = rows.map((r) => `
        <tr data-session-id="${r.session_id}" data-student-id="${r.student_id}">
          <td>${r.student_id}</td>
          <td>${r.student_name}</td>
          <td>${r.exam_title}</td>
          <td>${r.score ?? '-'}</td>
          <td>${r.start_time ?? '-'}</td>
          <td>${r.end_time ?? '-'}</td>
          <td>
            <button type="button" class="btn-details">
              <i class="fas fa-info-circle"></i> ดูรายละเอียด
            </button>
          </td>
        </tr>
      `).join('');
    }

    async function viewDetails(sessionId, studentId) {
      try {
        const token = localStorage.getItem('teacherToken');
        if (!token) {
          alert('ไม่ได้ล็อกอิน');
          location.href = 'teacher_login.html';
          return;
        }

        // fallback: หา studentId จาก DOM หากไม่ได้ส่งมา
        if (!studentId && sessionId) {
          const row = document.querySelector(`tr[data-session-id="${sessionId}"]`);
          studentId = row?.dataset.studentId || '';
        }

        if (!studentId) {
          alert('ไม่พบ student_id');
          return;
        }

        // ใช้ path แบบสัมพันธ์ให้เหมือนหน้าอื่น ๆ
        const url = `api/get_booking_details.php?student_id=${encodeURIComponent(studentId)}&session_id=${encodeURIComponent(sessionId || '')}`;
        const response = await fetch(url, {
          headers: {
            Authorization: `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
          cache: 'no-store',
        });

        if (!response.ok) throw new Error('Failed to fetch details');

        const payload = await response.json();
        // รองรับหลายรูปแบบ: {status:'success', details:{...}} หรือ {status:'success', data:{...}} หรือโครงสร้างอื่นที่คล้ายกัน
        const det = payload?.details || payload?.data || payload;
        if (payload?.status === 'error' || !det) {
          throw new Error(payload?.message || 'ไม่พบข้อมูลรายละเอียด');
        }

        alert(`รายละเอียดการสอบ:\n` +
          `รหัสนิสิต: ${det.student_id ?? studentId}\n` +
          `ชื่อ-นามสกุล: ${det.student_name ?? '-'}\n` +
          `ชุดข้อสอบ: ${det.exam_title ?? '-'}\n` +
          `เวลาเริ่มสอบ: ${det.start_time ?? det.exam_date ?? '-'}\n` +
          `เวลาส่งข้อสอบ: ${det.end_time ?? det.exam_time ?? '-'}\n` +
          `คะแนน: ${det.score ?? '-'}\n` +
          `สถานะ: ${det.status ?? '-'}`
        );
      } catch (error) {
        console.error('Error:', error);
        alert('ไม่สามารถดึงข้อมูลรายละเอียดได้: ' + error.message);
      }
    }
  </script>
</body>
</html>