<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>สถานะการลงทะเบียน & ประวัติการชำระเงิน</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- ไลบรารีสร้าง QR -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <!-- ไอคอน -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="icon" href="./favicon.ico">
  <style>
    .btn-cancel-reg {
      white-space: nowrap
    }

    .table td .btn-group {
      flex-wrap: wrap
    }

    .qr-hint {
      font-size: .92rem;
      color: #64748b
    }

    .swal2-html-container .mini {
      font-size: .9rem
    }

    .swal2-actions {
      gap: .5rem
    }
  </style>
</head>

<body class="p-3">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3><i class="bi bi-journal-check"></i> สถานะการลงทะเบียน & ประวัติการชำระเงิน</h3>
      <button class="btn btn-outline-primary"
        onclick="window.location.href='student_dashboard.html'">กลับหน้าหลัก</button>
    </div>

    <!-- Card แสดงสถานะปัจจุบัน -->
    <div id="currentRegCard" class="card mb-4" style="display:none;">
      <div id="currentRegHeader" class="card-header text-white">
        <strong>สถานะการลงทะเบียนปัจจุบัน</strong>
      </div>
      <div class="card-body">
        <ul id="currentRegDetail" class="mb-3"></ul>
        <div class="d-flex gap-2 flex-wrap">
          <div id="payBtn" style="display:none;"></div>
          <button id="cancelBtnCard" class="btn btn-outline-danger btn-cancel-reg" style="display:none;">
            <i class="bi bi-x-circle me-1"></i> ยกเลิกการลงทะเบียน
          </button>
        </div>
      </div>
    </div>

    <!-- ตารางประวัติ -->
    <div class="card">
      <div class="card-header bg-secondary text-white"><strong>ประวัติการลงทะเบียนและการชำระเงิน</strong></div>
      <div class="card-body table-responsive">
        <table class="table table-bordered align-middle" id="regTable">
          <thead class="table-light">
            <tr>
              <th>วันที่สอบ</th>
              <th>เวลา</th>
              <th>ครั้งที่</th>
              <th>ค่าธรรมเนียม</th>
              <th>สถานะ</th>
              <th>เลขที่อ้างอิง</th>
              <th>วันเวลาชำระเงิน</th>
              <th style="width:260px;">การดำเนินการ</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    /* ================== CONFIG ================== */
    const API_BASE = '/api/'; // โฟลเดอร์ api อยู่รากโดเมน (Hostinger)
    const token = localStorage.getItem('studentToken');
    if (!token) { window.location.href = "student_login.html"; }

    /* ================== HELPERS ================== */
    const TH_MONTHS = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
    const $ = (s) => document.querySelector(s);
    const fmtTH = (d) => d.toLocaleString('th-TH', { dateStyle: 'medium', timeStyle: 'medium' });

    function formatThaiDate(s) { if (!s) return '-'; const d = new Date(s); return isNaN(d) ? '-' : `${d.getDate()} ${TH_MONTHS[d.getMonth()]} ${d.getFullYear() + 543}`; }
    function formatTime(t) { return t?.slice(0, 5) || ''; }
    function isFutureDate(s) { const a = new Date(s); a.setHours(0, 0, 0, 0); const b = new Date(); b.setHours(0, 0, 0, 0); return a > b; }
    function daysUntil(s) { const a = new Date(s); a.setHours(0, 0, 0, 0); const b = new Date(); b.setHours(0, 0, 0, 0); return Math.floor((a - b) / (1000 * 60 * 60 * 24)); }
    function canCancel(reg) { if (['cancelled'].includes(reg.payment_status)) return false; const notPaid = ['pending', 'free'].includes(reg.payment_status); return notPaid && isFutureDate(reg.slot_date) && daysUntil(reg.slot_date) >= 3; }

    async function fetchJSON(url, opt = {}) {
      const res = await fetch(url, opt);
      const text = await res.text();
      try { return { res, data: JSON.parse(text) }; } catch { throw new Error(`HTTP ${res.status}: ${text.slice(0, 200)}`); }
    }

    /* ================== RENDER ================== */
    function actionCell(r) {
      const wrap = (h) => `<div class="btn-group" role="group">${h}</div>`;
      const st = (r.payment_status || '').toLowerCase();
      if (st === 'cancelled') return `<span class="text-muted">ถูกยกเลิกแล้ว</span>`;
      if (st === 'paid') return `<span class="text-success">ชำระแล้ว</span>`;
      if (st === 'free' || st === 'waived') return `<span class="text-info">สิทธิ์สอบฟรี</span>`;

      const payBtns = `
    <button class="btn btn-sm btn-primary" onclick="startPay(${r.registration_id})">
      <i class="bi bi-qr-code me-1"></i>ชำระเงิน
    </button>
    <a class="btn btn-sm btn-outline-primary" href="student_payment_upload.html?registration_id=${r.registration_id}">
      <i class="bi bi-upload me-1"></i>อัปโหลดสลิป
    </a>`;
      const cancelBtn = canCancel(r) && r.booking_id ? `
    <button class="btn btn-sm btn-outline-danger" onclick="cancelRegister(${r.registration_id}, ${r.booking_id})">
      <i class="bi bi-x-circle me-1"></i>ยกเลิก
    </button>` : '';
      return wrap(payBtns + cancelBtn);
    }

    function paintCurrent(reg) {
      const card = $("#currentRegCard"), hdr = $("#currentRegHeader"), ul = $("#currentRegDetail"),
        payWrap = $("#payBtn"), cancelBtn = $("#cancelBtnCard");

      card.style.display = 'block';
      hdr.className = ({
        pending: "card-header bg-warning text-dark",
        paid: "card-header bg-success text-white",
        free: "card-header bg-info text-white",
        cancelled: "card-header bg-secondary text-white"
      }[reg.payment_status] || "card-header bg-secondary text-white");

      const badge = {
        pending: '<span class="badge bg-warning text-dark">รอชำระเงิน</span>',
        paid: '<span class="badge bg-success">ชำระแล้ว</span>',
        free: '<span class="badge bg-info">ฟรี</span>',
        cancelled: '<span class="badge bg-secondary">ยกเลิกแล้ว</span>'
      }[reg.payment_status] || '<span class="badge bg-secondary">ไม่ทราบสถานะ</span>';

      ul.innerHTML = `
    <li><strong>วันที่สอบ:</strong> ${formatThaiDate(reg.slot_date)}</li>
    <li><strong>เวลา:</strong> ${formatTime(reg.start_time)} - ${formatTime(reg.end_time)}</li>
    <li><strong>ครั้งที่:</strong> ${reg.attempt_no}</li>
    <li><strong>ค่าธรรมเนียม:</strong> ${reg.fee_amount > 0 ? reg.fee_amount + ' บาท' : 'ฟรี'}</li>
    <li><strong>สถานะ:</strong> ${badge}</li>
    <li><strong>เลขที่อ้างอิง:</strong> ${reg.ref_no || '-'}</li>
    <li><strong>วันเวลาชำระเงิน:</strong> ${reg.paid_at ? fmtTH(new Date(reg.paid_at)) : '-'}</li>`;

      if (reg.payment_status === 'pending') {
        payWrap.style.display = 'block';
        payWrap.innerHTML = `
      <div class="btn-group">
        <button class="btn btn-primary" onclick="startPay(${reg.registration_id})">
          <i class="bi bi-qr-code me-1"></i>ชำระเงิน
        </button>
        <a class="btn btn-outline-primary" href="student_payment_upload.html?registration_id=${reg.registration_id}">
          <i class="bi bi-upload me-1"></i>อัปโหลดสลิป
        </a>
      </div>`;
      } else {
        payWrap.style.display = 'none'; payWrap.innerHTML = '';
      }

      if (canCancel(reg)) { cancelBtn.style.display = 'inline-block'; cancelBtn.onclick = () => cancelRegister(reg.registration_id, reg.booking_id ?? null); }
      else { cancelBtn.style.display = 'none'; cancelBtn.onclick = null; }
    }

    /* ================== LOAD LIST ================== */
    async function loadRegs() {
      try {
        const { data } = await fetchJSON(API_BASE + "get_my_registrations.php", {
          headers: { Authorization: `Bearer ${token}` }, cache: 'no-store'
        });
        const tbody = $("#regTable tbody"); tbody.innerHTML = "";

        if (data.status !== "success" || !Array.isArray(data.registrations) || !data.registrations.length) {
          $("#currentRegCard").style.display = 'none';
          tbody.innerHTML = '<tr><td colspan="8" class="text-center">ไม่พบประวัติการลงทะเบียน</td></tr>';
          return;
        }

        paintCurrent(data.registrations[0]);

        data.registrations.forEach(r => {
          const tr = document.createElement('tr');
          const badge = {
            pending: '<span class="badge bg-warning text-dark">รอชำระเงิน</span>',
            paid: '<span class="badge bg-success">ชำระแล้ว</span>',
            free: '<span class="badge bg-info">สิทธิ์ฟรี</span>',
            cancelled: '<span class="badge bg-secondary">ยกเลิกแล้ว</span>'
          }[r.payment_status] || '<span class="badge bg-secondary">ไม่ทราบสถานะ</span>';

          tr.className = ({ pending: 'table-warning', paid: 'table-success', free: 'table-info', cancelled: 'table-secondary' }[r.payment_status]) || '';
          tr.innerHTML = `
        <td>${formatThaiDate(r.slot_date)}</td>
        <td>${formatTime(r.start_time)} - ${formatTime(r.end_time)}</td>
        <td>${r.attempt_no}</td>
        <td>${r.fee_amount > 0 ? `${r.fee_amount} บาท` : 'ฟรี'}</td>
        <td>${badge}</td>
        <td>${r.ref_no || '-'}</td>
        <td>${r.paid_at ? fmtTH(new Date(r.paid_at)) : '-'}</td>
        <td>${actionCell(r)}</td>`;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        Swal.fire({ icon: 'error', title: 'โหลดข้อมูลไม่สำเร็จ', text: err.message || 'กรุณาลองใหม่อีกครั้ง' });
      }
    }

    /* ================== CANCEL ================== */
    async function cancelRegister(registrationId, bookingId = null) {
      const btn = document.activeElement?.closest('button');
      if (btn) { btn.disabled = true; btn.dataset._old = btn.innerHTML; btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>กำลังยกเลิก...'; }
      try {
        const { value: reason, isConfirmed } = await Swal.fire({
          icon: 'warning', title: 'ยกเลิกการลงทะเบียน?', showCancelButton: true,
          confirmButtonText: 'ยืนยันยกเลิก', cancelButtonText: 'ไม่ยกเลิก',
          html: `<div class="text-start mini">ต้องยกเลิกล่วงหน้าอย่างน้อย <b>3 วัน</b> ก่อนวันสอบ</div>
            <textarea id="reason" class="form-control mt-2" placeholder="เหตุผล (ไม่บังคับ)"></textarea>`,
          preConfirm: () => document.getElementById('reason').value.trim()
        });
        if (!isConfirmed) return;

        const url = (bookingId != null && bookingId !== '') ? API_BASE + 'cancel_booking.php' : API_BASE + 'cancel_registration.php';
        const body = (bookingId != null && bookingId !== '') ? { booking_id: Number(bookingId), reason } : { registration_id: Number(registrationId), reason };

        const { res, data } = await fetchJSON(url, {
          method: 'POST', headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(body)
        });
        if (!(res.ok && data.status === 'success')) throw new Error(data.message || `HTTP ${res.status}`);

        await Swal.fire({ icon: 'success', title: 'ยกเลิกสำเร็จ', timer: 1300, showConfirmButton: false });
        await loadRegs();
      } catch (e) {
        console.error(e); Swal.fire({ icon: 'error', title: 'ยกเลิกไม่สำเร็จ', text: e.message || 'โปรดลองใหม่' });
      } finally {
        if (btn) { btn.disabled = false; btn.innerHTML = btn.dataset._old || 'ยกเลิก'; delete btn.dataset._old; }
      }
    }

    /* ================== PAYMENT: CREATE + QR + POLL ================== */
    async function startPay(registrationId) {
      try {
        // เรียกสร้างรายการชำระเงิน
        const { data } = await fetchJSON(API_BASE + 'payments/create.php', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify({ registration_id: Number(registrationId) })
        });
        if (data.status !== 'success') throw new Error(data.message || 'ไม่สามารถสร้างรายการชำระเงินได้');

        // เปิด QR modal
        await showQRModal({
          payment_id: data.payment_id,
          ref_no: data.ref_no,
          amount: data.amount,
          account: data.account,          // เบอร์/เลข PromptPay ที่รับเงิน (ถ้ามี)
          payload: data.qr_payload,       // EMVCo/PromptPay payload พร้อมชำระ
          expire_at: data.expire_at       // ISO string
        });

        // โหลดใหม่หลัง modal ปิด (อาจจ่ายแล้ว)
        await loadRegs();
      } catch (err) {
        console.error(err);
        Swal.fire({ icon: 'error', title: 'เริ่มชำระเงินไม่สำเร็จ', text: err.message || 'กรุณาลองใหม่' });
      }
    }

    // Modal แสดง QR + นับถอยหลัง + ปุ่มต่าง ๆ และ Poll สถานะ
    async function showQRModal(pay) {
      let timerId = null, pollId = null;

      const html = `
    <div class="text-center">
      <div id="qrcanvaswrap" class="mb-2"><canvas id="qrCanvas" width="264" height="264"></canvas></div>
      <div class="fw-bold mb-1">จำนวนเงิน: <span id="amtText">${Number(pay.amount).toFixed(2)}</span> บาท</div>
      <div class="mini">เลขอ้างอิง: <code id="refText">${pay.ref_no}</code></div>
      <div class="mini">ชำระภายใน: <span id="countdown">--:--</span></div>
      <div class="qr-hint mt-2">สแกนด้วยแอปธนาคาร / พร้อมเพย์ เพื่อชำระเงิน</div>
    </div>`;

      const swal = await Swal.fire({
        title: 'ชำระเงินด้วย QR พร้อมเพย์',
        html, width: 420, showCancelButton: true, showConfirmButton: true,
        confirmButtonText: 'ตรวจสถานะอีกครั้ง', cancelButtonText: 'ปิด',
        didOpen: () => {
          // วาด QR
          const c = document.getElementById('qrCanvas');
          QRCode.toCanvas(c, pay.payload, { width: 264, margin: 1 }, (err) => { if (err) console.error(err); });

          // ปุ่มเสริม (คัดลอก/ดาวน์โหลด)
          const btns = Swal.getActions();
          const btnCopyRef = document.createElement('button');
          btnCopyRef.className = 'swal2-styled'; btnCopyRef.textContent = 'คัดลอกเลขอ้างอิง';
          btnCopyRef.onclick = () => navigator.clipboard?.writeText(pay.ref_no);
          const btnCopyAmt = document.createElement('button');
          btnCopyAmt.className = 'swal2-styled'; btnCopyAmt.textContent = 'คัดลอกจำนวนเงิน';
          btnCopyAmt.onclick = () => navigator.clipboard?.writeText(String(pay.amount));
          const btnDownload = document.createElement('button');
          btnDownload.className = 'swal2-styled'; btnDownload.textContent = 'ดาวน์โหลด QR';
          btnDownload.onclick = () => {
            const link = document.createElement('a');
            link.download = `QR_${pay.ref_no}.png`;
            link.href = c.toDataURL('image/png'); link.click();
          };
          const btnUpload = document.createElement('a');
          btnUpload.className = 'swal2-styled'; btnUpload.textContent = 'อัปโหลดสลิป';
          btnUpload.href = `student_payment_upload.html?ref_no=${encodeURIComponent(pay.ref_no)}`;
          btnUpload.target = '_blank';
          btns.prepend(btnUpload); btns.prepend(btnDownload); btns.prepend(btnCopyAmt); btns.prepend(btnCopyRef);

          // นับถอยหลัง
          const countdownEl = document.getElementById('countdown');
          function tick() {
            const now = new Date();
            const end = new Date(pay.expire_at || now);
            const sec = Math.max(0, Math.floor((end - now) / 1000));
            const mm = String(Math.floor(sec / 60)).padStart(2, '0');
            const ss = String(sec % 60).padStart(2, '0');
            countdownEl.textContent = `${mm}:${ss}`;
            if (sec <= 0) { clearInterval(timerId); }
          }
          tick(); timerId = setInterval(tick, 1000);

          // เริ่ม Poll สถานะทุก 4 วินาที
          pollId = setInterval(async () => {
            try {
              const q = pay.payment_id ? `payment_id=${pay.payment_id}` : `ref_no=${encodeURIComponent(pay.ref_no)}`;
              const { data } = await fetchJSON(API_BASE + `payments/status.php?${q}`, { headers: { Authorization: `Bearer ${token}` }, cache: 'no-store' });
              if (data.status === 'success' && data.payment_status === 'paid') {
                clearInterval(timerId); clearInterval(pollId);
                await Swal.fire({ icon: 'success', title: 'ชำระเงินสำเร็จ', timer: 1200, showConfirmButton: false });
                Swal.close();
              }
            } catch (e) { console.warn('poll fail', e.message); }
          }, 4000);
        },
        willClose: () => {
          if (timerId) clearInterval(timerId);
          if (pollId) clearInterval(pollId);
        }
      });

      // ถ้ากด “ตรวจสถานะอีกครั้ง”
      if (swal.isConfirmed) {
        try {
          const q = pay.payment_id ? `payment_id=${pay.payment_id}` : `ref_no=${encodeURIComponent(pay.ref_no)}`;
          const { data } = await fetchJSON(API_BASE + `payments/status.php?${q}`, { headers: { Authorization: `Bearer ${token}` }, cache: 'no-store' });
          if (data.status === 'success' && data.payment_status === 'paid') {
            await Swal.fire({ icon: 'success', title: 'ชำระเงินสำเร็จ', timer: 1200, showConfirmButton: false });
          } else {
            await Swal.fire({ icon: 'info', title: 'ยังไม่พบการชำระ', text: 'หากชำระแล้ว โปรดรอสักครู่หรือลองอัปโหลดสลิปยืนยัน' });
          }
        } catch (e) {
          await Swal.fire({ icon: 'error', title: 'ตรวจสถานะไม่สำเร็จ', text: e.message || 'กรุณาลองใหม่' });
        }
      }
    }

    /* ================== BOOT ================== */
    loadRegs();
  </script>
</body>

</html>