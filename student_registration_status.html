<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≠‡∏ö</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/css/main.css">
  <link rel="stylesheet" href="assets/css/student.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
  <link rel="icon" href="favicon.ico">
 
</head>
<body>
  <header class="course-header">
    <div class="logo-text">
            <img src="nulogo.png" alt="Logo" height="60">
            <div class="course-title">
                <h2>‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ 273252 ‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®<br>‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏ô‡πÄ‡∏£‡∏®‡∏ß‡∏£</h2>
            </div>
        </div>
    <div class="ms-auto d-flex gap-2">
      <button id="backBtn" class="btn btn-outline-primary">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
      <button id="logoutBtn" class="btn btn-outline-danger">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
  </header>
  <div class="container mt-4">
    <div class="d-flex align-items-center mb-3">
      <i class="fas fa-clipboard-list fa-2x text-primary me-2"></i>
      <h2 class="mb-0">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
    </div>
    <div id="successBanner" class="alert alert-success d-none"><b>‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</b> ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</div>
    <div class="alert alert-secondary" style="background: #f8f9fa; border: none; color: #333;">
      <b>üë©‚Äçüéì ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö!</b> ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏ï‡∏ô‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤
    </div>
    <div id="loading" class="alert alert-info" style="display: none;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
    <div id="statusArea"></div>
  </div>
  <script>
    const token = localStorage.getItem('studentToken');
    let student_id = null;
    if (token) {
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        student_id = payload.student_id;
      } catch (e) {}
    }
    document.getElementById('backBtn').onclick = () => window.location.href = 'student_dashboard.html';
    document.getElementById('logoutBtn').onclick = () => {
      localStorage.removeItem('studentToken');
      window.location.href = 'student_login.html';
    };
    async function loadStatus() {
      if (!token || !student_id) {
        document.getElementById('statusArea').innerHTML = '<div class="alert alert-danger">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>';
        return;
      }
      // ‡πÅ‡∏™‡∏î‡∏á banner ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ñ‡πâ‡∏≤‡∏°‡∏µ flag just_registered ‡πÉ‡∏ô query ‡∏´‡∏£‡∏∑‡∏≠ localStorage
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('just_registered') === '1' || localStorage.getItem('justRegistered') === '1') {
        document.getElementById('successBanner').classList.remove('d-none');
        setTimeout(() => document.getElementById('successBanner').classList.add('d-none'), 4000);
        localStorage.removeItem('justRegistered');
      }
      document.getElementById('loading').style.display = 'block';
      try {
        const res = await fetch('/walkin-exam-system/api/get_student_registration_status.php', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        let text = await res.text();
        let result;
        try { result = JSON.parse(text); } catch (e) { result = { status: 'error', message: 'Invalid JSON', raw: text }; }
        document.getElementById('loading').style.display = 'none';
        if (result.status === 'success' && result.data && result.data.length > 0) {
          // ‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (booking ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
          let latestIdx = 0;
          let latestTime = 0;
          result.data.forEach((row, idx) => {
            const t = row.scheduled_at ? new Date(row.scheduled_at).getTime() : 0;
            if (t > latestTime) { latestTime = t; latestIdx = idx; }
          });
          let html = '<div class="table-responsive"><table class="table table-striped table-bordered align-middle text-center shadow-sm"><thead class="table-primary"><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ö</th><th>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ö</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th></tr></thead><tbody>';
          result.data.forEach((row, idx) => {
            let statusColor = row.status === 'registered' ? 'text-success' : (row.status === 'completed' ? 'text-primary' : 'text-danger');
            let statusText = row.status === 'registered' ? '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : (row.status === 'completed' ? '‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' : (row.status === 'cancelled' ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' : (row.status === 'absent' ? '‡∏Ç‡∏≤‡∏î‡∏™‡∏≠‡∏ö' : '-')));
            let regDate = '-';
            if (row.scheduled_at) {
              const d = new Date(row.scheduled_at);
              if (!isNaN(d)) {
                const day = String(d.getDate()).padStart(2, '0');
                const thaiMonths = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô','‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
                const monthName = thaiMonths[d.getMonth()];
                const year = d.getFullYear();
                regDate = `${day} ${monthName} ${year}`;
              }
            }
            let slotDate = row.slot_date;
            if (slotDate && /^\d{4}-\d{2}-\d{2}/.test(slotDate)) {
              const d = new Date(slotDate);
              if (!isNaN(d)) {
                const day = String(d.getDate()).padStart(2, '0');
                const thaiMonths = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô','‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
                const monthName = thaiMonths[d.getMonth()];
                const year = d.getFullYear();
                slotDate = `${day} ${monthName} ${year}`;
              }
            }
            let actionBtn = '';
            if (row.status === 'registered') {
              // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (3 ‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏≠‡∏ö)
              const examDate = new Date(row.slot_date);
              const today = new Date();
              const diffDays = Math.ceil((examDate - today) / (1000 * 60 * 60 * 24));
              
              actionBtn = `<a href="student_exam.html?examset_id=${row.examset_id}" class="btn btn-sm btn-success">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö</a>`;
              if (diffDays >= 3) {
                actionBtn += ` <button onclick="cancelBooking(${row.id})" class="btn btn-sm btn-outline-danger ms-2">
                  <i class="fas fa-times-circle"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>`;
              } else {
                actionBtn += ` <button class="btn btn-sm btn-outline-secondary ms-2" disabled title="‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏ß‡∏±‡∏ô">
                  <i class="fas fa-lock"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>`;
              }
            } else if (row.status === 'completed') {
              actionBtn = `<a href="student_result.html?examset_id=${row.examset_id}" class="btn btn-sm btn-primary">‡∏î‡∏π‡∏ú‡∏•‡∏™‡∏≠‡∏ö</a>`;
            }
            html += `<tr${idx === latestIdx ? ' style=\"background:#e6ffe6;\"' : ''}><td>${slotDate}</td><td>${row.start_time} - ${row.end_time}</td><td>${regDate}</td><td class=\"${statusColor}\"><b>${statusText}</b></td><td>${actionBtn}</td></tr>`;
          });
          html += '</tbody></table></div>';
          document.getElementById('statusArea').innerHTML = html;
        } else {
          document.getElementById('statusArea').innerHTML = `<div class="alert alert-warning text-center p-4"><i class='fas fa-info-circle fa-2x mb-2'></i><br>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≠‡∏ö</div>`;
        }
      } catch (err) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('statusArea').innerHTML = '<div class="alert alert-danger">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err + '</div>';
      }
    }
    document.addEventListener('DOMContentLoaded', loadStatus);
  // ‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡∏à‡∏≤‡∏Å register_exam.html ‡πÉ‡∏´‡πâ set flag justRegistered
  if (document.referrer && document.referrer.includes('register_exam.html')) {
    localStorage.setItem('justRegistered', '1');
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
  async function cancelBooking(bookingId) {
    if (!bookingId) {
      alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á');
      return;
    }
    
    if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;

    console.log('Token:', token);
    console.log('Student ID:', student_id);
    console.log('Booking ID:', bookingId);

    try {
      const res = await fetch('/walkin-exam-system/api/cancel_booking.php', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}` // ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà Bearer prefix
        },
        body: JSON.stringify({
          booking_id: bookingId,
          student_id: student_id
        })
      });

      const text = await res.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch (e) {
        console.error('Invalid JSON response:', text);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
        return;
      }

      if (!res.ok) {
        alert(data.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å');
        return;
      }

      alert(data.message || '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      if (data.status === 'success') {
        loadStatus(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
      }
    } catch (err) {
      console.error('Error:', err);
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
    }
  }
  </script>
</body>
</html>
