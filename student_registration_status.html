<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô & ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="p-3">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3><i class="fas fa-list-check"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô & ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
      <button class="btn btn-outline-primary" onclick="window.location.href='student_dashboard.html'">
        ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
      </button>
    </div>

    <!-- üîπ Current Registration -->
    <div class="card mb-4">
      <div class="card-header bg-info text-white">
        ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
      </div>
      <div class="card-body" id="currentReg">
        <p class="text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
      </div>
    </div>

    <!-- üîπ History -->
    <div class="card">
      <div class="card-header bg-secondary text-white">
        ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
      </div>
      <div class="card-body table-responsive">
        <table class="table table-bordered" id="regTable">
          <thead class="table-light">
            <tr>
              <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ö</th>
              <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
              <th>‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà</th>
              <th>‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°</th>
              <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á</th>
              <th>‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"></script>
<script>
const token = localStorage.getItem('studentToken');
if(!token){ window.location.href="student_login.html"; }

function formatThaiDate(dateStr) {
  const d = new Date(dateStr);
  const months = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
    '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
  return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear() + 543}`;
}

function formatTime(timeStr) { 
  return timeStr?.slice(0,5) || ''; 
}

async function loadRegs(){
  try {
    const res = await fetch("api/get_my_registrations.php",{
      headers:{Authorization:`Bearer ${token}`}
    });
    const data = await res.json();

    // --- Current registration ---
    const currentBox = document.getElementById("currentReg");
    if(data.status==="success" && data.current){
      const r = data.current;
      const status = {
        'pending': '<span class="badge bg-warning">‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</span>',
        'paid': '<span class="badge bg-success">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</span>',
        'free': '<span class="badge bg-info">‡∏ü‡∏£‡∏µ</span>'
      }[r.payment_status] || r.payment_status;

      currentBox.innerHTML = `
        <ul>
          <li><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ö:</strong> ${formatThaiDate(r.slot_date)}</li>
          <li><strong>‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${formatTime(r.start_time)} - ${formatTime(r.end_time)}</li>
          <li><strong>‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà:</strong> ${r.attempt_no}</li>
          <li><strong>‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°:</strong> ${r.fee_amount > 0 ? r.fee_amount + ' ‡∏ö‡∏≤‡∏ó' : '‡∏ü‡∏£‡∏µ'}</li>
          <li><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ${status}</li>
        </ul>
        ${r.payment_status==="pending"
          ? `<button class="btn btn-sm btn-primary" onclick="payNow(${r.registration_id})">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>`
          : ""}`;
    } else {
      currentBox.innerHTML = '<p class="text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≠‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>';
    }

    // --- History ---
    const tbody = document.querySelector("#regTable tbody");
    tbody.innerHTML="";
    if(data.status==="success" && data.registrations.length){
      data.registrations.forEach(r=>{
        const status = {
          'pending': '<span class="badge bg-warning">‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</span>',
          'paid': '<span class="badge bg-success">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</span>',
          'free': '<span class="badge bg-info">‡∏ü‡∏£‡∏µ</span>'
        }[r.payment_status] || r.payment_status;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${formatThaiDate(r.slot_date)}</td>
          <td>${formatTime(r.start_time)} - ${formatTime(r.end_time)}</td>
          <td>${r.attempt_no}</td>
          <td>${r.fee_amount > 0 ? r.fee_amount + ' ‡∏ö‡∏≤‡∏ó' : '‡∏ü‡∏£‡∏µ'}</td>
          <td>${status}</td>
          <td>${r.ref_no || '-'}</td>
          <td>
            ${r.payment_status==="pending"
              ? `<button class="btn btn-sm btn-primary" onclick="payNow(${r.registration_id})">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>`
              : r.payment_status==="paid"
                ? `<span class="text-success">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß ${r.paid_at ? '('+ new Date(r.paid_at).toLocaleString('th-TH') +')' : ''}</span>`
                : `<span class="text-info">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≠‡∏ö‡∏ü‡∏£‡∏µ</span>`}
          </td>`;
        tbody.appendChild(tr);
      });
    } else {
      tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</td></tr>';
    }

  } catch (err) {
    console.error(err);
    Swal.fire({
      icon: 'error',
      title: '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'
    });
  }
}

async function payNow(regId){
  const {value: ref, isConfirmed} = await Swal.fire({
    title: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô",
    input: "text",
    inputLabel: "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô/‡∏™‡∏•‡∏¥‡∏õ",
    inputPlaceholder: "‡∏Å‡∏£‡∏≠‡∏Å Ref No.",
    showCancelButton: true,
    confirmButtonText: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô",
    cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å",
    inputValidator: (value) => {
      if (!value) return "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á";
    }
  });

  if (!isConfirmed) return;

  try {
    const res = await fetch("api/pay_registration.php", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({registration_id: regId, ref_no: ref})
    });
    const data = await res.json();
    if(data.status==="success"){
      await Swal.fire({icon:"success",title:"‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",text:`‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á: ${data.ref_no}`,timer:2000});
      await loadRegs();
    } else {
      throw new Error(data.message);
    }
  } catch (err) {
    console.error(err);
    Swal.fire({icon:"error",title:"‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",text:err.message || "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"});
  }
}

loadRegs();
</script>
</body>
</html>
