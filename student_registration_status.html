<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>สถานะการลงทะเบียน & ประวัติการชำระเงิน</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="icon" href="./favicon.ico">
  <style>
    .btn-cancel-reg {
      white-space: nowrap
    }

    .table td .btn-group {
      flex-wrap: wrap
    }
  </style>
</head>

<body class="p-3">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3><i class="bi bi-journal-check"></i> สถานะการลงทะเบียน & ประวัติการชำระเงิน</h3>
      <button class="btn btn-outline-primary"
        onclick="window.location.href='student_dashboard.html'">กลับหน้าหลัก</button>
    </div>

    <!-- การ์ดสถานะปัจจุบัน -->
    <div id="currentRegCard" class="card mb-4" style="display:none;">
      <div id="currentRegHeader" class="card-header text-white">
        <strong>สถานะการลงทะเบียนปัจจุบัน</strong>
      </div>
      <div class="card-body">
        <ul id="currentRegDetail" class="mb-3"></ul>
        <div class="d-flex gap-2 flex-wrap">
          <div id="payBtn" style="display:none;"></div>
          <button id="cancelBtnCard" class="btn btn-outline-danger btn-cancel-reg" style="display:none;">
            <i class="bi bi-x-circle me-1"></i> ยกเลิกการลงทะเบียน
          </button>
        </div>
      </div>
    </div>

    <!-- ตารางประวัติ -->
    <div class="card">
      <div class="card-header bg-secondary text-white">
        <strong>ประวัติการลงทะเบียนและการชำระเงิน</strong>
      </div>
      <div class="card-body table-responsive">
        <table class="table table-bordered align-middle" id="regTable">
          <thead class="table-light">
            <tr>
              <th>วันที่สอบ</th>
              <th>เวลา</th>
              <th>ครั้งที่</th>
              <th>ค่าธรรมเนียม</th>
              <th>สถานะ</th>
              <th>เลขที่อ้างอิง</th>
              <th>วันเวลาชำระเงิน</th>
              <th style="width:260px;">การดำเนินการ</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const API_BASE = '/api/';                 // Hostinger อยู่รากโดเมน
    const token = localStorage.getItem('studentToken');
    if (!token) location.href = 'student_login.html';

    // ===== Helpers =====
    const TH_MONTHS = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
    const $ = (sel) => document.querySelector(sel);

    function formatThaiDate(isoDate) {
      if (!isoDate) return '-';
      const d = new Date(isoDate); if (isNaN(d)) return '-';
      return `${d.getDate()} ${TH_MONTHS[d.getMonth()]} ${d.getFullYear() + 543}`;
    }
    const formatTime = (t) => t?.slice(0, 5) || '';
    function isFuture(dateStr) { const t = new Date(); t.setHours(0, 0, 0, 0); const d = new Date(dateStr); d.setHours(0, 0, 0, 0); return d > t; }
    function daysUntil(dateStr) { const t = new Date(); t.setHours(0, 0, 0, 0); const d = new Date(dateStr); d.setHours(0, 0, 0, 0); return Math.floor((d - t) / (1000 * 60 * 60 * 24)); }

    function canCancel(reg) {
      if (reg.payment_status === 'cancelled' || reg.booking_status === 'cancelled') return false;
      const notPaid = (reg.payment_status === 'pending' || reg.payment_status === 'free');
      const d = daysUntil(reg.slot_date);
      return notPaid && d >= 3 && isFuture(reg.slot_date);
    }

    function renderActionsCell(r) {
      const wrap = (h) => `<div class="btn-group" role="group">${h}</div>`;
      const status = (r.payment_status || '').toLowerCase();
      if (status === 'cancelled') return `<span class="text-muted">ถูกยกเลิกแล้ว</span>`;
      if (status === 'paid') return `<span class="text-success">ชำระแล้ว</span>`;
      if (status === 'free' || status === 'waived') return `<span class="text-info">สิทธิ์สอบฟรี</span>`;

      const payBtns = `
      <button class="btn btn-sm btn-primary" onclick="startPay(${r.registration_id})">
        <i class="bi bi-credit-card me-1"></i>ชำระเงิน
      </button>`;
      if (canCancel(r) && r.booking_id) {
        const cancelBtn = `
        <button class="btn btn-sm btn-outline-danger" onclick="cancelRegister(${r.registration_id}, ${r.booking_id})">
          <i class="bi bi-x-circle me-1"></i>ยกเลิก
        </button>`;
        return wrap(payBtns + cancelBtn);
      }
      return wrap(payBtns);
    }

    async function fetchJSON(url, opt = {}) {
      const res = await fetch(url, opt);
      const text = await res.text();
      try { return { res, data: JSON.parse(text) }; }
      catch { throw new Error(`HTTP ${res.status}: ${text.slice(0, 200)}`); }
    }

    // ===== MAIN =====
    async function loadRegs() {
      try {
        const { data } = await fetchJSON(API_BASE + 'get_my_registrations.php', {
          headers: { Authorization: `Bearer ${token}` }, cache: 'no-store'
        });
        const tbody = $("#regTable tbody"); tbody.innerHTML = '';
        if (data.status !== 'success' || !data.registrations?.length) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center">ไม่พบประวัติการลงทะเบียน</td></tr>';
          $("#currentRegCard").style.display = 'none';
          return;
        }

        // แสดงรายการล่าสุดบนการ์ด
        showCurrentReg(data.registrations[0]);

        data.registrations.forEach(r => {
          const tr = document.createElement('tr');
          const badge = {
            pending: '<span class="badge bg-warning text-dark">รอชำระเงิน</span>',
            paid: '<span class="badge bg-success">ชำระแล้ว</span>',
            free: '<span class="badge bg-info">สิทธิ์ฟรี</span>',
            cancelled: '<span class="badge bg-secondary">ยกเลิกแล้ว</span>'
          }[r.payment_status] || '<span class="badge bg-secondary">ไม่ทราบสถานะ</span>';

          tr.className = ({
            pending: 'table-warning', paid: 'table-success', free: 'table-info', cancelled: 'table-secondary'
          }[r.payment_status] || '');

          tr.innerHTML = `
          <td>${formatThaiDate(r.slot_date)}</td>
          <td>${formatTime(r.start_time)} - ${formatTime(r.end_time)}</td>
          <td>${r.attempt_no}</td>
          <td>${r.fee_amount > 0 ? r.fee_amount + ' บาท' : 'ฟรี'}</td>
          <td>${badge}</td>
          <td>${r.ref_no || '-'}</td>
          <td>${r.paid_at ? new Date(r.paid_at).toLocaleString('th-TH') : '-'}</td>
          <td>${renderActionsCell(r)}</td>`;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        Swal.fire({ icon: 'error', title: 'โหลดข้อมูลไม่สำเร็จ', text: err.message || 'กรุณาลองใหม่อีกครั้ง' });
      }
    }

    function showCurrentReg(reg) {
      const card = $("#currentRegCard"), detail = $("#currentRegDetail"), pay = $("#payBtn"), header = $("#currentRegHeader"), cancel = $("#cancelBtnCard");
      card.style.display = 'block';
      header.className = ({
        pending: "card-header bg-warning text-dark",
        paid: "card-header bg-success text-white",
        free: "card-header bg-info text-white",
        cancelled: "card-header bg-secondary text-white"
      }[reg.payment_status] || "card-header bg-secondary text-white");

      const badge = {
        pending: '<span class="badge bg-warning text-dark">รอชำระเงิน</span>',
        paid: '<span class="badge bg-success">ชำระแล้ว</span>',
        free: '<span class="badge bg-info">ฟรี</span>',
        cancelled: '<span class="badge bg-secondary">ยกเลิกแล้ว</span>'
      }[reg.payment_status] || '<span class="badge bg-secondary">ไม่ทราบสถานะ</span>';

      detail.innerHTML = `
      <li><strong>วันที่สอบ:</strong> ${formatThaiDate(reg.slot_date)}</li>
      <li><strong>เวลา:</strong> ${formatTime(reg.start_time)} - ${formatTime(reg.end_time)}</li>
      <li><strong>ครั้งที่:</strong> ${reg.attempt_no}</li>
      <li><strong>ค่าธรรมเนียม:</strong> ${reg.fee_amount > 0 ? reg.fee_amount + ' บาท' : 'ฟรี'}</li>
      <li><strong>สถานะ:</strong> ${badge}</li>
      <li><strong>เลขที่อ้างอิง:</strong> ${reg.ref_no || '-'}</li>
      <li><strong>วันเวลาชำระเงิน:</strong> ${reg.paid_at ? new Date(reg.paid_at).toLocaleString('th-TH') : '-'}</li>`;

      if (reg.payment_status === 'pending') {
        pay.style.display = 'block';
        pay.innerHTML = `
        <div class="btn-group">
          <button class="btn btn-primary" onclick="startPay(${reg.registration_id})">
            <i class="bi bi-credit-card me-1"></i>ชำระเงิน
          </button>
        </div>`;
      } else {
        pay.style.display = 'none'; pay.innerHTML = '';
      }

      if (canCancel(reg)) {
        cancel.style.display = 'inline-block';
        cancel.onclick = () => cancelRegister(reg.registration_id, reg.booking_id ?? null);
      } else {
        cancel.style.display = 'none'; cancel.onclick = null;
      }
    }

    // ===== CANCEL =====
    async function cancelRegister(registrationId, bookingId = null) {
      const btn = document.activeElement?.closest('button');
      if (btn) { btn.disabled = true; btn.dataset._t = btn.innerHTML; btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>กำลังยกเลิก...'; }
      try {
        const { value: reason, isConfirmed } = await Swal.fire({
          icon: 'warning', title: 'ยกเลิกการลงทะเบียน?', html: `<div class="text-start">ต้องยกเลิกล่วงหน้าอย่างน้อย <b>3 วัน</b><br><label class="form-label mt-2">เหตุผล (ไม่บังคับ)</label><textarea id="reason" class="form-control" rows="3"></textarea></div>`,
          showCancelButton: true, confirmButtonText: 'ยืนยันยกเลิก', cancelButtonText: 'ไม่ยกเลิก',
          preConfirm: () => (document.getElementById('reason')?.value ?? '').trim()
        });
        if (!isConfirmed) return;

        const url = (bookingId != null && bookingId !== '') ? API_BASE + 'cancel_booking.php' : API_BASE + 'cancel_registration.php';
        const body = (bookingId != null && bookingId !== '') ? { booking_id: Number(bookingId), reason } : { registration_id: Number(registrationId), reason };

        const { res, data } = await fetchJSON(url, {
          method: 'POST', headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify(body), cache: 'no-store'
        });

        const msg = (data?.message || data?.msg || '').toString();
        const ok = (res.ok && data.status === 'success') || /already\s*cancel/i.test(msg) || /success/i.test(msg);
        if (!ok) throw new Error(msg || `ยกเลิกไม่สำเร็จ (HTTP ${res.status})`);

        await Swal.fire({ icon: 'success', title: /already\s*cancel/i.test(msg) ? 'ยกเลิกไว้ก่อนแล้ว' : 'ยกเลิกสำเร็จ', timer: 1400, showConfirmButton: false });
        await loadRegs();
      } catch (e) {
        console.error(e);
        Swal.fire({ icon: 'error', title: 'ยกเลิกไม่สำเร็จ', text: e.message || 'โปรดลองใหม่' });
      } finally {
        if (btn) { btn.disabled = false; if (btn.dataset._t) btn.innerHTML = btn.dataset._t; delete btn.dataset._t; }
      }
    }

    // ===== PAYMENT (QR) =====
    async function startPay(registrationId) {
      try {
        const { res, data } = await fetchJSON(API_BASE + 'payments/create.php?dbg=1', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify({ registration_id: Number(registrationId) }),
          cache: 'no-store'
        });
        if (!res.ok || data.status !== 'success') {
          throw new Error(data?.message || `HTTP ${res.status}`);
        }

        const amount = data.amount ?? 0;
        const ref = data.ref_no || '-';
        const qrImg = data.qr?.image_url || '';
        const payload = data.qr?.payload || '';

        await Swal.fire({
          title: 'ชำระเงินด้วย QR พร้อมเพย์',
          html: `
          <div class="text-start mb-2">
            <div><b>จำนวนเงิน:</b> ${amount} บาท</div>
            <div><b>เลขที่อ้างอิง:</b> ${ref}</div>
          </div>
          <div class="d-flex justify-content-center mb-2">
            ${qrImg ? `<img alt="QR" src="${qrImg}" style="width:240px;height:240px;border:1px solid #eee;border-radius:8px">` : ''}
          </div>
          <div class="small text-muted" style="word-break:break-all">${payload ? 'Payload: ' + payload : ''}</div>
          <hr class="my-2">
          <div class="alert alert-info py-2">
            <div class="mb-1"><b>หลังโอนแล้ว</b> กรุณาอัปโหลดสลิปเพื่อยืนยันการชำระ</div>
            <a class="btn btn-outline-primary btn-sm" href="student_payment_upload.html?registration_id=${registrationId}">
              <i class="bi bi-upload me-1"></i> ไปหน้าอัปโหลดสลิป
            </a>
          </div>
        `,
          width: 480,
          showConfirmButton: true,
          confirmButtonText: 'ปิด',
        });

        // โหลดตารางใหม่ (เผื่อ backend mark pending แล้ว)
        await loadRegs();

      } catch (err) {
        console.error(err);
        Swal.fire({ icon: 'error', title: 'เริ่มชำระเงินไม่สำเร็จ', text: err.message || 'กรุณาลองใหม่' });
      }
    }

    // boot
    loadRegs();
  </script>
</body>

</html>