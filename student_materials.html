<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="utf-8" />
    <title>เอกสารประกอบรายวิชา – นิสิต</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css" rel="stylesheet">
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="assets/css/student-materials.css">

    <!-- Bootstrap (optional) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

</head>

<body class="student-materials">
    <header class="course-header">
        <div class="logo-text">
            <img src="nulogo.png" alt="NU Logo">
            <div class="course-title">
                <h2>เอกสารประกอบรายวิชา – นิสิต</h2>
            </div>
        </div>
        <div class="right">
            <button id="backBtn" class="btn btn-outline-light btn-sm d-inline-flex align-items-center gap-1"
                title="กลับไปแดชบอร์ดนิสิต" aria-label="กลับไปแดชบอร์ดนิสิต">
                <i class="fa-solid fa-arrow-left-long"></i>
                <span>กลับหน้าหลัก</span>
            </button>
            <button class="btn btn-danger btn-sm" id="logoutBtn">ออกจากระบบ</button>
        </div>
    </header>

    <div class="wrapper">
        <div class="grid">
            <!-- LEFT -->
            <section class="panel">
                <h3><i class="fa-solid fa-book-open me-2"></i>เอกสารรายวิชา</h3>
                <div class="content">
                    <div id="loadingState">กำลังโหลดเอกสาร...</div>
                    <div id="emptyState" style="display:none">ยังไม่มีไฟล์</div>
                    <ul id="materialsList" class="mat-list"></ul>
                </div>
            </section>

            <!-- RIGHT -->
            <section class="panel">
                <h3><i class="fa-solid fa-file-pdf me-2"></i>ตัวแสดงเอกสาร</h3>
                <div class="content viewer">

                    <!-- ✅ ใส่ canvas จริง -->
                    <div class="canvas-wrap">
                        <canvas id="pdfCanvas" aria-label="ตัวแสดงไฟล์ PDF"></canvas>
                    </div>

                    <div class="d-flex justify-content-between align-items-center">
                        <div class="pill"><i class="fa-regular fa-file-pdf"></i> <span
                                id="pageInfo">ยังไม่เปิดไฟล์</span></div>
                        <div class="d-flex gap-1">
                            <button type="button" class="btn btn-soft" id="prevPage" title="หน้าก่อนหน้า"
                                aria-label="หน้าก่อนหน้า"><i class="fa-solid fa-chevron-left"></i></button>
                            <button type="button" class="btn btn-soft" id="nextPage" title="หน้าถัดไป"
                                aria-label="หน้าถัดไป"><i class="fa-solid fa-chevron-right"></i></button>
                            <button type="button" class="btn btn-soft" id="zoomOut" title="ซูมออก"
                                aria-label="ซูมออก"><i class="fa-solid fa-magnifying-glass-minus"></i></button>
                            <button type="button" class="btn btn-soft" id="zoomIn" title="ซูมเข้า"
                                aria-label="ซูมเข้า"><i class="fa-solid fa-magnifying-glass-plus"></i></button>
                        </div>
                    </div>

                    <div class="panel panel--ghost">
                        <div class="content tts">
                            <div class="tts-row">
                                <button type="button" class="btn btn-soft primary" id="ttsPlay"><i
                                        class="fa-solid fa-play"></i> เล่นเสียงหน้านี้</button>
                                <button type="button" class="btn btn-soft" id="ttsPause"><i
                                        class="fa-solid fa-pause"></i> พัก</button>
                                <button type="button" class="btn btn-soft" id="ttsResume"><i
                                        class="fa-solid fa-play"></i> ต่อ</button>
                                <button type="button" class="btn btn-soft" id="ttsStop"><i class="fa-solid fa-stop"></i>
                                    หยุดทั้งหมด</button>
                            </div>

                            <div class="tts-row">
                                <label for="voiceSelect" class="form-label me-2 mb-0">เลือกเสียง</label>
                                <select id="voiceSelect" class="form-select form-select-sm"
                                    aria-label="เลือกเสียงสำหรับอ่านออกเสียง"></select>
                                <span class="badge-note">แนะนำเลือกเสียงภาษาไทย (th-TH)</span>
                            </div>

                            <div class="tts-row">
                                <label for="rateRange" class="form-label me-2 mb-0">ความเร็ว</label>
                                <input type="range" id="rateRange" min="0.6" max="1.6" step="0.1" value="1.0"
                                    aria-label="ปรับความเร็วการอ่าน">
                                <span id="rateVal" class="pill"><i
                                        class="fa-solid fa-gauge-high"></i><span>1.0x</span></span>
                            </div>

                            <div class="tts-row">
                                <label for="pitchRange" class="form-label me-2 mb-0">โทนเสียง</label>
                                <input type="range" id="pitchRange" min="0.7" max="1.4" step="0.1" value="1.0"
                                    aria-label="ปรับโทนเสียง">
                                <span id="pitchVal" class="pill"><i
                                        class="fa-solid fa-sliders"></i><span>1.0</span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        // ===== Base paths (โปรเจกต์อยู่ที่ public_html) =====
        const BASE_URL = location.origin;               // https://slateblue-wildcat-210524.hostingersite.com
        const API_BASE = BASE_URL + '/api';
        const MATERIALS_DIR = BASE_URL + '/uploads/materials';

        // ===== pdf.js =====
        pdfjsLib.GlobalWorkerOptions.workerSrc =
            'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // ------- pdf.js state -------
        let pdfDoc = null, pageNum = 1, scale = 1.25, rendering = false, pending = null;
        let canvas, ctx;

        // ===== helpers =====
        const $ = (s, r = document) => r.querySelector(s);
        const $$ = (s, r = document) => [...r.querySelectorAll(s)];

        const listEl = $('#materialsList');
        const emptyEl = $('#emptyState');
        const loadingEl = $('#loadingState');

        function on(id, ev, fn) {
            const el = document.getElementById(id);
            if (!el) { console.warn('missing element:', id); return; }
            el.addEventListener(ev, fn);
        }

        function escapeHTML(s) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
            return String(s ?? '').replace(/[&<>"']/g, ch => map[ch]);
        }

        // สร้าง/อ้างอิง canvas ให้แน่ใจว่ามีใน DOM
        function ensureCanvas() {
            canvas = document.getElementById('pdfCanvas');
            if (!canvas) {
                canvas = document.createElement('canvas');
                canvas.id = 'pdfCanvas';
                (document.getElementById('viewerPane') || document.body).appendChild(canvas);
            }
            ctx = canvas.getContext('2d');
        }

        // ประกอบ URL ไฟล์เอกสารให้ถูกกับโฮสต์จริง
        function materialUrl(filenameOrPath) {
            if (!filenameOrPath) return '';
            // absolute URL
            if (/^https?:\/\//i.test(filenameOrPath)) return filenameOrPath;
            // พาธในเว็บ (เช่น "uploads/materials/xxx.pdf" หรือ "/uploads/materials/xxx.pdf")
            if (filenameOrPath.includes('/')) {
                const cleaned = filenameOrPath.replace(/^\/+/, '');
                return `${BASE_URL}/${cleaned.split('/').map(encodeURIComponent).join('/')}`;
            }
            // ชื่อไฟล์ล้วน
            return `${MATERIALS_DIR}/${encodeURIComponent(filenameOrPath)}`;
        }

        // ===== materials =====
        async function fetchMaterials() {
            const token = localStorage.getItem('studentToken');
            if (!token) { location.href = 'student_login.html'; return; }

            const url = `${API_BASE}/student_get_materials.php`;
            let res, text, data;

            try {
                res = await fetch(url, {
                    headers: {
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    cache: 'no-store'
                });
            } catch (netErr) {
                console.error('NETWORK_ERROR', netErr);
                alert('เชื่อมต่อไม่สำเร็จ: ' + (netErr?.message || 'NETWORK_ERROR'));
                return;
            }

            text = await res.text();
            try {
                data = JSON.parse(text);
            } catch (e) {
                console.error('BAD_JSON', { status: res.status, text });
                alert(`โหลดเอกสารล้มเหลว (HTTP ${res.status})`);
                return;
            }

            if (res.status === 401 || res.status === 403) {
                alert(data?.message || 'หมดเวลาการใช้งาน กรุณาเข้าสู่ระบบใหม่');
                localStorage.removeItem('studentToken');
                location.href = 'student_login.html';
                return;
            }

            if (!res.ok || data.status !== 'success') {
                console.error('API_ERROR', { status: res.status, data });
                alert(data?.message || `โหลดเอกสารล้มเหลว (HTTP ${res.status})`);
                return;
            }

            const rows = Array.isArray(data.data) ? data.data
                : (Array.isArray(data.materials) ? data.materials : []);
            renderMaterials(rows);
        }

        function normalizeMaterial(r) {
            const title = r.title || r.name || r.filename || `เอกสาร #${r.id ?? r.material_id ?? ''}`;
            const filename = r.filename || r.file || r.file_path || '';
            const url = r.file_url || r.download_url || materialUrl(filename);

            const mime = String(r.file_type || r.type || '').toLowerCase();
            const ext = (filename.split('.').pop() || '').toLowerCase();
            const isPdf = mime.includes('pdf') || ext === 'pdf' || /\.pdf($|\?)/i.test(url);

            const uploaded = r.upload_date || r.uploaded_at || r.created_at || '';
            return {
                id: r.id ?? r.material_id ?? null,
                title, filename, url, uploadedAt: uploaded, mime, ext, isPdf
            };
        }

        function renderMaterials(rows) {
            loadingEl && (loadingEl.style.display = 'none');
            listEl.innerHTML = '';

            const items = rows.map(normalizeMaterial).filter(m => !!m.url);
            if (!items.length) { emptyEl && (emptyEl.style.display = 'block'); return; }
            emptyEl && (emptyEl.style.display = 'none');

            items.forEach(m => {
                const li = document.createElement('li');
                li.className = 'mat-item mb-2';

                const meta = document.createElement('div');
                meta.className = 'meta';

                const title = document.createElement('div');
                title.className = 'mat-title';
                title.textContent = m.title || '';
                meta.appendChild(title);

                const sub = document.createElement('div');
                sub.className = 'mat-sub';
                sub.innerHTML = `
        <i class="fa-regular fa-clock me-1"></i>${escapeHTML(m.uploadedAt || '-')}
        &nbsp;•&nbsp;<i class="fa-regular fa-file-lines me-1"></i>${escapeHTML((m.mime || m.ext || '').toUpperCase())}
      `;
                meta.appendChild(sub);

                const act = document.createElement('div');
                act.className = 'mat-actions';

                // ปุ่ม "เปิด" เฉพาะ PDF
                if (m.isPdf) {
                    const openBtn = document.createElement('button');
                    openBtn.className = 'btn-soft primary';
                    openBtn.innerHTML = `<i class="fa-solid fa-eye"></i> เปิด`;
                    openBtn.addEventListener('click', () => openPdf(m.url, m.title));
                    act.appendChild(openBtn);
                }

                // ปุ่มดาวน์โหลด (ทุกชนิดไฟล์)
                const dl = document.createElement('a');
                dl.className = 'btn-soft dl';
                dl.href = m.url;
                dl.setAttribute('download', '');
                dl.innerHTML = `<i class="fa-solid fa-download"></i> ดาวน์โหลด`;
                act.appendChild(dl);

                li.appendChild(meta);
                li.appendChild(act);
                listEl.appendChild(li);
            });
        }

        // ===== PDF viewer =====
        async function openPdf(url, title = '') {
            stopAllSpeech();
            const pageInfo = document.getElementById('pageInfo');
            if (pageInfo) pageInfo.textContent = 'กำลังโหลด…';

            ensureCanvas();

            try {
                // เช็คไฟล์มีจริงก่อน (กัน MissingPDFException)
                const head = await fetch(url, { method: 'HEAD', cache: 'no-store' });
                if (!head.ok) throw new Error(`ไม่พบไฟล์: ${url}`);

                pdfDoc = await pdfjsLib.getDocument({ url, withCredentials: true }).promise;
                pageNum = 1; scale = 1.25;
                renderPage(pageNum);
            } catch (e) {
                if (pageInfo) pageInfo.textContent = 'โหลดไฟล์ไม่สำเร็จ';
                console.error(e);
            }
        }

        function renderPage(num) {
            rendering = true;
            pdfDoc.getPage(num).then(page => {
                const viewport = page.getViewport({ scale });
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                page.render({ canvasContext: ctx, viewport }).promise.then(() => {
                    rendering = false;
                    const pageInfo = document.getElementById('pageInfo');
                    if (pageInfo) pageInfo.textContent = `หน้า ${pageNum} / ${pdfDoc.numPages}`;
                    if (pending !== null) { renderPage(pending); pending = null; }
                });
            });
        }
        function queueRender(num) { rendering ? (pending = num) : renderPage(num); }
        function onPrev() { if (!pdfDoc || pageNum <= 1) return; pageNum--; queueRender(pageNum); stopAllSpeech(); }
        function onNext() { if (!pdfDoc || pageNum >= pdfDoc.numPages) return; pageNum++; queueRender(pageNum); stopAllSpeech(); }
        function onZoomIn() { if (!pdfDoc) return; scale = Math.min(scale + 0.1, 2.5); queueRender(pageNum); }
        function onZoomOut() { if (!pdfDoc) return; scale = Math.max(scale - 0.1, 0.6); queueRender(pageNum); }

        // ===== TTS =====
        const voiceSelect = $('#voiceSelect');
        const rateRange = $('#rateRange');
        const pitchRange = $('#pitchRange');
        const rateVal = $('#rateVal span');
        const pitchVal = $('#pitchVal span');

        let voices = [];
        function loadVoices() {
            voices = speechSynthesis.getVoices();
            if (voiceSelect) {
                voiceSelect.innerHTML = '';
                voices
                    .sort((a, b) => (a.lang || '').localeCompare(b.lang || '') || (a.name || '').localeCompare(b.name || ''))
                    .forEach((v, i) => {
                        const opt = document.createElement('option');
                        opt.value = String(i);
                        opt.textContent = `${v.name} – ${v.lang}`;
                        voiceSelect.appendChild(opt);
                    });
                const idxTh = voices.findIndex(v => (v.lang || '').toLowerCase().startsWith('th'));
                voiceSelect.value = idxTh >= 0 ? String(idxTh) : '0';
            }
        }
        function chunkText(text, size = 220) {
            const out = [], n = text.length; let i = 0, buf = '';
            while (i < n) { buf += text[i]; if (buf.length >= size && /[\s\.\,\!\?]/.test(text[i])) { out.push(buf.trim()); buf = ''; } i++; }
            if (buf.trim()) out.push(buf.trim());
            return out;
        }
        function speakText(text) {
            speechSynthesis.cancel();
            if (!text) return;
            const sel = voices[Number(voiceSelect?.value)] || voices[0];
            chunkText(text).forEach(part => {
                const u = new SpeechSynthesisUtterance(part);
                if (sel) u.voice = sel;
                u.rate = Number(rateRange?.value) || 1.0;
                u.pitch = Number(pitchRange?.value) || 1.0;
                speechSynthesis.speak(u);
            });
        }
        function stopAllSpeech() { speechSynthesis.cancel(); }

        function smartBack() {
            try { stopAllSpeech?.(); } catch { }
            const fallback = 'student_dashboard.html';
            const ref = document.referrer || '';
            try {
                const sameOrigin = ref && new URL(ref, location.href).origin === location.origin;
                if (history.length > 1 && sameOrigin) {
                    history.back();
                    setTimeout(() => { if (!document.hidden) location.href = fallback; }, 400);
                    return;
                }
            } catch { }
            location.href = fallback;
        }

        // ===== boot =====
        document.addEventListener('DOMContentLoaded', () => {
            ensureCanvas();

            // ปุ่มควบคุม viewer
            on('prevPage', 'click', onPrev);
            on('nextPage', 'click', onNext);
            on('zoomIn', 'click', onZoomIn);
            on('zoomOut', 'click', onZoomOut);

            // TTS controls
            on('ttsPlay', 'click', async () => {
                if (!pdfDoc) return;
                const p = await pdfDoc.getPage(pageNum);
                const t = await p.getTextContent();
                const txt = t.items.map(i => i.str).join(' ').replace(/\s+/g, ' ').trim();
                if (!txt) return alert('ไม่พบข้อความในหน้านี้');
                speakText(txt);
            });
            on('ttsPause', 'click', () => { if (speechSynthesis.speaking) speechSynthesis.pause(); });
            on('ttsResume', 'click', () => { if (speechSynthesis.paused) speechSynthesis.resume(); });
            on('ttsStop', 'click', stopAllSpeech);

            on('backBtn', 'click', smartBack);
            window.addEventListener('keydown', (e) => {
                if ((e.key === 'b' || e.key === 'B') && e.altKey && !e.ctrlKey && !e.metaKey) {
                    e.preventDefault(); smartBack();
                }
            });
            on('logoutBtn', 'click', () => { localStorage.clear(); location.href = 'student_login.html'; });

            if (rateRange && rateVal) rateRange.addEventListener('input', () => rateVal.textContent = `${(+rateRange.value).toFixed(1)}x`);
            if (pitchRange && pitchVal) pitchRange.addEventListener('input', () => pitchVal.textContent = (+pitchRange.value).toFixed(1));
            loadVoices(); speechSynthesis.onvoiceschanged = loadVoices;

            // โหลดรายการไฟล์
            fetchMaterials();
        });
    </script>

</body>

</html>