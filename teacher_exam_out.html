<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≠‡∏ö</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/main.css">
  <link rel="stylesheet" href="assets/css/teacher.css">
  <link rel="stylesheet" href="assets/css/slot-scheduler.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="icon" href="data:,">
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
  <header>
    <div class="logo-text">
      <img src="nulogo.png" alt="Logo" height="80">
      <div class="course-title">
        <h2 class="text-center">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö</h2>
      </div>
    </div>
    <div class="top-right">
      <button id="backBtn" class="home-btn">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
      <button id="logoutBtn" class="logout-btn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
  </header>

  <main class="teacher-dashboard">
    <div class="time-slots">
      <h2 class="text-center">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≠‡∏ö</h2>
      <div id="errorBox"></div>

      <form id="timeSlotForm" class="time-slot-form">
        <div class="form-group">
          <label for="regOpenAt">‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô:</label>
          <input type="datetime-local" id="regOpenAt" name="reg_open_at" required>
        </div>
        <div class="form-group">
          <label for="regCloseAt">‡∏õ‡∏¥‡∏î‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô:</label>
          <input type="datetime-local" id="regCloseAt" name="reg_close_at" required>
        </div>
        <div class="form-group">
          <label for="examDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ö:</label>
          <input type="date" id="examDate" name="slot_date" required>
        </div>
        <div class="form-group">
          <label for="startTime">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏≠‡∏ö:</label>
          <input type="time" id="startTime" name="start_time" required>
        </div>
        <div class="form-group">
          <label for="endTime">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö:</label>
          <input type="time" id="endTime" name="end_time" required>
        </div>
        <div class="form-group">
          <label for="capacity">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ:</label>
          <input type="number" id="capacity" name="max_seats" min="1" required>
        </div>
        <div class="form-group">
          <label for="examsetTitle">‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö:</label>
          <input type="text" id="examsetTitle" name="examset_title" required>
        </div>
        <div class="form-group">
          <label for="easyCount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏á‡πà‡∏≤‡∏¢:</label>
          <input type="number" id="easyCount" name="easy_count" min="0" required>
        </div>
        <div class="form-group">
          <label for="mediumCount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á:</label>
          <input type="number" id="mediumCount" name="medium_count" min="0" required>
        </div>
        <div class="form-group">
          <label for="hardCount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏¢‡∏≤‡∏Å:</label>
          <input type="number" id="hardCount" name="hard_count" min="0" required>
        </div>
        <div class="form-group">
          <label for="duration">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≠‡∏ö (‡∏ô‡∏≤‡∏ó‡∏µ):</label>
          <input type="number" id="duration" name="duration_minutes" min="1" value="60" required>
        </div>

        <button type="submit" id="submitBtn" class="btn btn-success">
          <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
          ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≠‡∏ö
        </button>
      </form>

      <h2>‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö</h2>
      <table class="slots-table table table-bordered table-striped">
        <thead class="table-light">
          <tr>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ö</th>
            <th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏≠‡∏ö</th>
            <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö</th>
            <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö</th>
            <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th>
            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
          </tr>
        </thead>
        <tbody id="timeSlotsList"></tbody>
      </table>
      <div id="loadingSpinner" style="display:none;text-align:center;margin-top:10px;">
        <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
      </div>
    </div>
  </main>

  <script>
    function formatDateTime(dt) {
      if (!dt) return '-';
      const d = new Date(dt);
      if (isNaN(d)) return '-';
      return d.toLocaleString("th-TH", { dateStyle: "short", timeStyle: "short" });
    }

    function formatThaiDateFull(value) {
      if (!value) return '-';
      const dt = new Date(value);
      if (isNaN(dt)) return '-';
      const months = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô",
        "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
      return `${dt.getDate()} ${months[dt.getMonth()]} ${dt.getFullYear() + 543}`;
    }

    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('teacherToken') || '';
      if (!token) return window.location.href = 'teacher_login.html';

      const timeSlotsList = document.getElementById('timeSlotsList');

      async function loadTimeSlots() {
        document.getElementById('loadingSpinner').style.display = 'block';
        try {
          const res = await fetch('api/get_all_slots.php', { headers: { Authorization: `Bearer ${token}` } });
          const data = await res.json();
          if (!res.ok || data.status !== 'success') throw new Error(data.message || '‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          displayTimeSlots(data.slots || []);
        } catch (e) {
          Swal.fire({ icon: 'error', title: '‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: e.message });
        }
        document.getElementById('loadingSpinner').style.display = 'none';
      }

      function displayTimeSlots(slots) {
        timeSlotsList.innerHTML = '';
        if (!slots.length) {
          timeSlotsList.innerHTML = '<tr><td colspan="9" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≠‡∏ö</td></tr>';
          return;
        }
        slots.forEach(s => {
          const booked = parseInt(s.booked_count) || 0;
          const cap = parseInt(s.max_seats || s.capacity) || 0;
          const isFull = booked >= cap;
          const tr = document.createElement('tr');
          tr.className = isFull ? 'status-full' : 'status-available';
          tr.innerHTML = `
            <td>${s.reg_open_at ? formatDateTime(s.reg_open_at) : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</td>
            <td>${s.reg_close_at ? formatDateTime(s.reg_close_at) : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</td>
            <td>${formatThaiDateFull(s.exam_date)}</td>
            <td>${s.start_time || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</td>
            <td>${s.end_time || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</td>
            <td>${cap || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</td>
            <td>${booked || '0'}</td>
            <td class="${isFull ? 'text-danger' : 'text-success'}">${isFull ? '‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß' : '‡∏ß‡πà‡∏≤‡∏á'}</td>
            <td>${booked == 0 ? `<button class="btn btn-danger btn-sm delete-slot-btn" data-slot-id="${s.id}" onclick="deleteSlot(${s.id})">‡∏•‡∏ö</button>` : `<span class="text-muted">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ</span>`}</td>
          `;
          timeSlotsList.appendChild(tr);
        });
      }

      loadTimeSlots();

      document.getElementById('backBtn').onclick = () => window.location.href = 'teacher_dashboard.html';
      document.getElementById('logoutBtn').onclick = () => {
        localStorage.removeItem('teacherToken');
        window.location.href = 'teacher_login.html';
      };
    });

    async function deleteSlot(slotId) {
      const token = localStorage.getItem('teacherToken') || '';
      if (!token) {
        Swal.fire({ icon: 'error', title: 'Token ‡∏´‡∏≤‡∏¢‡πÑ‡∏õ', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà' });
        return;
      }

      // ‚úÖ Auto-detect API path
      const baseUrl = window.location.origin + window.location.pathname.replace(/\/[^/]+$/, "");
      const apiUrl = baseUrl + "/api/delete_slot.php";

      console.log("üåê Base URL:", baseUrl);
      console.log("üõ∞Ô∏è Fetching API:", apiUrl, "slot_id=", slotId);

      const confirm = await Swal.fire({
        title: '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
        text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: '‡∏•‡∏ö',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
      });

      if (!confirm.isConfirmed) return;

      try {
        const res = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ slot_id: slotId })
        });

        const text = await res.text();
        console.log("ÔøΩ Raw response:", text);

        let data;
        try {
          data = JSON.parse(text);
        } catch {
          throw new Error("‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON: " + text);
        }

        if (res.ok && data.status === 'success') {
          Swal.fire({ icon: 'success', title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1200, showConfirmButton: false });

          // ‚úÖ ‡∏•‡∏ö row ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å DOM ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á reload ‡∏´‡∏ô‡πâ‡∏≤)
          const row = document.querySelector(`button[data-slot-id="${slotId}"]`)?.closest("tr");
          if (row) row.remove();

          // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ slot ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≠‡∏ö"
          const rows = document.querySelectorAll("#timeSlotsList tr");
          if (!rows.length) {
            document.getElementById("timeSlotsList").innerHTML =
              '<tr><td colspan="9" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≠‡∏ö</td></tr>';
          }
        } else {
          throw new Error(data?.message || "‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        }
      } catch (err) {
        console.error("‚ùå Error deleting slot:", err);
        Swal.fire({ icon: 'error', title: '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: err.message });
      }
    }
  </script>

</body>

</html>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.getElementById('timeSlotForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const submitBtn = document.getElementById('submitBtn');
    const spinner = submitBtn.querySelector('.spinner-border');
    spinner.classList.remove('d-none');
    submitBtn.disabled = true;

    const token = localStorage.getItem('teacherToken') || '';
    if (!token) return window.location.href = 'teacher_login.html';

    const formData = new FormData(this);
    const payload = {};
    formData.forEach((value, key) => { payload[key] = value; });

    try {
      const res = await fetch('api/add_slot.php', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (res.ok && data.status === 'success') {
        Swal.fire({ icon: 'success', title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1200, showConfirmButton: false });
        this.reset();
        location.reload();
      } else throw new Error(data.message || '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    } catch (e) {
      document.getElementById('errorBox').innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
    } finally {
      spinner.classList.add('d-none');
      submitBtn.disabled = false;
    }
  });
</script>