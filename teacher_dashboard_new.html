<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>แดชบอร์ดอาจารย์</title>

    <!-- Icons + Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css" rel="stylesheet">

    <!-- Chart.js (สำหรับกราฟ) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="icon" href="favicon.ico">
    <style>
        :root {
            --bg: #f6f8fb;
            --card: #ffffff;
            --text: #1f2937;
            --muted: #6b7280;
            --brand: #2563eb;
            --brand-weak: #dbeafe;
            --ok: #16a34a;
            --warn: #f59e0b;
            --danger: #ef4444;
            --border: #e5e7eb;
            --sidebar: #0f172a;
            /* ไล่เฉดกรมท่า */
            --sidebar-2: #111827;
            --chip: #eef2ff;
            --chip-text: #3730a3;
            --radius: 14px;
            --shadow: 0 10px 30px rgba(2, 6, 23, .06);
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            font-family: "Prompt", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
            color: var(--text);
            background: var(--bg);
        }

        /* ===== Layout ===== */
        .layout {
            display: grid;
            grid-template-columns: 260px 1fr;
            min-height: 100vh;
        }

        .sidebar {
            background: linear-gradient(180deg, var(--sidebar), var(--sidebar-2));
            color: #fff;
            padding: 16px 12px;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow: auto;
        }

        .sidebar .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            margin-bottom: 6px;
        }

        .brand img {
            height: 46px
        }

        .brand .title {
            font-weight: 700;
            font-size: 18px;
            line-height: 1.2
        }

        .collapse-btn {
            display: none;
            position: absolute;
            right: -14px;
            top: 16px;
            background: #fff;
            color: var(--brand);
            border-radius: 999px;
            width: 36px;
            height: 36px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        nav.menu {
            margin-top: 10px
        }

        .menu-section {
            margin-top: 10px;
            margin-bottom: 6px;
            color: #cdd5df;
            font-size: 12px;
            padding: 0 10px
        }

        .menu a {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #dbe6ff;
            text-decoration: none;
            padding: 10px 12px;
            margin: 4px 0;
            border-radius: 10px;
        }

        .menu a:hover {
            background: rgba(255, 255, 255, .06)
        }

        .menu a.active {
            background: rgba(37, 99, 235, .22);
            color: #fff
        }

        .menu i {
            width: 20px;
            text-align: center
        }

        .main {
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            padding: 12px 18px;
            background: var(--card);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .top-left {
            display: flex;
            align-items: center;
            gap: 10px
        }

        .top-right {
            display: flex;
            align-items: center;
            gap: 8px
        }

        .profile-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--chip);
            color: var(--chip-text);
            border: 1px solid #c7d2fe;
            padding: 8px 12px;
            border-radius: 999px;
            cursor: pointer;
        }

        .btn {
            border: 1px solid var(--border);
            background: #fff;
            color: var(--text);
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
        }

        .btn.danger {
            background: var(--danger);
            color: #fff;
            border: none
        }

        .content {
            padding: 18px;
            width: 100%;
            max-width: 1200px;
            margin-inline: auto;
        }

        .cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 14px;
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 14px;
        }

        .kpi {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .kpi .icon {
            width: 38px;
            height: 38px;
            border-radius: 10px;
            display: grid;
            place-items: center;
            color: #fff;
            font-size: 16px;
        }

        .kpi .meta {
            font-size: 12px;
            color: var(--muted)
        }

        .kpi .value {
            font-weight: 700;
            font-size: 20px;
            margin-top: 4px
        }

        .panel {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 14px;
            margin-top: 12px;
        }

        .panel h3 {
            margin: 0 0 10px 0;
            font-size: 18px
        }

        .filters {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 8px
        }

        .filters .control {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 8px 10px;
            min-width: 180px;
        }

        /* ===== Responsive ===== */
        @media (max-width: 1100px) {
            .cards {
                grid-template-columns: repeat(2, 1fr)
            }
        }

        @media (max-width: 860px) {
            .layout {
                grid-template-columns: 70px 1fr
            }

            .sidebar.compact .brand .title {
                display: none
            }

            .sidebar.compact .menu a span {
                display: none
            }

            .sidebar.compact .menu a {
                justify-content: center
            }

            .sidebar .collapse-btn {
                display: block
            }
        }

        @media (max-width: 600px) {
            .cards {
                grid-template-columns: 1fr
            }
        }
    </style>
</head>

<body>
    <div class="layout">
        <!-- ===== Sidebar ===== -->
        <aside class="sidebar" id="sidebar">
            <button class="collapse-btn" id="collapseBtn" aria-label="ยุบ/ขยายเมนู">
                <i class="fa-solid fa-angles-left"></i>
            </button>

            <div class="brand">
                <img src="nulogo.png" alt="NU Logo">
                <div class="title">ระบบจัดการสอบ</div>
            </div>

            <nav class="menu">
                <div class="menu-section">เมนูหลัก</div>
                <a href="teacher_dashboard.html" class="active"><i
                        class="fa-solid fa-house"></i><span>หน้าหลัก</span></a>
                <a href="teacher_question_bank.html"><i class="fa-solid fa-folder-open"></i><span>คลังข้อสอบ</span></a>
                <a href="teacher_exam_sets.html"><i class="fa-solid fa-layer-group"></i><span>จัดชุดข้อสอบ</span></a>
                <a href="exam_users.html"><i class="fa-solid fa-users"></i><span>รายชื่อผู้เข้าสอบ</span></a>

                <div class="menu-section">การวิเคราะห์</div>
                <a href="teacher_analysis_overview.html"><i
                        class="fa-solid fa-chart-simple"></i><span>ภาพรวมผลการเรียนรู้</span></a>
                <a href="teacher_item_stats.html"><i class="fa-solid fa-microscope"></i><span>สถิติข้อสอบ
                        (IRT)</span></a>

                <div class="menu-section">ข้อมูลระบบ</div>
                <a href="teacher_students.html"><i class="fa-solid fa-id-card"></i><span>ข้อมูลนักศึกษา</span></a>
                <a href="teacher_subjects.html"><i class="fa-solid fa-book"></i><span>ข้อมูลรายวิชา</span></a>
                <a href="teacher_categories.html"><i class="fa-solid fa-tags"></i><span>หมวดหมู่/หัวข้อย่อย</span></a>
            </nav>
        </aside>

        <!-- ===== Main ===== -->
        <section class="main">
            <!-- Top bar -->
            <div class="topbar">
                <div class="top-left">
                    <h2 style="margin:0;font-size:18px">แดชบอร์ดอาจารย์</h2>
                </div>
                <div class="top-right">
                    <button class="profile-chip" id="editProfileBtn" title="กดเพื่อแก้ไขโปรไฟล์">
                        <i class="fa-solid fa-user-pen"></i>
                        <span id="teacherName">—</span>
                    </button>
                    <button class="btn danger" id="logoutBtn"><i class="fa-solid fa-right-from-bracket"></i>
                        ออกจากระบบ</button>
                </div>
            </div>

            <!-- Content -->
            <div class="content">
                <!-- KPI Cards -->
                <div class="cards">
                    <div class="card">
                        <div class="kpi">
                            <div class="icon" style="background:#3b82f6"><i class="fa-solid fa-file-lines"></i></div>
                            <div>
                                <div class="meta">จำนวนข้อสอบทั้งหมด</div>
                                <div class="value" id="kpiQuestions">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="kpi">
                            <div class="icon" style="background:#f59e0b"><i class="fa-solid fa-user-check"></i></div>
                            <div>
                                <div class="meta">ข้อสอบนักศึกษา</div>
                                <div class="value" id="kpiStudentItems">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="kpi">
                            <div class="icon" style="background:#ef4444"><i class="fa-solid fa-circle-xmark"></i></div>
                            <div>
                                <div class="meta">ข้อสอบบุคคลทั่วไป</div>
                                <div class="value" id="kpiGuestItems">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="kpi">
                            <div class="icon" style="background:#16a34a"><i class="fa-solid fa-users"></i></div>
                            <div>
                                <div class="meta">จำนวนนิสิตทั้งหมด</div>
                                <div class="value" id="kpiStudents">0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="panel">
                    <h3>ผลลัพธ์การเรียนรู้</h3>
                    <div class="filters">
                        <select class="control" id="termSelect" aria-label="ภาคการศึกษา">
                            <option value="2568/1">2568 / ภาคต้น</option>
                            <option value="2567/2">2567 / ภาคปลาย</option>
                            <option value="2567/1">2567 / ภาคต้น</option>
                        </select>
                        <select class="control" id="examSetSelect" aria-label="ชุดข้อสอบ">
                            <option value="all">ทุกชุดข้อสอบ</option>
                        </select>
                        <button class="btn" id="refreshBtn"><i class="fa-solid fa-rotate-right"></i> โหลดใหม่</button>
                    </div>

                    <!-- Chart -->
                    <canvas id="bloomChart" height="110"></canvas>
                </div>
            </div>
        </section>
    </div>

    <script>
        /* ========= Base path + token ========= */
        const ROOT = location.pathname.includes('/walkin-exam-system/') ? '/walkin-exam-system' : '';
        const API_BASE = `${ROOT}/api/`;
        const teacherToken = localStorage.getItem('teacherToken');

        if (!teacherToken) location.href = 'teacher_login.html';

        /* ========= Sidebar collapse (จดจำสถานะ) ========= */
        const sidebar = document.getElementById('sidebar');
        const collapseBtn = document.getElementById('collapseBtn');
        const SIDEBAR_KEY = 't_sidebar_compact';

        function applySidebarFromStorage() {
            const compact = localStorage.getItem(SIDEBAR_KEY) === '1';
            sidebar.classList.toggle('compact', compact);
            collapseBtn.innerHTML = compact
                ? '<i class="fa-solid fa-angles-right"></i>'
                : '<i class="fa-solid fa-angles-left"></i>';
        }
        applySidebarFromStorage();

        collapseBtn.addEventListener('click', () => {
            const compact = !sidebar.classList.contains('compact');
            localStorage.setItem(SIDEBAR_KEY, compact ? '1' : '0');
            applySidebarFromStorage();
        });

        /* ========= ชื่ออาจารย์บนชิป ========= */
        function parseJwt(tok) {
            try {
                const p = tok.split('.')[1].replace(/-/g, '+').replace(/_/g, '/');
                return JSON.parse(decodeURIComponent(atob(p).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')));
            } catch { return null }
        }
        const payload = parseJwt(teacherToken);
        document.getElementById('teacherName').textContent = payload?.name || 'อาจารย์';

        /* ========= ปุ่มโปรไฟล์/ออกจากระบบ ========= */
        document.getElementById('editProfileBtn').addEventListener('click', () => {
            // เปิด modal/ไปหน้าแก้ไขโปรไฟล์ที่มีอยู่แล้ว
            location.href = 'teacher_profile.html';
        });
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('teacherToken');
            location.href = 'teacher_login.html';
        });

        /* ========= โหลด Overview KPI =========
           คุณสามารถแก้ endpoint ให้ตรงกับระบบจริง เช่น:
           - get_dashboard_overview.php => { total_questions, student_items, guest_items, total_students }
           - get_exam_sets.php          => [{id,title},...]
           - get_bloom_aggregate.php    => {labels:[], values:[]}
        ===================================== */
        async function fetchJSON(url, opts = {}) {
            const res = await fetch(url, {
                headers: { 'Authorization': `Bearer ${teacherToken}`, 'Accept': 'application/json' },
                cache: 'no-store', ...opts
            });
            const raw = await res.text();
            let data; try { data = JSON.parse(raw); } catch { throw new Error('ไม่ใช่ JSON: ' + raw); }
            if (!res.ok || data.status === 'error') throw new Error(data.message || 'HTTP ' + res.status);
            return data;
        }

        async function loadOverview() {
            // ถ้าไม่มี API จริง ๆ สามารถ mock ค่าไว้ก่อนได้
            try {
                const data = await fetchJSON(API_BASE + 'get_dashboard_overview.php');
                const k = data.data || data; // รองรับทั้งสองรูปแบบ
                document.getElementById('kpiQuestions').textContent = k.total_questions ?? 0;
                document.getElementById('kpiStudentItems').textContent = k.student_items ?? 0;
                document.getElementById('kpiGuestItems').textContent = k.guest_items ?? 0;
                document.getElementById('kpiStudents').textContent = k.total_students ?? 0;
            } catch (e) {
                // mock เผื่อยังไม่มี API
                document.getElementById('kpiQuestions').textContent = 139;
                document.getElementById('kpiStudentItems').textContent = 14;
                document.getElementById('kpiGuestItems').textContent = 0;
                document.getElementById('kpiStudents').textContent = 2284;
                console.warn(e.message);
            }
        }

        async function loadExamSets() {
            const sel = document.getElementById('examSetSelect');
            sel.innerHTML = '<option value="all">ทุกชุดข้อสอบ</option>';
            try {
                const data = await fetchJSON(API_BASE + 'get_exam_sets.php');
                (data.data || []).forEach(x => {
                    const op = document.createElement('option');
                    op.value = x.id; op.textContent = x.title || ('ชุด ' + x.id);
                    sel.appendChild(op);
                });
            } catch {
                // mock
                ['A101', 'A201', 'A305'].forEach(id => {
                    const op = document.createElement('option'); op.value = id; op.textContent = 'ชุดข้อสอบ ' + id; sel.appendChild(op);
                });
            }
        }

        /* ========= กราฟ Bloom ========= */
        let bloomChart;
        function renderBloom(labels, values) {
            const ctx = document.getElementById('bloomChart');
            if (bloomChart) bloomChart.destroy();
            bloomChart = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label: 'เปอร์เซ็นต์', data: values }] },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { min: 0, max: 100, ticks: { callback: v => v + '%' } } }
                }
            });
        }

        async function loadBloom() {
            const term = document.getElementById('termSelect').value;
            const setId = document.getElementById('examSetSelect').value;
            try {
                const q = new URLSearchParams({ term, exam_set: setId });
                const data = await fetchJSON(API_BASE + 'get_bloom_aggregate.php?' + q.toString());
                renderBloom(data.labels || [], data.values || []);
            } catch {
                // mock
                renderBloom(['ความจำ', 'ความเข้าใจ', 'การวิเคราะห์', 'ประเมินค่า', 'สังเคราะห์'], [45, 58, 72, 50, 38]);
            }
        }

        document.getElementById('refreshBtn').addEventListener('click', loadBloom);

        /* ========= Boot ========= */
        (async function init() {
            await Promise.all([loadOverview(), loadExamSets()]);
            await loadBloom();
        })();
    </script>
</body>

</html>